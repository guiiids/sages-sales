{# jinja2 #}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RADAR & Groundedness Analysis</title>
    <link rel="icon" type="image/png" href="/static/nav_3.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .rotate-180 {
            transform: rotate(180deg);
        }

        .clamp-3-lines {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .collapsible-preview {
            font-size: 0.65rem;
            color: #374151;
            background-color: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-radius: 0.375rem;
            padding: 0.5rem;
            margin-top: 0.25rem;
        }

        /* Extra-small table styling */
        .table-xs th,
        .table-xs td {
            padding: 0.25rem 0.5rem !important;
            font-size: 0.65rem !important;
        }

        .table-xs thead th {
            font-size: 0.6rem !important;
            font-weight: 600;
        }

        .section-card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            overflow: hidden;
        }

        .section-header {
            padding: 0.5rem 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }

        .section-header h3 {
            font-size: 0.875rem;
            font-weight: 600;
            margin: 0;
        }

        .section-header .count {
            font-size: 0.65rem;
            opacity: 0.8;
        }

        .section-body {
            height: 400px;
            overflow-y: auto;
            overflow-x: auto;
        }

        .score-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.125rem 0.375rem;
            border-radius: 9999px;
            font-size: 0.6rem;
            font-weight: 500;
        }

        .score-pass {
            background-color: #dcfce7;
            color: #166534;
        }

        .score-warn {
            background-color: #fef9c3;
            color: #854d0e;
        }

        .score-fail {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .grounded-yes {
            background-color: #dcfce7;
            color: #166534;
        }

        .grounded-no {
            background-color: #fee2e2;
            color: #991b1b;
        }

        /* Modal improvements */
        .modal-section {
            margin-bottom: 1rem;
        }

        .modal-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .modal-section-content {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            padding: 0.5rem;
            font-size: 0.7rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .dimension-row {
            display: flex;
            align-items: center;
            padding: 0.25rem 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .dimension-row:last-child {
            border-bottom: none;
        }

        .dimension-name {
            flex: 1;
            font-weight: 500;
        }

        .dimension-score {
            min-width: 60px;
            text-align: center;
        }

        .dimension-status {
            min-width: 80px;
            text-align: right;
        }

        .claims-list {
            list-style: disc;
            padding-left: 1.25rem;
            margin: 0;
        }

        .claims-list li {
            margin-bottom: 0.25rem;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto py-4 px-2">
        <!-- Page Title -->
        <div class="text-center mb-4">
            <h1 class="text-lg font-bold text-gray-800">RADAR & Groundedness Checker Analysis</h1>
            <p class="text-xs text-gray-500">Groundedness: {{ groundedness_count }} • RADAR: {{ radar_count }}</p>
            <a href="/rag-queries" class="text-xs text-blue-600 hover:text-blue-800">← Back to RAG Queries</a>
        </div>

        <!-- Grid Layout -->
        <div class="grid grid-cols-1 gap-4">

            <!-- Groundedness Evaluations Section -->
            <div class="section-card">
                <div class="section-header bg-teal-600 text-white" id="groundedness-header"
                    onclick="toggleSection('groundednessCollapsed','groundedness-header','groundedness-chevron','groundedness-section')">
                    <div>
                        <h3>Groundedness Checker Evaluations</h3>
                        <span class="count">groundedness_evaluations • <span id="groundedness-count">{{
                                groundedness_count }}</span>
                            entries</span>
                    </div>
                    <svg id="groundedness-chevron" xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
                <div id="groundedness-section" class="section-body p-2">
                    <!-- Table -->
                    <table class="min-w-full text-left whitespace-nowrap table-xs" id="table-groundedness">
                        <thead class="uppercase tracking-wider sticky top-0 bg-gray-50 border-b">
                            <tr>
                                <th scope="col">ID</th>
                                <th scope="col">Query ID</th>
                                <th scope="col">Timestamp</th>
                                <th scope="col">User Query</th>
                                <th scope="col">Response</th>
                                <th scope="col" class="text-center">Grounded</th>
                                <th scope="col" class="text-right">Score</th>
                                <th scope="col" class="text-right">Confidence</th>
                                <th scope="col">Failure Mode</th>
                                <th scope="col" class="text-right">Citations</th>
                                <th scope="col">Persona</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y">
                            {% for e in groundedness_evaluations %}
                            <tr class="hover:bg-gray-50 data-row">
                                <td class="text-gray-900">{{ e.id }}</td>
                                <td class="text-gray-500 font-mono" title="{{ e.query_id }}">{{e.query_id}}</td>
                                <td class="text-gray-500 font-mono whitespace-nowrap">{{
                                    e.timestamp.strftime('%Y-%m-%d %H:%M') if e.timestamp else '' }}</td>
                                <td class="text-gray-900 max-w-[150px] truncate" title="{{ e.user_query_full }}">{{
                                    e.user_query_display }}</td>
                                <td class="text-gray-900 max-w-[200px] truncate" title="{{ e.answer_full[:500] }}">{{
                                    e.answer_display }}</td>
                                <td class="text-center">
                                    {% if e.grounded %}
                                    <span class="score-badge grounded-yes">✓ Yes</span>
                                    {% else %}
                                    <span class="score-badge grounded-no">✗ No</span>
                                    {% endif %}
                                </td>
                                <td class="text-gray-900 font-mono text-right">{{ "%.2f"|format(e.score|float) }}</td>
                                <td class="text-gray-900 font-mono text-right">{{ "%.2f"|format(e.confidence|float) }}
                                </td>
                                <td class="text-gray-700">
                                    {% if e.failure_mode == 'none' %}
                                    <span class="text-gray-400">-</span>
                                    {% else %}
                                    <span class="text-amber-600">{{ e.failure_mode }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-gray-900 font-mono text-right">{{ e.citation_count }}</td>
                                <td class="text-gray-700">{{ e.persona or '-' }}</td>
                                <td>
                                    <button
                                        class="js-view-groundedness bg-teal-500 hover:bg-teal-600 text-white px-1.5 py-0.5 rounded text-xs"
                                        data-id="{{ e.id }}" data-json='{{ e|tojson|e }}'>View</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    {% if groundedness_evaluations|length == 0 %}
                    <div class="p-4 text-center text-gray-500 text-xs">
                        <p>No groundedness evaluations found.</p>
                        <p class="mt-1 text-gray-400">Groundedness evaluations are logged when using the Scientist
                            persona.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- RADAR Evaluations Section -->
            <div class="section-card">
                <div class="section-header bg-purple-600 text-white" id="radar-header"
                    onclick="toggleSection('radarCollapsed','radar-header','radar-chevron','radar-section')">
                    <div>
                        <h3>RADAR Evaluations</h3>
                        <span class="count">rag_queries.features_json • <span id="radar-count">{{ radar_count }}</span>
                            entries</span>
                    </div>
                    <svg id="radar-chevron" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transition-transform"
                        fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
                <div id="radar-section" class="section-body p-2">
                    <!-- Table -->
                    <table class="min-w-full text-left whitespace-nowrap table-xs" id="table-radar">
                        <thead class="uppercase tracking-wider sticky top-0 bg-gray-50 border-b">
                            <tr>
                                <th scope="col">ID</th>
                                <th scope="col">Query ID</th>
                                <th scope="col">Timestamp</th>
                                <th scope="col">User Query</th>
                                <th scope="col">Response</th>
                                <th scope="col" class="text-center">Corrected</th>
                                <th scope="col" class="text-right">Failing</th>
                                <th scope="col" class="text-right">Tokens</th>
                                <th scope="col" class="text-right">Citations</th>
                                <th scope="col">Persona</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y">
                            {% for e in radar_evaluations %}
                            <tr class="hover:bg-gray-50 data-row">
                                <td class="text-gray-900">{{ e.id }}</td>
                                <td class="text-gray-500 font-mono" title="{{ e.query_id }}">{{ e.query_id }}</td>
                                <td class="text-gray-500 font-mono whitespace-nowrap">{{
                                    e.timestamp.strftime('%Y-%m-%d %H:%M') if e.timestamp else '' }}</td>
                                <td class="text-gray-900 max-w-[150px] truncate" title="{{ e.user_query_full }}">{{
                                    e.user_query_display }}</td>
                                <td class="text-gray-900 max-w-[200px] truncate" title="{{ e.response_full[:500] }}">{{
                                    e.response_display }}</td>
                                <td class="text-center">
                                    {% if e.was_corrected %}
                                    <span class="score-badge score-warn">✓ Yes</span>
                                    {% else %}
                                    <span class="score-badge score-pass">- No</span>
                                    {% endif %}
                                </td>
                                <td class="text-gray-900 font-mono text-right">
                                    {% if e.failing_count > 0 %}
                                    <span class="text-amber-600">{{ e.failing_count }}</span>
                                    {% else %}
                                    <span class="text-green-600">0</span>
                                    {% endif %}
                                </td>
                                <td class="text-gray-900 font-mono text-right">{{ e.total_radar_tokens }}</td>
                                <td class="text-gray-900 font-mono text-right">{{ e.citation_count }}</td>
                                <td class="text-gray-700">{{ e.persona or '-' }}</td>
                                <td>
                                    <button
                                        class="js-view-radar bg-purple-500 hover:bg-purple-600 text-white px-1.5 py-0.5 rounded text-xs"
                                        data-id="{{ e.id }}" data-json='{{ e|tojson|e }}'>View</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    {% if radar_evaluations|length == 0 %}
                    <div class="p-4 text-center text-gray-500 text-xs">
                        <p>No RADAR evaluations found.</p>
                        <p class="mt-1 text-gray-400">RADAR evaluations are stored in rag_queries.features_json when
                            using the Scientist persona with RADAR correction enabled.</p>
                    </div>
                    {% endif %}
                </div>
            </div>


        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detail-modal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="p-4" id="modal-content"></div>
        </div>
    </div>

    <script>
        // Global state for download
        window.currentModalData = null;
        window.currentModalType = null;

        function toggleSection(key, headerId, chevronId, bodyId) {
            const body = document.getElementById(bodyId);
            const chev = document.getElementById(chevronId);
            const collapsed = body.classList.toggle('hidden');
            if (chev) chev.classList.toggle('rotate-180', collapsed);
            localStorage.setItem(key, collapsed ? '1' : '0');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatScore(score, threshold = 0.75) {
            const numScore = parseFloat(score) || 0;
            const pct = (numScore * 100).toFixed(0);
            if (numScore >= threshold) {
                return `<span class="score-badge score-pass">✓ ${pct}%</span>`;
            } else if (numScore >= threshold - 0.15) {
                return `<span class="score-badge score-warn">⚠ ${pct}%</span>`;
            } else {
                return `<span class="score-badge score-fail">✗ ${pct}%</span>`;
            }
        }

        function showGroundednessDetail(data) {
            window.currentModalData = data;
            window.currentModalType = 'groundedness';
            const modal = document.getElementById('detail-modal');
            const content = document.getElementById('modal-content');

            // Parse JSONB fields
            let unsupportedClaims = [];
            let recommendations = [];
            let intentGaps = [];
            let citationAudit = {};
            let policiesApplied = {};

            try {
                unsupportedClaims = typeof data.unsupported_claims === 'string' ? JSON.parse(data.unsupported_claims) : (data.unsupported_claims || []);
            } catch (e) { }
            try {
                recommendations = typeof data.recommendations === 'string' ? JSON.parse(data.recommendations) : (data.recommendations || []);
            } catch (e) { }
            try {
                intentGaps = typeof data.intent_gaps === 'string' ? JSON.parse(data.intent_gaps) : (data.intent_gaps || []);
            } catch (e) { }
            try {
                citationAudit = typeof data.citation_audit === 'string' ? JSON.parse(data.citation_audit) : (data.citation_audit || {});
            } catch (e) { }
            try {
                policiesApplied = typeof data.policies_applied === 'string' ? JSON.parse(data.policies_applied) : (data.policies_applied || {});
            } catch (e) { }

            // Build claims HTML
            let claimsHtml = '<p class="text-gray-400 italic">No unsupported claims found</p>';
            if (unsupportedClaims && unsupportedClaims.length > 0) {
                claimsHtml = '<ul class="claims-list">' +
                    unsupportedClaims.map(c => {
                        if (typeof c === 'object') {
                            return `<li><strong>${escapeHtml(c.claim || c.text || JSON.stringify(c))}</strong>${c.reason ? ': ' + escapeHtml(c.reason) : ''}</li>`;
                        }
                        return `<li>${escapeHtml(c)}</li>`;
                    }).join('') + '</ul>';
            }

            // Build recommendations HTML
            let recsHtml = '<p class="text-gray-400 italic">No recommendations</p>';
            if (recommendations && recommendations.length > 0) {
                recsHtml = '<ul class="claims-list">' +
                    recommendations.map(r => `<li>${escapeHtml(r)}</li>`).join('') + '</ul>';
            }

            // Build intent gaps HTML
            let gapsHtml = '';
            if (intentGaps && intentGaps.length > 0) {
                gapsHtml = `
                    <div class="modal-section">
                        <div class="modal-section-title">Intent Gaps</div>
                        <div class="modal-section-content">
                            <ul class="claims-list">
                                ${intentGaps.map(g => `<li>${escapeHtml(g)}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            }

            content.innerHTML = `
            <div class="relative">
                <div class="absolute top-0 right-0 flex gap-2">
                    <button onclick="downloadEvaluationAsMd()" class="text-blue-600 hover:text-blue-800 text-xs font-semibold px-2 py-1 border border-blue-200 rounded bg-blue-50 hover:bg-blue-100 transition-colors">
                        Download MD
                    </button>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                </div>

                <h2 class="text-lg font-bold text-teal-700 mb-4">Groundedness Evaluation Report</h2>

                <!-- Status Summary -->
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4 p-3 bg-gray-50 rounded-lg">
                    <div class="text-center">
                        <div class="text-xs text-gray-500">Grounded</div>
                        <div class="text-lg font-bold ${data.grounded ? 'text-green-600' : 'text-red-600'}">${data.grounded ? '✓ Yes' : '✗ No'}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-gray-500">Score</div>
                        <div class="text-lg font-bold">${(parseFloat(data.score) * 100).toFixed(0)}%</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-gray-500">Confidence</div>
                        <div class="text-lg font-bold">${(parseFloat(data.confidence) * 100).toFixed(0)}%</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-gray-500">Failure Mode</div>
                        <div class="text-lg font-bold ${data.failure_mode === 'none' ? 'text-green-600' : 'text-amber-600'}">${data.failure_mode || 'none'}</div>
                    </div>
                </div>

                <!-- User Query -->
                <div class="modal-section">
                    <div class="modal-section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-teal-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        User Query
                    </div>
                    <div class="modal-section-content whitespace-pre-wrap">${escapeHtml(data.user_query_full || data.user_query)}</div>
                </div>

                <!-- Response -->
                <div class="modal-section">
                    <div class="modal-section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-teal-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Response Evaluated
                    </div>
                    <div class="modal-section-content whitespace-pre-wrap max-h-64">${escapeHtml(data.answer_full || data.answer)}</div>
                </div>

                <!-- Evaluation Summary -->
                <div class="modal-section">
                    <div class="modal-section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-teal-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                        Evaluation Summary
                    </div>
                    <div class="modal-section-content whitespace-pre-wrap">${escapeHtml(data.evaluation_summary) || '<span class="text-gray-400 italic">No summary available</span>'}</div>
                </div>

                <!-- Unsupported Claims -->
                <div class="modal-section">
                    <div class="modal-section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        Unsupported Claims
                    </div>
                    <div class="modal-section-content">${claimsHtml}</div>
                </div>

                <!-- Recommendations -->
                <div class="modal-section">
                    <div class="modal-section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                        </svg>
                        Recommendations
                    </div>
                    <div class="modal-section-content">${recsHtml}</div>
                </div>

                ${gapsHtml}

                <!-- Metadata -->
                <div class="mt-4 pt-3 border-t grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs text-gray-500">
                    <div>Query ID: <span class="font-mono">${data.query_id || '-'}</span></div>
                    <div>Persona: <span class="font-mono">${data.persona || '-'}</span></div>
                    <div>Latency: <span class="font-mono">${data.latency_ms || 0}ms</span></div>
                    <div>Model: <span class="font-mono">${data.model || '-'}</span></div>
                </div>
            </div>
            `;
            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }

        function closeModal() {
            const modal = document.getElementById('detail-modal');
            modal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }

        // Close modal on backdrop click
        document.getElementById('detail-modal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Attach click handlers for View buttons
        document.addEventListener('DOMContentLoaded', function () {
            // Groundedness View buttons
            document.querySelectorAll('.js-view-groundedness').forEach(btn => {
                btn.addEventListener('click', function () {
                    const data = JSON.parse(this.getAttribute('data-json'));
                    showGroundednessDetail(data);
                });
            });

            // RADAR View buttons
            document.querySelectorAll('.js-view-radar').forEach(btn => {
                btn.addEventListener('click', function () {
                    const data = JSON.parse(this.getAttribute('data-json'));
                    showRadarDetail(data);
                });
            });
        });

        function showRadarDetail(data) {
            window.currentModalData = data;
            window.currentModalType = 'radar';
            const modal = document.getElementById('detail-modal');
            const content = document.getElementById('modal-content');

            // Parse failing dimensions
            let failingDimensions = [];
            try {
                failingDimensions = typeof data.failing_dimensions === 'string'
                    ? JSON.parse(data.failing_dimensions)
                    : (data.failing_dimensions || []);
            } catch (e) { }

            // Parse thresholds
            let thresholds = {};
            try {
                thresholds = typeof data.radar_thresholds === 'string'
                    ? JSON.parse(data.radar_thresholds)
                    : (data.radar_thresholds || {});
            } catch (e) { }

            // Parse scores and reasons
            let radarScores = {};
            let radarReasons = {};
            try {
                radarScores = typeof data.radar_scores === 'string'
                    ? JSON.parse(data.radar_scores)
                    : (data.radar_scores || {});
            } catch (e) { }
            try {
                radarReasons = typeof data.radar_reasons === 'string'
                    ? JSON.parse(data.radar_reasons)
                    : (data.radar_reasons || {});
            } catch (e) { }

            // Build all dimensions HTML with scores
            const dimensionLabels = {
                'query_resolution': 'Query Resolution',
                'factual_accuracy': 'Factual Accuracy',
                'completeness': 'Completeness',
                'clarity': 'Clarity',
                'actionability': 'Actionability',
                'citation_quality': 'Citation Quality'
            };

            let dimensionsHtml = '';
            const allDimensions = Object.keys(dimensionLabels);

            if (Object.keys(radarScores).length > 0) {
                dimensionsHtml = '<div class="space-y-2">' +
                    allDimensions.map(dim => {
                        const score = radarScores[dim];
                        if (score === undefined) return '';

                        const threshold = thresholds[dim] || 0.75;
                        const passed = score >= threshold;
                        const reason = radarReasons[dim] || '';
                        const scorePct = (score * 100).toFixed(0);

                        return `
                            <div class="p-2 rounded ${passed ? 'bg-green-50' : 'bg-red-50'}">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium text-xs">${dimensionLabels[dim] || dim}</span>
                                    <span class="score-badge ${passed ? 'score-pass' : 'score-fail'}">${scorePct}%</span>
                                </div>
                                ${reason ? `<p class="text-xs text-gray-600 mt-1">${escapeHtml(reason)}</p>` : ''}
                            </div>
                        `;
                    }).filter(x => x).join('') + '</div>';
            } else if (failingDimensions && failingDimensions.length > 0) {
                dimensionsHtml = '<div class="space-y-1">' +
                    failingDimensions.map(dim => {
                        const threshold = thresholds[dim] || 0.75;
                        return `
                            <div class="dimension-row">
                                <span class="dimension-name">${dimensionLabels[dim] || dim}</span>
                                <span class="score-badge score-fail">< ${(threshold * 100).toFixed(0)}%</span>
                            </div>
                        `;
                    }).join('') + '</div>';
            } else {
                dimensionsHtml = '<p class="text-gray-400 italic">All dimensions passed</p>';
            }


            // Corrected response section
            let correctedHtml = '';
            if (data.was_corrected && data.corrected_response) {
                correctedHtml = `
                    <div class="modal-section">
                        <div class="modal-section-title">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Corrected Response (User Received)
                        </div>
                        <div class="modal-section-content whitespace-pre-wrap max-h-64">${escapeHtml(data.corrected_response)}</div>
                    </div>
                `;
            }

            // Original draft section
            let originalHtml = '';
            if (data.was_corrected && data.original_draft) {
                originalHtml = `
                    <div class="modal-section">
                        <details class="border border-gray-200 rounded-md">
                            <summary class="modal-section-title cursor-pointer p-2 bg-gray-50 rounded-t-md">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                                Original Draft (Before Correction)
                            </summary>
                            <div class="modal-section-content whitespace-pre-wrap max-h-64 rounded-t-none">${escapeHtml(data.original_draft)}</div>
                        </details>
                    </div>
                `;
            }

            content.innerHTML = `
            <div class="relative">
                <div class="absolute top-0 right-0 flex gap-2">
                    <button onclick="downloadEvaluationAsMd()" class="text-purple-600 hover:text-purple-800 text-xs font-semibold px-2 py-1 border border-purple-200 rounded bg-purple-50 hover:bg-purple-100 transition-colors">
                        Download MD
                    </button>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                </div>

                <h2 class="text-lg font-bold text-purple-700 mb-4">RADAR Evaluation Report</h2>

                <!-- Status Summary -->
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4 p-3 bg-gray-50 rounded-lg">
                    <div class="text-center">
                        <div class="text-xs text-gray-500">Corrected</div>
                        <div class="text-lg font-bold ${data.was_corrected ? 'text-amber-600' : 'text-green-600'}">${data.was_corrected ? '✓ Yes' : '- No'}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-gray-500">Failing Dimensions</div>
                        <div class="text-lg font-bold ${data.failing_count > 0 ? 'text-amber-600' : 'text-green-600'}">${data.failing_count || 0}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-gray-500">Total Tokens</div>
                        <div class="text-lg font-bold">${data.total_radar_tokens || 0}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-gray-500">Citations</div>
                        <div class="text-lg font-bold">${data.citation_count || 0}</div>
                    </div>
                </div>

                <!-- User Query -->
                <div class="modal-section">
                    <div class="modal-section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        User Query
                    </div>
                    <div class="modal-section-content whitespace-pre-wrap">${escapeHtml(data.user_query_full || data.user_query)}</div>
                </div>

                <!-- RADAR Scores -->
                <div class="modal-section">
                    <div class="modal-section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                        RADAR Scores
                    </div>
                    <div class="modal-section-content">${dimensionsHtml}</div>
                </div>

                ${correctedHtml}
                ${originalHtml}

                <!-- Final Response -->
                <div class="modal-section">
                    <div class="modal-section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Final Response
                    </div>
                    <div class="modal-section-content whitespace-pre-wrap max-h-64">${escapeHtml(data.response_full || data.response)}</div>
                </div>

                <!-- Token Breakdown -->
                <div class="modal-section">
                    <div class="modal-section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                        </svg>
                        Token Breakdown
                    </div>
                    <div class="modal-section-content">
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-center">
                            <div>
                                <div class="text-xs text-gray-500">Eval Prompt</div>
                                <div class="font-mono">${data.eval_prompt_tokens || 0}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500">Eval Completion</div>
                                <div class="font-mono">${data.eval_completion_tokens || 0}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500">Correction Prompt</div>
                                <div class="font-mono">${data.correction_prompt_tokens || 0}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500">Correction Completion</div>
                                <div class="font-mono">${data.correction_completion_tokens || 0}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Metadata -->
                <div class="mt-4 pt-3 border-t grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs text-gray-500">
                    <div>Query ID: <span class="font-mono">${data.query_id || '-'}</span></div>
                    <div>Persona: <span class="font-mono">${data.persona || '-'}</span></div>
                    <div>Total Tokens: <span class="font-mono">${data.total_radar_tokens || 0}</span></div>
                    <div>DB ID: <span class="font-mono">${data.id || '-'}</span></div>
                </div>
            </div>
            `;
            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }

        function downloadEvaluationAsMd() {
            const data = window.currentModalData;
            const type = window.currentModalType;
            if (!data) return;

            let content = '';
            let filename = `${type}_eval_${data.id || 'unknown'}.md`;

            if (type === 'groundedness') {
                const scorePct = (parseFloat(data.score) * 100).toFixed(0);
                const confidencePct = (parseFloat(data.confidence) * 100).toFixed(0);
                const status = data.grounded ? '✅ Grounded' : '❌ Not Grounded';

                content = `# Groundedness Evaluation Report

**ID:** ${data.id || '-'}
**Status:** ${status}
**Score:** ${scorePct}%
**Confidence:** ${confidencePct}%
**Failure Mode:** ${data.failure_mode || 'none'}
**Timestamp:** ${data.timestamp || new Date().toISOString()}

## User Query
${data.user_query_full || data.user_query || ''}

## Response Evaluated
${data.answer_full || data.answer || ''}

## Evaluation Summary
${data.evaluation_summary || 'No summary available'}

## Unsupported Claims
`;
                // Parse claims
                let claims = [];
                try {
                    claims = typeof data.unsupported_claims === 'string' ? JSON.parse(data.unsupported_claims) : (data.unsupported_claims || []);
                } catch (e) { }

                if (claims && claims.length > 0) {
                    claims.forEach(c => {
                        if (typeof c === 'object') {
                            content += `- **${c.claim || c.text || JSON.stringify(c)}**: ${c.reason || ''}\n`;
                        } else {
                            content += `- ${c}\n`;
                        }
                    });
                } else {
                    content += '(None)\n';
                }

                content += `\n## Recommendations\n`;
                let recs = [];
                try {
                    recs = typeof data.recommendations === 'string' ? JSON.parse(data.recommendations) : (data.recommendations || []);
                } catch (e) { }

                if (recs && recs.length > 0) {
                    recs.forEach(r => content += `- ${r}\n`);
                } else {
                    content += '(None)\n';
                }

            } else if (type === 'radar') {
                const wasCorrected = data.was_corrected ? '✅ Yes' : '⬜ No';

                content = `# RADAR Evaluation Report

**ID:** ${data.id || '-'}
**Corrected:** ${wasCorrected}
**Failing Dimensions:** ${data.failing_count || 0}
**Total Tokens:** ${data.total_radar_tokens || 0}
**Timestamp:** ${data.timestamp || new Date().toISOString()}

## User Query
${data.user_query_full || data.user_query || ''}

## RADAR Scores
`;
                // Parse scores and reasons
                let scores = {};
                let reasons = {};
                try { scores = typeof data.radar_scores === 'string' ? JSON.parse(data.radar_scores) : (data.radar_scores || {}); } catch (e) { }
                try { reasons = typeof data.radar_reasons === 'string' ? JSON.parse(data.radar_reasons) : (data.radar_reasons || {}); } catch (e) { }

                if (Object.keys(scores).length > 0) {
                    for (const [dim, score] of Object.entries(scores)) {
                        const scorePct = (score * 100).toFixed(0);
                        const reason = reasons[dim] || '';
                        content += `- **${dim}**: ${scorePct}%${reason ? ` - ${reason}` : ''}\n`;
                    }
                } else {
                    content += 'No dimension scores available.\n';
                }

                if (data.was_corrected) {
                    content += `\n## Corrected Response (User Received)\n${data.corrected_response || ''}\n`;
                    content += `\n## Original Draft\n${data.original_draft || ''}\n`;
                } else {
                    content += `\n## Final Response\n${data.response_full || data.response || ''}\n`;
                }
            }

            // Trigger download
            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }


    </script>
</body>

</html>