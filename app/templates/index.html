<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SAGE Knowledge Navigator</title>
    <link rel="icon" type="image/png" href="/static/nav_3.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
      };
    </script>
    <!-- Apply dark class IMMEDIATELY to prevent white flash -->
    <script>
      (function () {
        var saved = localStorage.getItem("theme");
        if (
          saved === "dark" ||
          (!saved && window.matchMedia("(prefers-color-scheme: dark)").matches)
        ) {
          document.documentElement.classList.add("dark");
        }
      })();
    </script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Phosphor Icons (for ph-* icon classes) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
      /* Phosphor icons global sizing */
      [class^="ph-"],
      [class*=" ph-"] {
        font-size: 14px;
      }
    </style>
    <script src="{{ marked_js_cdn }}" defer></script>
    <script>
      // Ensure marked is available globally
      document.addEventListener("DOMContentLoaded", function () {
        if (typeof marked === "undefined") {
          console.error("marked library not loaded, loading from CDN");
          const script = document.createElement("script");
          script.src = "https://cdn.jsdelivr.net/npm/marked/marked.min.js";
          script.onload = function () {
            console.log("marked library loaded successfully");
            // Configure marked.js
            marked.setOptions({
              gfm: true, // GitHub Flavored Markdown
              breaks: true, // Convert to br
              sanitize: false, // Don't sanitize HTML (we handle this elsewhere)
              smartLists: true, // Use smarter list behavior
              smartypants: true, // Use "smart" typographic punctuation
            });
          };
          document.head.appendChild(script);
        } else {
          console.log("marked library already loaded");
          // Configure marked.js
          marked.setOptions({
            gfm: true, // GitHub Flavored Markdown
            breaks: true, // Convert to br
            sanitize: false, // Don't sanitize HTML (we handle this elsewhere)
            smartLists: true, // Use smarter list behavior
            smartypants: true, // Use "smart" typographic punctuation
          });
        }
      });
    </script>
    <script src="/static/js/smart-scroll.js"></script>
    <script src="/static/js/marked-renderer.js"></script>
    <style id="custom-styles">
      .avatar {
        width: 48px;
        height: 48px;
        object-fit: cover;
        border-radius: 50%;
      }

      /*  p, li, a {
      font-size: 14px !important;
    } */
      body,
      html {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        overflow-x: hidden;
        max-width: 100vw;
      }

      .chat-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      .chat-messages {
        flex-grow: 1;
        overflow-y: auto;
        overflow-x: hidden;
        /* Increased bottom padding to prevent overlap with fixed search box + disclaimer */
        padding: 1rem 1rem 240px 1rem;
        background-color: white;
        max-width: 100vw;
        box-sizing: border-box;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }

      .dark .chat-messages {
        background-color: #000000;
      }

      .chat-input {
        padding: 1rem;
        background-color: white;
      }

      .dark .chat-input {
        background-color: #000000;
      }

      .user-message {
        display: flex;
        justify-content: flex-end;
        flex-direction: row-reverse;
        /* Increased spacing between messages as requested */
        margin-bottom: 2.5rem;
        width: 100%;
      }

      .bot-message {
        display: flex;
        justify-content: flex-start;
        align-items: flex-start;
        /* Increased spacing between messages as requested */
        margin-bottom: 2.5rem;
        width: 100%;
      }

      .message-bubble {
        display: inline-block;
        width: auto;
        padding: 0.75rem 1rem;
        border-radius: 1rem;
      }

      .user-bubble {
        border-bottom-right-radius: 0.25rem;
        margin-left: 1rem;
        align-self: flex-end;
      }

      .bot-bubble {
        background-color: #ffffff;
        color: black;
        border-bottom-left-radius: 0.25rem;
      }

      .dark .bot-bubble {
        background-color: #1f2937;
        color: #e5e7eb;
      }

      /* Dark mode: user bubble */
      .dark .user-bubble {
        background-color: #374151 !important;
        color: #e5e7eb;
      }

      /* Dark mode: sources header */
      .dark .sources-header,
      .dark summary {
        color: #9ca3af;
      }

      /* Dark mode: fieldset borders in feedback */
      .dark fieldset {
        border-color: #4b5563 !important;
      }

      /* Dark mode: links in bot bubbles */
      .dark .bot-bubble a {
        color: #60a5fa;
      }

      .bot-bubble ul {
        list-style-type: disc;
        padding-left: 1.5rem;
      }

      /* Hide empty list items */
      .bot-bubble ul li:empty,
      .bot-bubble ol li:empty {
        display: none;
      }

      .bot-bubble ol {
        list-style-type: decimal;
        padding-left: 1.5rem;
      }

      .bot-bubble ol li,
      .bot-bubble ul li {
        margin-top: 1rem;
        line-height: 1.75;
      }

      /* Keep sources list compact */
      .sources-section li {
        line-height: 1.5 !important;
      }

      .bot-bubble a {
        text-decoration: underline;
        cursor: pointer;
      }

      .avatar {
        width: 2rem;
        height: 2rem;
        border-radius: 50%;
        margin: 0 0.5rem;
      }

      .typing-indicator {
        display: inline-block;
        padding: 0.75rem 1rem;
        background-color: #d1d1d1;
        border-radius: 1rem;
        border-bottom-left-radius: 0.25rem;
        margin-bottom: 1rem;
      }

      .typing-indicator span {
        display: inline-block;
        width: 0.2rem;
        height: 0.2rem;
        background-color: #6a7380;
        border-radius: 50%;
        margin-right: 0.25rem;
        animation: typing 1.4s infinite both;
      }

      .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
        margin-right: 0;
      }

      @keyframes typing {
        0% {
          transform: translateY(0);
        }

        50% {
          transform: translateY(-0.5rem);
        }

        100% {
          transform: translateY(0);
        }
      }

      /* Added to ensure hidden class works as expected */
      .hidden {
        display: none !important;
      }

      /* Styles for mode buttons */
      .mode-button {
        transition: all 0.3s ease;
      }

      .mode-button.active {
        transform: scale(1.05);
      }

      /* Emergency disable button */
      #emergency-disable-unified-dev-eval {
        display: none;
      }

      /* Feedback system styles */
      .feedback-container {
        display: inline-flex;
        align-items: center;
        margin-left: 8px;
      }

      .feedback-thumb {
        transition: color 0.2s ease;
      }

      .feedback-thumb:hover {
        transform: scale(1.1);
      }

      .feedback-submit-btn {
        transition: background-color 0.2s ease;
      }

      .feedback-submit-btn:hover {
        background-color: #2563eb !important;
      }

      /* ============================================
       TESLA DARK THEME - Search Box Styles
       ============================================ */

      /* Textarea placeholder color */
      #query-input::placeholder {
        color: #6a6a6a;
      }

      /* Container hover and focus states */
      #chat-input-container:hover {
        border-color: #3a3a3a !important;
        box-shadow: 0 6px 32px rgba(0, 0, 0, 0.7) !important;
      }

      #chat-input-container:focus-within {
        border-color: #3e6ae1 !important;
        box-shadow: 0 0 0 2px rgba(62, 106, 225, 0.2) !important;
      }

      /* Wand button hover states */
      #magic-btn-legacy:hover,
      #magic-btn-2xl-legacy:hover {
        background: #2f2f2f !important;
        color: #d0d0d0 !important;
        border-color: #3a3a3a !important;
      }

      /* Voice/Mic button hover state */
      #voice-btn:hover {
        background: #2f5bd1 !important;
      }

      /* Send button hover state handled above with higher specificity */

      /* ============================================
       MOBILE CHAT INPUT REDESIGN
       ============================================ */

      /* Comfortable line-height for sources list */
      .sources-section ol {
        line-height: 1.5;
      }

      /* Mobile: Hide desktop wand buttons, show + button */
      @media (max-width: 768px) {
        /* Truncate source links to prevent overflow */
        .sources-section ol li a {
          display: block;
          max-width: 100%;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
        }

        /* Mobile: Constrain feedback container to screen width */
        .feedback-container {
          display: flex !important;
          flex-direction: column !important;
          align-items: flex-start !important;
          width: 100% !important;
          max-width: calc(100vw - 80px) !important;
          margin-left: 0 !important;
          box-sizing: border-box !important;
        }

        .feedback-container .feedback-icons {
          flex-wrap: wrap;
        }

        .feedback-container .feedback-details {
          width: 100% !important;
          max-width: 100% !important;
          box-sizing: border-box !important;
        }

        .feedback-container .feedback-details fieldset {
          width: 100% !important;
          max-width: 100% !important;
          box-sizing: border-box !important;
        }

        .feedback-container .reasons-container {
          display: flex !important;
          flex-wrap: wrap !important;
          gap: 4px !important;
          grid-template-columns: repeat(2, 1fr) !important;
        }

        .feedback-container .reasons-container label {
          flex: 0 0 auto !important;
          white-space: nowrap !important;
          font-size: 11px !important;
        }

        .feedback-container .feedback-comment {
          width: 100% !important;
          max-width: 100% !important;
          box-sizing: border-box !important;
        }

        /* Hide individual wand buttons on mobile */
        .wand-btn-desktop {
          display: none !important;
        }

        /* Show plus trigger button on mobile */
        .wand-plus-trigger {
          display: flex !important;
        }

        /* Make send button circular with icon only */
        #submit-btn {
          width: 44px;
          height: 44px;
          padding: 0;
          border-radius: 50%;
          font-size: 0;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        #submit-btn::before {
          content: "\f062";
          font-family: "Font Awesome 6 Free";
          font-weight: 900;
          font-size: 16px;
          color: white;
        }

        /* Dark mode send icon */
        .dark #submit-btn::before {
          color: #191919;
        }

        /* Textarea: 2 rows on mobile for better context */
        #query-input {
          min-height: 52px !important;
          line-height: 1.5;
        }

        /* ── Fix 4: Clamp all message content to viewport ── */
        .bot-bubble,
        .user-bubble,
        .message-bubble {
          max-width: calc(100vw - 2rem) !important;
          overflow-x: hidden !important;
          word-wrap: break-word !important;
          overflow-wrap: break-word !important;
          box-sizing: border-box !important;
        }

        /* Clamp pre/code blocks inside bot responses */
        .bot-bubble pre,
        .bot-bubble code {
          max-width: 100% !important;
          white-space: pre-wrap !important;
          word-break: break-all !important;
          overflow-x: auto !important;
        }

        /* Clamp tables inside bot responses */
        .bot-bubble table {
          display: block;
          max-width: 100% !important;
          overflow-x: auto !important;
        }
      }

      /* Desktop: Show wand buttons, hide + button */
      @media (min-width: 769px) {
        .wand-btn-desktop {
          display: inline-flex !important;
        }

        .wand-plus-trigger {
          display: none !important;
        }
      }

      /* Plus button trigger for mobile */
      .wand-plus-trigger {
        display: none;
        width: 36px;
        height: 36px;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: linear-gradient(135deg, #e5e7eb, #f3f4f6);
        border: 1px solid #d1d5db;
        color: #374151;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
      }

      .wand-plus-trigger:hover {
        background: linear-gradient(135deg, #d1d5db, #e5e7eb);
        transform: scale(1.05);
      }

      .wand-plus-trigger.active {
        background: linear-gradient(135deg, #3b82f6, #60a5fa);
        color: white;
        border-color: #3b82f6;
      }

      /* Dark mode plus button */
      .dark .wand-plus-trigger {
        background: linear-gradient(135deg, #374151, #4b5563);
        border-color: #4b5563;
        color: #e5e7eb;
      }

      .dark .wand-plus-trigger:hover {
        background: linear-gradient(135deg, #4b5563, #6b7280);
      }

      /* Floating popup for wand options */
      .wand-popup {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        margin-bottom: 12px;
        display: none;
        flex-direction: column;
        gap: 8px;
        padding: 12px;
        background: white;
        border-radius: 16px;
        box-shadow:
          0 10px 40px rgba(0, 0, 0, 0.15),
          0 4px 12px rgba(0, 0, 0, 0.1);
        z-index: 100;
        min-width: 48px;
        animation: popupSlideUp 0.2s ease-out;
      }

      @keyframes popupSlideUp {
        from {
          opacity: 0;
          transform: translateX(-50%) translateY(10px);
        }

        to {
          opacity: 1;
          transform: translateX(-50%) translateY(0);
        }
      }

      .wand-popup.show {
        display: flex;
      }

      /* Dark mode popup */
      .dark .wand-popup {
        background: #1f2937;
        box-shadow:
          0 10px 40px rgba(0, 0, 0, 0.4),
          0 4px 12px rgba(0, 0, 0, 0.3);
      }

      /* Popup arrow */
      .wand-popup::after {
        content: "";
        position: absolute;
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%);
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-top: 8px solid white;
      }

      .dark .wand-popup::after {
        border-top-color: #1f2937;
      }

      /* Wand option buttons in popup */
      .wand-popup-btn {
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: #f3f4f6;
        border: none;
        color: #374151;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .wand-popup-btn:hover {
        background: #e5e7eb;
        transform: scale(1.1);
      }

      .wand-popup-btn:active {
        transform: scale(0.95);
      }

      /* Dark mode popup buttons */
      .dark .wand-popup-btn {
        background: #374151;
        color: #e5e7eb;
      }

      .dark .wand-popup-btn:hover {
        background: #4b5563;
      }

      /* Tooltip for popup buttons */
      .wand-popup-btn-wrapper {
        position: relative;
      }

      .wand-popup-btn-tooltip {
        position: absolute;
        right: calc(100% + 10px);
        top: 50%;
        transform: translateY(-50%);
        padding: 6px 10px;
        background: #1f2937;
        color: white;
        font-size: 11px;
        border-radius: 6px;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.15s ease;
      }

      .wand-popup-btn-wrapper:hover .wand-popup-btn-tooltip {
        opacity: 1;
      }

      /* ============================================
       MOBILE ACTION FEEDBACK INDICATORS
       ============================================ */

      /* Plus button active states with pulsing indicator */
      .wand-plus-trigger.recording {
        background: linear-gradient(135deg, #ef4444, #f87171) !important;
        color: white !important;
        border-color: #ef4444 !important;
        animation: pulse-recording 1.5s ease-in-out infinite;
      }

      .wand-plus-trigger.processing {
        background: linear-gradient(135deg, #8b5cf6, #a78bfa) !important;
        color: white !important;
        border-color: #8b5cf6 !important;
        animation: pulse-processing 1s ease-in-out infinite;
      }

      .wand-plus-trigger.enhancing {
        background: linear-gradient(135deg, #3b82f6, #60a5fa) !important;
        color: white !important;
        border-color: #3b82f6 !important;
        animation: pulse-processing 1s ease-in-out infinite;
      }

      @keyframes pulse-recording {
        0%,
        100% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
        }

        50% {
          transform: scale(1.05);
          box-shadow: 0 0 0 8px rgba(239, 68, 68, 0);
        }
      }

      @keyframes pulse-processing {
        0%,
        100% {
          transform: scale(1);
          opacity: 1;
        }

        50% {
          transform: scale(1.03);
          opacity: 0.85;
        }
      }

      /* Input container glow states */
      .chat-input-container.recording {
        border-color: #ef4444 !important;
        box-shadow:
          0 0 0 3px rgba(239, 68, 68, 0.2),
          0 4px 12px rgba(239, 68, 68, 0.15) !important;
      }

      .chat-input-container.processing {
        border-color: #8b5cf6 !important;
        box-shadow:
          0 0 0 3px rgba(139, 92, 246, 0.2),
          0 4px 12px rgba(139, 92, 246, 0.15) !important;
      }

      .chat-input-container.enhancing {
        border-color: #3b82f6 !important;
        box-shadow:
          0 0 0 3px rgba(59, 130, 246, 0.2),
          0 4px 12px rgba(59, 130, 246, 0.15) !important;
      }

      /* Status indicator text */
      .mobile-status-indicator {
        display: none;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 6px 12px;
        font-size: 12px;
        font-weight: 500;
        border-radius: 20px;
        margin: 8px auto 0 auto;
        animation: fadeInUp 0.2s ease-out;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(5px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .mobile-status-indicator.show {
        display: inline-flex;
      }

      .mobile-status-indicator.recording {
        background: rgba(239, 68, 68, 0.1);
        color: #dc2626;
        border: 1px solid rgba(239, 68, 68, 0.3);
      }

      .mobile-status-indicator.processing {
        background: rgba(139, 92, 246, 0.1);
        color: #7c3aed;
        border: 1px solid rgba(139, 92, 246, 0.3);
      }

      .mobile-status-indicator.enhancing {
        background: rgba(59, 130, 246, 0.1);
        color: #2563eb;
        border: 1px solid rgba(59, 130, 246, 0.3);
      }

      .mobile-status-indicator.success {
        background: rgba(34, 197, 94, 0.1);
        color: #16a34a;
        border: 1px solid rgba(34, 197, 94, 0.3);
      }

      /* Spinning icon for processing */
      .mobile-status-indicator .fa-spinner {
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }

        to {
          transform: rotate(360deg);
        }
      }

      /* Flicker animation for verification in progress */
      @keyframes flicker {
        0%,
        100% {
          opacity: 1;
        }

        50% {
          opacity: 0.4;
        }
      }

      /* Status Shield Styles */
      .status-shield {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s ease;
        z-index: 10;
      }

      .status-shield svg {
        width: 24px;
        height: 24px;
      }

      /* Amber flickering - verifying */
      .status-shield.verifying {
        animation: flicker 1.2s ease-in-out infinite;
      }

      .status-shield.verifying svg {
        color: #f59e0b;
        fill: none;
        stroke: currentColor;
      }

      /* Yellow spinning - refining */
      .status-shield.refining svg {
        animation: spin 1s linear infinite;
        color: #eab308;
      }

      /* Green check - passed without rewrite */
      .status-shield.passed svg {
        color: #22c55e;
        fill: currentColor;
      }

      /* Yellow check - passed after rewrite */
      .status-shield.refined svg {
        color: #eab308;
        fill: currentColor;
      }

      /* Red exclamation - failed */
      .status-shield.failed svg {
        color: #ef4444;
        fill: currentColor;
      }

      /* Hide shield by default for non-scientist personas */
      .status-shield.hidden {
        display: none;
      }

      /* ============================================
       TOP MODE PILL BAR (Sliding Indicator)
       ============================================ */
      .top-mode-pill {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 5px;
        border-radius: 999px;
        background: #f3f4f6;
        border: 1px solid rgba(0, 0, 0, 0.06);
        width: fit-content;
        margin: 0 auto 1rem auto;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
        position: sticky;
        top: 0;
        z-index: 50;
        --slide-x: 0px;
      }

      /* ============================================
       PERSONA BADGE on Bot Messages
       ============================================ */
      .persona-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 10px;
        font-weight: 700;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        margin-left: 8px;
        vertical-align: middle;
        line-height: 1.6;
      }

      .persona-badge.persona-explorer {
        background: rgba(107, 114, 128, 0.12);
        color: #6b7280;
      }

      .dark .persona-badge.persona-explorer {
        background: rgba(156, 163, 175, 0.18);
        color: #9ca3af;
      }

      .persona-badge.persona-intermediate {
        background: rgba(124, 58, 237, 0.1);
        color: #7c3aed;
      }

      .dark .persona-badge.persona-intermediate {
        background: rgba(167, 139, 250, 0.18);
        color: #a78bfa;
      }

      .persona-badge.persona-scientist {
        background: rgba(37, 99, 235, 0.1);
        color: #2563eb;
      }

      .dark .persona-badge.persona-scientist {
        background: rgba(96, 165, 250, 0.18);
        color: #60a5fa;
      }

      .persona-badge.persona-balanced_plus {
        background: rgba(14, 165, 233, 0.1);
        color: #0ea5e9;
      }

      .dark .persona-badge.persona-balanced_plus {
        background: rgba(56, 189, 248, 0.18);
        color: #38bdf8;
      }

      /* Status Badges (Draft/Verified) */
      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 3px;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 10px;
        font-weight: 700;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        margin-left: 6px;
        vertical-align: middle;
        line-height: 1.6;
        transition: all 0.2s ease;
      }

      .status-badge.status-draft {
        background: rgba(245, 158, 11, 0.1);
        color: #d97706;
        border: 1px solid rgba(245, 158, 11, 0.2);
      }

      .dark .status-badge.status-draft {
        background: rgba(251, 191, 36, 0.1);
        color: #fbbf24;
        border: 1px solid rgba(251, 191, 36, 0.2);
      }

      .status-badge.status-verified {
        background: rgba(250, 245, 255, 0.2);
        color: rgb(147 51 234);
        border: 1px solid rgb(122 52 252 / 20%);
      }

      .dark .status-badge.status-verified {
        background: rgba(96, 165, 250, 0.1);
        color: #60a5fa;
        border: 1px solid rgba(96, 165, 250, 0.2);
      }

      /* ============================================
       VERIFYING-IN-PROGRESS Indicator
       ============================================ */
      .verifying-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 14px;
        margin-top: 12px;
        border-radius: 10px;
        background: rgba(37, 99, 235, 0.06);
        border: 1px solid rgba(37, 99, 235, 0.12);
        font-size: 13px;
        font-weight: 500;
        color: #2563eb;
        animation: verifyFadeIn 0.3s ease-out;
      }

      .dark .verifying-indicator {
        background: rgba(96, 165, 250, 0.08);
        border-color: rgba(96, 165, 250, 0.15);
        color: #60a5fa;
      }

      @keyframes verifyFadeIn {
        from {
          opacity: 0;
          transform: translateY(4px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .verifying-dots {
        display: inline-flex;
        gap: 3px;
        align-items: center;
      }

      .verifying-dots span {
        width: 5px;
        height: 5px;
        border-radius: 50%;
        background: currentColor;
        animation: verifyPulse 1.4s ease-in-out infinite;
      }

      .verifying-dots span:nth-child(2) {
        animation-delay: 0.2s;
      }

      .verifying-dots span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes verifyPulse {
        0%,
        80%,
        100% {
          opacity: 0.25;
          transform: scale(0.8);
        }

        40% {
          opacity: 1;
          transform: scale(1.1);
        }
      }

      .dark .top-mode-pill {
        background: rgba(55, 65, 81, 0.6);
        border-color: rgba(255, 255, 255, 0.08);
      }

      .top-mode-pill.hidden {
        display: none !important;
      }

      /* Sliding indicator */
      .top-mode-pill-slider {
        position: absolute;
        top: 5px;
        left: 5px;
        width: 64px;
        height: 32px;
        border-radius: 999px;
        background: linear-gradient(135deg, #012258, #60a5fa) !important;
        box-shadow: 0 2px 8px rgba(124, 58, 237, 0.35);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        transform: translateX(var(--slide-x));
        z-index: 0;
        pointer-events: none;
      }

      .top-mode-btn {
        width: 64px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 999px;
        border: none;
        background: transparent;
        color: #9ca3af;
        font-size: 18px;
        cursor: pointer;
        transition: color 0.25s ease;
        position: relative;
        z-index: 1;
      }

      .top-mode-btn:hover {
        color: #6b7280;
      }

      .dark .top-mode-btn:hover {
        color: #d1d5db;
      }

      .top-mode-btn.active {
        color: white;
      }

      /* Flask toggle button in pill bar */
      .top-flask-toggle {
        border-right: 1px solid rgba(0, 0, 0, 0.08);
        margin-right: 2px;
        position: relative;
        overflow: visible;
      }

      /* Rotating neon glow border when flask is INACTIVE */
      .top-flask-toggle:not(.active)::before {
        content: "";
        position: absolute;
        inset: -2px;
        border-radius: 999px;
        padding: 2px;
        background: conic-gradient(
          from var(--flask-glow-angle, 0deg),
          transparent 0%,
          #3e6ae1 10%,
          #60a5fa 20%,
          transparent 40%,
          transparent 100%
        );
        -webkit-mask:
          linear-gradient(#fff 0 0) content-box,
          linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor;
        mask:
          linear-gradient(#fff 0 0) content-box,
          linear-gradient(#fff 0 0);
        mask-composite: exclude;
        animation: flaskGlowSpin 2.5s linear infinite;
        pointer-events: none;
        z-index: 2;
      }

      @property --flask-glow-angle {
        syntax: "<angle>";
        initial-value: 0deg;
        inherits: false;
      }

      @keyframes flaskGlowSpin {
        to {
          --flask-glow-angle: 360deg;
        }
      }

      .dark .top-flask-toggle {
        border-right-color: rgba(255, 255, 255, 0.1);
      }

      .top-flask-toggle.active {
        color: #3e6ae1;
        filter: drop-shadow(0 0 4px rgba(62, 106, 225, 0.4));
      }

      /* No glow when active */
      .top-flask-toggle.active::before {
        display: none;
      }

      /* Disabled / greyed-out mode buttons when flask is OFF */
      .top-mode-btn.modes-disabled {
        color: #c0c4cc;
        opacity: 0.45;
        cursor: default;
      }

      .dark .top-mode-btn.modes-disabled {
        color: #4b5563;
        opacity: 0.4;
      }

      /* Hide slider when modes are disabled */
      .top-mode-pill.flask-off .top-mode-pill-slider {
        opacity: 0;
        pointer-events: none;
      }

      /* Dark mode status indicators */
      .dark .mobile-status-indicator.recording {
        background: rgba(239, 68, 68, 0.15);
        color: #f87171;
      }

      .dark .mobile-status-indicator.processing {
        background: rgba(139, 92, 246, 0.15);
        color: #a78bfa;
      }

      .dark .mobile-status-indicator.enhancing {
        background: rgba(59, 130, 246, 0.15);
        color: #60a5fa;
      }

      .dark .mobile-status-indicator.success {
        background: rgba(34, 197, 94, 0.15);
        color: #4ade80;
      }

      /* Desktop Processing Status Indicator */
      .desktop-status {
        display: none;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 8px 16px;
        font-size: 13px;
        font-weight: 500;
        border-radius: 20px;
        margin: 0 auto 12px auto;
        animation: fadeInUp 0.2s ease-out;
      }

      .desktop-status.show {
        display: inline-flex;
      }

      .desktop-status.recording {
        background: rgba(239, 68, 68, 0.15);
        color: #dc2626;
        border: 1px solid rgba(239, 68, 68, 0.4);
      }

      .desktop-status.processing {
        background: rgba(139, 92, 246, 0.15);
        color: #7c3aed;
        border: 1px solid rgba(139, 92, 246, 0.4);
      }

      .desktop-status.enhancing {
        background: rgba(59, 130, 246, 0.15);
        color: #2563eb;
        border: 1px solid rgba(59, 130, 246, 0.4);
      }

      .desktop-status.querying {
        background: rgba(14, 165, 233, 0.15);
        color: #0284c7;
        border: 1px solid rgba(14, 165, 233, 0.4);
      }

      .desktop-status.success {
        background: rgba(34, 197, 94, 0.15);
        color: #16a34a;
        border: 1px solid rgba(34, 197, 94, 0.4);
      }

      /* Dark mode desktop status */
      .dark .desktop-status.recording {
        background: rgba(239, 68, 68, 0.2);
        color: #f87171;
      }

      .dark .desktop-status.processing {
        background: rgba(139, 92, 246, 0.2);
        color: #a78bfa;
      }

      .dark .desktop-status.enhancing {
        background: rgba(59, 130, 246, 0.2);
        color: #60a5fa;
      }

      .dark .desktop-status.querying {
        background: rgba(14, 165, 233, 0.2);
        color: #38bdf8;
      }

      .dark .desktop-status.success {
        background: rgba(34, 197, 94, 0.2);
        color: #4ade80;
      }

      /* ============================================
       NARROW VIEWPORT / SIDEBAR MODE RESPONSIVENESS
       Applies mobile-like layout for narrow widths (browser sidebar, side app, etc.)
       ============================================ */

      /* ============================================
       FLUID LOGO SIZING - Works at all viewport widths
       ============================================ */

      /* Center logo: fluid sizing based on viewport width */
      #random-logo {
        /* Use clamp for smooth scaling: min 100px, preferred 40vw, max 320px */
        width: clamp(100px, 50vw, 320px) !important;
        height: auto !important;
        max-height: 45vh !important;
        object-fit: contain !important;
      }

      #center-logo {
        min-height: clamp(25vh, 40vh, 50vh) !important;
        padding: clamp(0.5rem, 2vw, 1.5rem) !important;
      }

      /* Narrow viewport: Full-width container and scaled layout */
      @media (max-width: 480px) {
        /* Force full-width container in narrow viewports */
        .chat-container {
          width: 100% !important;
          max-width: 100% !important;
          margin: 0 !important;
          padding: 0 !important;
        }

        /* Nav logo scaling for narrow width */
        #nav-logo {
          max-height: 1.25rem !important;
        }

        /* Chat input wrapper: remove padding on mobile to allow full width */
        .chat-input {
          padding: 0.5rem !important;
        }

        /* Chat input container: reduce padding */
        .chat-input-container {
          margin-left: 0.25rem !important;
          margin-right: 0.25rem !important;
          padding: 0.75rem !important;
          border-radius: 1.5rem !important;
        }

        /* Textarea: compact for narrow width */
        #query-input {
          font-size: 14px !important;
          min-height: 36px !important;
        }

        /* Header: compact padding */
        .chat-container > div:first-child {
          padding: 0.5rem 0.75rem !important;
        }

        /* Messages area: reduce padding but keep bottom clearance */
        .chat-messages {
          padding: 0.5rem 0.5rem 120px 0.5rem !important;
        }

        /* Message bubbles: full width */
        .message-bubble {
          max-width: 95% !important;
        }

        /* Hide desktop wand buttons, show plus button at narrow widths */
        .wand-btn-desktop {
          display: none !important;
        }

        .wand-plus-trigger {
          display: flex !important;
        }

        /* Make send button smaller/circular */
        #submit-btn {
          width: 40px !important;
          height: 40px !important;
          padding: 0 !important;
          border-radius: 50% !important;
          font-size: 0 !important;
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
        }

        #submit-btn::before {
          content: "\f062" !important;
          font-family: "Font Awesome 6 Free" !important;
          font-weight: 900 !important;
          font-size: 14px !important;
          color: white !important;
        }

        .dark #submit-btn::before {
          color: #191919 !important;
        }
      }

      /* Extra narrow viewport (for very small sidebars ~300px) */
      @media (max-width: 350px) {
        #nav-logo {
          max-height: 1rem !important;
        }

        .chat-input-container {
          margin-left: 0.25rem !important;
          margin-right: 0.25rem !important;
          padding: 0.5rem !important;
        }

        /* Hide "Send" text completely, icon only */
        #submit-btn {
          width: 36px !important;
          height: 36px !important;
        }

        /* Reduce wand plus button size */
        .wand-plus-trigger {
          width: 32px !important;
          height: 32px !important;
          font-size: 14px !important;
        }

        /* Compact message bubbles */
        .message-bubble {
          padding: 0.5rem 0.75rem !important;
          font-size: 13px !important;
        }
      }

      /* ============================================
       SETTINGS POPOVER - Floating Menu
       ============================================ */
      .settings-group {
        position: relative;
      }

      .settings-popover {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%) translateY(10px);
        margin-bottom: 12px;
        display: none;
        /* Flex when active */
        flex-direction: column;
        gap: 8px;
        padding: 8px;
        background: white;
        border-radius: 24px;
        box-shadow:
          0 10px 40px rgba(0, 0, 0, 0.15),
          0 4px 12px rgba(0, 0, 0, 0.1);
        z-index: 200;
        min-width: 52px;
        align-items: center;
        opacity: 0;
        transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
      }

      .settings-popover.active {
        display: flex;
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }

      .dark .settings-popover {
        background: #1f2937;
        box-shadow:
          0 10px 40px rgba(0, 0, 0, 0.4),
          0 4px 12px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .popover-arrow {
        position: absolute;
        bottom: -6px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 6px solid transparent;
        border-right: 6px solid transparent;
        border-top: 6px solid white;
      }

      .dark .popover-arrow {
        border-top-color: #1f2937;
      }

      .popover-btn {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: #f3f4f6;
        border: none;
        color: #374151;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .dark .popover-btn {
        background: #374151;
        color: #e5e7eb;
      }

      .popover-btn:hover {
        background: #e5e7eb;
        transform: scale(1.1);
      }

      .dark .popover-btn:hover {
        background: #4b5563;
      }

      /* ============================================
       SAGE SEARCH BOX - Modern Design System
       ============================================ */

      /* CSS Variables for theming */
      :root {
        --surface: #ffffff;
        --surface-hover: #f3f4f6;
        --text-primary: #1f2937;
        --text-secondary: #6b7280;
        --text-muted: #9ca3af;
        --border-light: rgba(0, 0, 0, 0.06);
        --soft-shadow:
          0 8px 32px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.04);
        --focus-ring: rgba(59, 130, 246, 0.3);
        --accent: #3b82f6;
        --accent-hover: #2563eb;
      }

      .dark {
        --surface: rgba(31, 41, 55, 0.95);
        --surface-hover: rgba(55, 65, 81, 0.8);
        --text-primary: #e5e7eb;
        --text-secondary: #9ca3af;
        --text-muted: #6b7280;
        --border-light: rgba(255, 255, 255, 0.1);
        --soft-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        --focus-ring: rgba(59, 130, 246, 0.4);
      }

      /* Container */
      .sage-search-container {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: calc(100% - 40px);
        max-width: 700px;
        z-index: 100;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        padding-top: 1.5rem;
        /* Space above for disclaimer */
      }

      /* Responsive adjustment when drawers are open */
      @media (min-width: 1024px) {
        body.settings-open .sage-search-container {
          width: calc(100% - 24rem - 40px);
          left: calc((100% - 24rem) / 2);
        }

        body.console-open .sage-search-container {
          width: calc(100% - 20rem - 40px);
          left: calc((100% - 20rem) / 2);
        }
      }

      /* Adjust search container when dynamic side panel is open (above mobile) */
      @media (min-width: 768px) {
        body.dynamic-container-open .sage-search-container {
          width: calc(60% - 40px);
          left: 30%;
        }
      }

      /* Main Search Box - Single Line Layout */
      .sage-search-box {
        display: flex;
        flex-direction: column;
        gap: 0;
        padding: 10px 14px;
        border-radius: 999px;
        background: var(--surface);
        box-shadow: var(--soft-shadow);
        border: 1px solid var(--border-light);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .sage-search-box:focus-within {
        box-shadow:
          0 12px 40px rgba(59, 130, 246, 0.15),
          0 4px 12px rgba(59, 130, 246, 0.08);
        border-color: var(--focus-ring);
      }

      /* Input Row (Top) */
      .sage-input-row {
        width: 100%;
      }

      /* Toolbar Row (Bottom) */
      .sage-toolbar-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      /* Left and Right Sections */
      .sage-left,
      .sage-right {
        display: flex;
        align-items: center;
        gap: 6px;
        position: relative;
      }

      /* Input Field */
      .sage-input {
        width: 100%;
        border: none;
        outline: none;
        resize: none;
        background: transparent;
        font-size: 16px;
        color: var(--text-primary);
        padding: 4px 0 4px 12px;
        min-height: 24px;
        max-height: calc(1.5em * 7 + 16px);
        line-height: 1.5;
        font-family: inherit;
        overflow-y: hidden;
      }

      .sage-input::placeholder {
        color: var(--text-muted);
      }

      /* Mode/Persona Selector */
      .mode-selector {
        border-radius: 999px;
        padding: 8px 28px 8px 14px;
        background: var(--surface-hover);
        border: none;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%231f2937' d='M6 8L2 4h8z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
      }

      .dark .mode-selector {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23e5e7eb' d='M6 8L2 4h8z'/%3E%3C/svg%3E");
      }

      .mode-selector:hover {
        background-color: #e5e7eb;
      }

      .dark .mode-selector:hover {
        background-color: rgba(75, 85, 99, 0.9);
      }

      .mode-selector:focus {
        outline: none;
        box-shadow: 0 0 0 3px var(--focus-ring);
      }

      /* Icon Buttons */
      .icon-btn {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        border: none;
        background: transparent;
        color: var(--text-secondary);
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .icon-btn:hover {
        background: var(--surface-hover);
        color: var(--text-primary);
        transform: scale(1.05);
      }

      /* Microphone Button - Primary style */
      .mic-btn,
      #voice-btn {
        background: linear-gradient(135deg, #012258, #60a5fa) !important;
        color: white !important;
        box-shadow: 0 0 0 3px #60a5fa6e !important;
        border: none !important;
      }

      .mic-btn:hover,
      #voice-btn:hover {
        background: linear-gradient(135deg, #2563eb, #2460c0) !important;
        color: white !important;
        transform: scale(1.08);
      }

      /* Experimental Mode Toggle Button */
      .experimental-toggle {
        transition: all 0.3s ease;
      }

      .experimental-toggle.active {
        background: linear-gradient(135deg, #093782, #60a5fa);
        color: white;
        box-shadow: 0 0 0 3px #60a5fa6e;
      }

      #submit-btn {
        background: linear-gradient(135deg, #012258, #60a5fa) !important;
        color: white !important;
        box-shadow: 0 0 0 3px #60a5fa6e !important;
        border: none !important;
      }

      #submit-btn:hover {
        background: linear-gradient(135deg, #2563eb, #2460c0) !important;
        transform: translateY(-1px);
      }

      .experimental-toggle.active:hover {
        background: linear-gradient(135deg, #2563eb, #2460c0);
        transform: scale(1.08);
      }

      /* Tools Button */
      .tools-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        border-radius: 999px;
        /* background: var(--surface-hover); */
        border: none;
        font-size: 13px;
        font-weight: 500;
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .tools-btn:hover {
        background: #e5e7eb;
      }

      .dark .tools-btn:hover {
        background: rgba(69, 84, 106, 0.9);
      }

      .tools-btn i {
        font-size: 13px;
        color: var(--text-secondary);
      }

      /* Tools Popover */
      .tools-popover {
        position: absolute;
        bottom: calc(100% + 12px);
        right: 0;
        background: var(--surface);
        border-radius: 16px;
        padding: 8px;
        box-shadow:
          0 10px 40px rgba(0, 0, 0, 0.15),
          0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--border-light);
        min-width: 200px;
        z-index: 200;
        opacity: 0;
        transform: translateY(8px);
        transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        pointer-events: none;
      }

      .tools-popover.active {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
      }

      .tools-popover.hidden {
        display: none;
      }

      .tools-popover:not(.hidden) {
        display: block;
      }

      /* Tools Items */
      .tools-item {
        display: flex;
        align-items: center;
        gap: 12px;
        width: 100%;
        padding: 10px 14px;
        border: none;
        background: transparent;
        border-radius: 10px;
        font-size: 14px;
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.15s ease;
        text-align: left;
      }

      .tools-item:hover {
        background: var(--surface-hover);
      }

      .tools-item i {
        width: 20px;
        text-align: center;
        color: var(--text-secondary);
        font-size: 14px;
      }

      .tools-item.active {
        background: rgba(59, 130, 246, 0.1);
        color: var(--accent);
      }

      .tools-item.active i {
        color: var(--accent);
      }

      /* Tools Popover Separator */
      .tools-separator {
        border: none;
        border-top: 1px solid var(--border-light);
        margin: 6px 0;
      }

      /* Mobile responsive adjustments */
      @media (max-width: 768px) {
        .sage-search-container {
          bottom: 12px;
          width: calc(100% - 24px);
          max-width: 100vw;
          box-sizing: border-box;
        }

        .sage-search-box {
          padding: 10px 14px;
          gap: 8px;
          border-radius: 24px; /* softer corners for double-row */
        }

        /* ── Fix 3: Double-row search box on mobile ── */
        .sage-toolbar-row {
          flex-wrap: wrap;
        }

        .sage-input-row {
          flex: 1 1 100% !important; /* input takes full width, forces wrap */
          order: 1;
        }

        .sage-right {
          order: 2;
          flex: 1 1 100%;
          justify-content: flex-end;
          padding-top: 4px;
        }

        .tools-btn span {
          display: none;
        }

        .tools-btn {
          padding: 8px;
          border-radius: 50%;
        }

        .mode-selector {
          padding: 6px 24px 6px 12px;
          font-size: 13px;
        }

        .sage-input {
          font-size: 14px;
        }

        .icon-btn {
          width: 34px;
          height: 34px;
          font-size: 14px;
        }
      }

      /* Legacy support - keep old class names working */
      .search-action-btn {
        /* Alias for icon-btn */
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        border: none;
        background: transparent;
        color: var(--text-secondary);
        font-size: 16px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .search-action-btn:hover {
        background: var(--surface-hover);
        color: var(--text-primary);
        transform: scale(1.05);
      }

      .search-action-btn.primary {
        background: linear-gradient(135deg, var(--accent), #60a5fa);
        color: white;
      }

      .search-action-btn.primary:hover {
        background: linear-gradient(135deg, var(--accent-hover), var(--accent));
        transform: scale(1.08);
      }

      /* ============================================
       MODE SELECTOR - Custom Button & Dropdown
       ============================================ */

      .mode-selector-wrapper {
        position: relative;
      }

      .mode-selector-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        border-radius: 999px;
        background: var(--surface-hover);
        border: none;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
      }

      .mode-selector-btn:hover {
        background: #e5e7eb;
      }

      .dark .mode-selector-btn:hover {
        background: rgba(75, 85, 99, 0.9);
      }

      .mode-selector-btn i {
        font-size: 10px;
        color: var(--text-secondary);
        transition: transform 0.2s ease;
      }

      .mode-selector-btn.open i {
        transform: rotate(180deg);
      }

      /* ============================================
       SAGE MODE SELECTOR - Gemini-Style Pill + Dropdown
       ============================================ */

      .sage-mode-selector {
        position: relative;
        z-index: 310;
      }

      .sage-mode-trigger {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        border-radius: 999px;
        background: var(--surface-hover);
        border: 1px solid transparent;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
        letter-spacing: 0.01em;
      }

      .sage-mode-trigger:hover {
        background: #e5e7eb;
        border-color: var(--border-light);
      }

      .dark .sage-mode-trigger:hover {
        background: rgba(75, 85, 99, 0.7);
      }

      .sage-mode-trigger .chevron {
        font-size: 10px;
        color: var(--text-secondary);
        transition: transform 0.25s cubic-bezier(0.16, 1, 0.3, 1);
      }

      .sage-mode-trigger.open .chevron {
        transform: rotate(180deg);
      }

      /* Dropdown Panel */
      .sage-mode-dropdown {
        position: absolute;
        bottom: calc(100% + 10px);
        right: 0;
        background: var(--surface);
        border-radius: 16px;
        padding: 8px;
        box-shadow:
          0 -8px 32px rgba(0, 0, 0, 0.12),
          0 -2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid var(--border-light);
        min-width: 300px;
        opacity: 0;
        transform: translateY(8px) scale(0.97);
        transition: all 0.25s cubic-bezier(0.16, 1, 0.3, 1);
        pointer-events: none;
        visibility: hidden;
      }

      .dark .sage-mode-dropdown {
        box-shadow:
          0 -8px 32px rgba(0, 0, 0, 0.4),
          0 -2px 8px rgba(0, 0, 0, 0.3);
      }

      .sage-mode-dropdown.open {
        opacity: 1;
        transform: translateY(0) scale(1);
        pointer-events: auto;
        visibility: visible;
      }

      .sage-mode-dropdown-header {
        padding: 10px 14px 6px;
        font-size: 11px;
        font-weight: 700;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--text-muted);
      }

      .sage-mode-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        padding: 10px 14px;
        border: none;
        background: transparent;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.15s ease;
        text-align: left;
      }

      .sage-mode-item:hover {
        background: var(--surface-hover);
      }

      .sage-mode-item-content {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .sage-mode-item-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .sage-mode-item-desc {
        font-size: 12px;
        color: var(--text-muted);
        line-height: 1.3;
      }

      .sage-mode-check {
        width: 22px;
        height: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: var(--accent);
        color: white;
        font-size: 11px;
        opacity: 0;
        transform: scale(0.6);
        transition: all 0.25s cubic-bezier(0.16, 1, 0.3, 1);
        flex-shrink: 0;
      }

      .sage-mode-item.active .sage-mode-check {
        opacity: 1;
        transform: scale(1);
      }

      .sage-mode-item.active .sage-mode-item-title {
        color: var(--accent);
      }

      /* Separator */
      .sage-mode-sep {
        height: 1px;
        background: var(--border-light);
        margin: 4px 14px;
      }

      /* Legacy Collapsible */
      .sage-mode-legacy-toggle {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        padding: 10px 14px;
        border: none;
        background: transparent;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.15s ease;
        text-align: left;
      }

      .sage-mode-legacy-toggle:hover {
        background: var(--surface-hover);
      }

      .sage-mode-legacy-toggle .legacy-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-secondary);
      }

      .sage-mode-legacy-toggle .legacy-chevron {
        font-size: 11px;
        color: var(--text-muted);
        transition: transform 0.25s ease;
      }

      .sage-mode-legacy-toggle.expanded .legacy-chevron {
        transform: rotate(90deg);
      }

      .sage-mode-legacy-panel {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      }

      .sage-mode-legacy-panel.expanded {
        max-height: 300px;
      }

      .sage-mode-legacy-inner {
        padding: 4px 8px 4px 20px;
      }

      .sage-mode-legacy-inner .sage-mode-item {
        padding: 8px 12px;
      }

      .sage-mode-legacy-inner .sage-mode-item-title {
        font-size: 13px;
      }

      .sage-mode-legacy-inner .sage-mode-item-desc {
        font-size: 11px;
      }

      /* Reasoning / Verbosity pill selectors */
      .sage-option-group {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 6px 16px;
        gap: 10px;
      }

      .sage-option-label {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-secondary);
        white-space: nowrap;
      }

      .sage-option-pills {
        display: flex;
        gap: 2px;
        background: var(--surface-hover);
        border-radius: 8px;
        padding: 2px;
      }

      .sage-option-pill {
        padding: 4px 12px;
        border: none;
        background: transparent;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 500;
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .sage-option-pill:hover {
        color: var(--text-primary);
      }

      .sage-option-pill.active {
        background: var(--accent);
        color: white;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .dark .sage-option-pills {
        background: rgba(255, 255, 255, 0.08);
      }

      .dark .sage-option-pill.active {
        background: var(--accent);
        color: white;
      }

      /* Mobile overrides */
      @media (max-width: 768px) {
        .sage-mode-trigger {
          padding: 5px 10px;
          font-size: 12px;
        }

        .sage-mode-dropdown {
          min-width: 260px;
          right: -20px;
        }
      }

      /* Mode Dropdown (Tailwind Style) - Opens ABOVE the trigger */
      .mode-dropdown {
        position: absolute;
        bottom: calc(100% + 12px);
        right: 0;
        background: var(--surface);
        border-radius: 16px;
        padding: 8px;
        box-shadow:
          0 -10px 40px rgba(0, 0, 0, 0.15),
          0 -4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--border-light);
        min-width: 280px;
        z-index: 300;
        opacity: 0;
        transform: translateY(10px);
        transition: all 0.25s cubic-bezier(0.16, 1, 0.3, 1);
        pointer-events: none;
      }

      .mode-dropdown.active {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
      }

      .mode-dropdown.hidden {
        display: none;
      }

      .mode-dropdown:not(.hidden) {
        display: block;
      }

      .mode-dropdown-header {
        padding: 12px 16px 8px;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
      }

      .mode-option {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        padding: 8px 16px;
        border: none;
        background: transparent;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.15s ease;
        text-align: left;
      }

      .mode-option:hover {
        background: var(--surface-hover);
      }

      .mode-option-content {
        display: flex;
        flex-direction: column;
        gap: 1px;
      }

      .mode-option-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .mode-option-desc {
        font-size: 12px;
        color: var(--text-muted);
      }

      .mode-check {
        width: 22px;
        height: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: var(--accent);
        color: white;
        font-size: 12px;
        opacity: 0;
        transform: scale(0.8);
        transition: all 0.2s ease;
      }

      .mode-option.active .mode-check {
        opacity: 1;
        transform: scale(1);
      }

      .mode-option.active .mode-option-title {
        color: var(--text-primary);
      }

      /* ============================================
       QUICK ACTION PILLS
       ============================================ */

      .sage-quick-actions {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
        padding: 12px 0 0;
      }

      .quick-action-pill {
        padding: 10px 18px;
        border-radius: 999px;
        background: var(--surface);
        border: 1px solid var(--border-light);
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      }

      .quick-action-pill:hover {
        background: var(--surface-hover);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }

      .dark .quick-action-pill {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .dark .quick-action-pill:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      /* Mobile: Hide quick actions on small screens */
      @media (max-width: 768px) {
        .sage-quick-actions {
          display: none;
        }

        .mode-selector-btn {
          padding: 6px 10px;
          font-size: 13px;
        }

        .mode-dropdown {
          min-width: 220px;
          right: -40px;
        }
      }
      /* ===== Disclaimer Banner (Cookie-style footer) ===== */
      .disclaimer-banner {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, #012258, #1e3a8a);
        color: white;
        padding: 16px 24px;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 20px;
        transform: translateY(0);
        transition:
          transform 0.3s ease-out,
          opacity 0.3s ease-out;
      }

      .disclaimer-banner.hidden {
        transform: translateY(100%);
        opacity: 0;
        pointer-events: none;
      }

      .disclaimer-banner-content {
        flex: 1;
        font-size: 13px;
        line-height: 1.5;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .disclaimer-icon {
        font-size: 24px;
        flex-shrink: 0;
      }

      .disclaimer-text {
        flex: 1;
      }

      .disclaimer-banner-btn {
        padding: 8px 24px;
        background: white;
        color: #012258;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
        flex-shrink: 0;
      }

      .disclaimer-banner-btn:hover {
        background: #f0f0f0;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .disclaimer-banner-btn:active {
        transform: translateY(0);
      }

      /* Dark mode overrides */
      .dark .disclaimer-banner {
        background: white;
        color: #1e293b;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
      }

      .dark .disclaimer-banner-btn {
        background: linear-gradient(135deg, #093782, #60a5fa);
        color: white;
      }

      .dark .disclaimer-banner-btn:hover {
        background: linear-gradient(135deg, #0a3f94, #70b0fc);
      }

      /* Mobile responsive */
      @media (max-width: 768px) {
        .disclaimer-banner {
          flex-direction: column;
          gap: 12px;
          padding: 16px;
        }

        .disclaimer-banner-content {
          flex-direction: column;
          text-align: center;
        }

        .disclaimer-banner-btn {
          width: 100%;
        }
      }
    </style>
  </head>

  <body class="bg-white dark:bg-black">
    <!-- REMOVED VERTICAL TOOLBAR (Redundant) -->

    <!-- SAGE SEARCH BOX - Double Decker Layout -->
    <div class="sage-search-container">
      <!-- Mode Selection Confirmation Message -->
      <div
        id="mode-confirmation-message"
        class="mode-confirmation hidden"
        style="
          position: fixed;
          bottom: 100px;
          left: 50%;
          transform: translateX(-50%);
          z-index: 9999;
          background: linear-gradient(135deg, #012258, #60a5fa);
          color: white;
          padding: 10px 20px;
          border-radius: 12px;
          font-size: 14px;
          font-weight: 500;
          box-shadow: 0 4px 12px rgba(1, 34, 88, 0.3);
          transition: opacity 0.3s ease;
          display: none;
        "
      >
        <span id="mode-confirmation-text"></span>
      </div>
      <!-- Desktop Processing Status Indicator -->
      <div id="desktop-status-indicator" class="desktop-status hidden">
        <i class="fa-solid fa-spinner fa-spin"></i>
        <span id="desktop-status-text">Processing...</span>
      </div>
      <div class="sage-search-box mb-4">
        <!-- SINGLE ROW: Input + Tools + Send/Mic -->
        <div class="sage-toolbar-row">
          <!-- Input Field -->
          <div class="sage-input-row" style="flex: 1">
            <textarea
              id="new-query-input"
              class="sage-input"
              placeholder="Ask SAGE using text or voice..."
              rows="1"
              autocomplete="off"
            ></textarea>
          </div>

          <!-- COMMENTED OUT: Flask icon (experimental toggle in search bar) -->
          <!--
          {% if show_experimental_toggle %}
          <button
            class="icon-btn experimental-toggle"
            id="experimental-mode-btn"
            aria-label="Toggle Experimental Mode"
            title="Toggle Experimental Mode"
          >
            <i class="ph-bold ph-flask"></i>
          </button>
          {% endif %}
          -->

          <!-- Hidden persona select — MUST remain in the DOM for JS persona sync chain -->
          <select
            id="new-persona-selector"
            class="hidden"
            aria-hidden="true"
            style="display: none !important"
          >
            <option value="explorer">Explorer</option>
            <option value="intermediate">Balanced</option>
            <option value="balanced_plus">Balanced Plus</option>
            <option value="balanced_plus_ps">Product Specialist</option>
            <option value="balanced_plus_ta">Technical Assistant</option>
            <option value="scientist">Scientist</option>
          </select>

          <!-- COMMENTED OUT: Bottom Mode Selector visual UI (keeping only top mode pill bar) -->
          <!--
          <div class="mode-selector-wrapper hidden" id="mode-selector-wrapper">
            <button class="mode-selector-btn" id="mode-selector-trigger" aria-label="Select Mode">
              <span id="current-mode-label">Balanced</span>
              <i class="fa-solid fa-chevron-down"></i>
            </button>
            <div id="mode-dropdown" class="mode-dropdown hidden">
              <div class="mode-dropdown-header">SAGE Modes</div>
              <button class="mode-option active" data-mode="explorer">
                <div class="mode-option-content">
                  <span class="mode-option-title">Explorer</span>
                  <span class="mode-option-desc">Answers quickly</span>
                </div>
                <i class="fa-solid fa-check mode-check"></i>
              </button>
              <button class="mode-option" data-mode="intermediate">
                <div class="mode-option-content">
                  <span class="mode-option-title">Balanced</span>
                  <span class="mode-option-desc">Balanced accuracy and speed</span>
                </div>
                <i class="fa-solid fa-check mode-check"></i>
              </button>
              <button class="mode-option" data-mode="scientist">
                <div class="mode-option-content">
                  <span class="mode-option-title">Scientist</span>
                  <span class="mode-option-desc">Thinks longer for ultimate accuracy</span>
                </div>
                <i class="fa-solid fa-check mode-check"></i>
              </button>
            </div>
          </div>
          -->

          <!-- Integrated Mode Status Indicator (commented out) -->
          <!-- <div id="new-mode-status"
            class="ml-3 px-2 py-1 rounded-md text-[10px] uppercase tracking-wider font-bold hidden transition-all duration-300">
            Standard
          </div> -->

          <!-- RIGHT SIDE: Mode Selector + Tools + Mic/Send -->
          <div class="sage-right" style="position: relative">
            <!-- SAGE Mode Selector (Gemini-style pill dropdown) -->
            <div class="sage-mode-selector" id="sage-mode-selector">
              <button class="sage-mode-trigger" id="sage-mode-trigger">
                <span id="sage-mode-label">Balanced+</span>
                <i class="fa-solid fa-chevron-down chevron"></i>
              </button>
              <div class="sage-mode-dropdown" id="sage-mode-dropdown">
                <div class="sage-mode-dropdown-header">SAGE</div>
                <button
                  class="sage-mode-item active"
                  data-persona="balanced_plus"
                  data-mode="experimental"
                >
                  <div class="sage-mode-item-content">
                    <span class="sage-mode-item-title"
                      >Balanced+
                      <i class="ph-bold ph-flask text-purple-500 ml-1.5"></i
                    ></span>
                    <span class="sage-mode-item-desc"
                      >Selective metacognition &amp; deeper analysis</span
                    >
                  </div>
                  <span class="sage-mode-check"
                    ><i class="fa-solid fa-check"></i
                  ></span>
                </button>
                <button
                  class="sage-mode-item"
                  data-persona="balanced_plus_ps"
                  data-mode="experimental"
                >
                  <div class="sage-mode-item-content">
                    <span class="sage-mode-item-title"
                      >Product Specialist
                      <i class="fa-solid fa-bullseye text-orange-500 ml-1.5"></i
                    ></span>
                    <span class="sage-mode-item-desc"
                      >Sales positioning &amp; competitive differentiation</span
                    >
                  </div>
                  <span class="sage-mode-check"
                    ><i class="fa-solid fa-check"></i
                  ></span>
                </button>
                <button
                  class="sage-mode-item"
                  data-persona="balanced_plus_ta"
                  data-mode="experimental"
                >
                  <div class="sage-mode-item-content">
                    <span class="sage-mode-item-title"
                      >Technical Assistant
                      <i class="fa-solid fa-wrench text-teal-500 ml-1.5"></i
                    ></span>
                    <span class="sage-mode-item-desc"
                      >Technical depth &amp; troubleshooting guidance</span
                    >
                  </div>
                  <span class="sage-mode-check"
                    ><i class="fa-solid fa-check"></i
                  ></span>
                </button>
                <button
                  class="sage-mode-item"
                  data-persona="scientist"
                  data-mode="experimental"
                >
                  <div class="sage-mode-item-content">
                    <span class="sage-mode-item-title">Scientist</span>
                    <span class="sage-mode-item-desc"
                      >Deep analysis with self-verification</span
                    >
                  </div>
                  <span class="sage-mode-check"
                    ><i class="fa-solid fa-check"></i
                  ></span>
                </button>
                <div class="sage-mode-sep"></div>
                <!-- Reasoning Effort Selector -->
                <div class="sage-option-group">
                  <span class="sage-option-label">Reasoning</span>
                  <div class="sage-option-pills" id="reasoning-pills">
                    <button class="sage-option-pill" data-value="low">
                      Low
                    </button>
                    <button class="sage-option-pill active" data-value="medium">
                      Medium
                    </button>
                    <button class="sage-option-pill" data-value="high">
                      High
                    </button>
                  </div>
                </div>
                <!-- Verbosity Selector -->
                <div class="sage-option-group">
                  <span class="sage-option-label">Verbosity</span>
                  <div class="sage-option-pills" id="verbosity-pills">
                    <button class="sage-option-pill" data-value="low">
                      Low
                    </button>
                    <button class="sage-option-pill active" data-value="medium">
                      Medium
                    </button>
                    <button class="sage-option-pill" data-value="high">
                      High
                    </button>
                  </div>
                </div>
                <div class="sage-mode-sep"></div>
                <button class="sage-mode-legacy-toggle" id="sage-legacy-toggle">
                  <span class="legacy-title">+ Modes</span>
                  <i class="fa-solid fa-chevron-right legacy-chevron"></i>
                </button>
                <div class="sage-mode-legacy-panel" id="sage-legacy-panel">
                  <div class="sage-mode-legacy-inner">
                    <button
                      class="sage-mode-item"
                      data-persona="intermediate"
                      data-mode="experimental"
                    >
                      <div class="sage-mode-item-content">
                        <span class="sage-mode-item-title">Classic</span>
                        <span class="sage-mode-item-desc"
                          >Enhanced accuracy with citations</span
                        >
                      </div>
                      <span class="sage-mode-check"
                        ><i class="fa-solid fa-check"></i
                      ></span>
                    </button>
                    <!-- Explorer (code preserved, removed from menu) -->
                    <!--
                    <button
                      class="sage-mode-item"
                      data-persona="explorer"
                      data-mode="experimental"
                    >
                      <div class="sage-mode-item-content">
                        <span class="sage-mode-item-title">Explorer</span>
                        <span class="sage-mode-item-desc"
                          >Fast, lightweight answers</span
                        >
                      </div>
                      <span class="sage-mode-check"
                        ><i class="fa-solid fa-check"></i
                      ></span>
                    </button>
                    -->
                  </div>
                </div>
              </div>
            </div>

            <!-- Tools button (icon only) -->
            <button
              class="icon-btn"
              id="search-settings-btn"
              aria-label="Tools"
              title="Tools"
            >
              <i class="fa-solid fa-sliders"></i>
            </button>

            <!-- TOOLS POPOVER -->
            <div id="settings-popover" class="tools-popover hidden">
              <!-- New Chat -->
              <button class="tools-item" id="popover-new-chat">
                <i class="fa-solid fa-plus"></i>
                <span>New Chat</span>
              </button>

              <!-- Dark Mode -->
              <button class="tools-item" id="popover-theme">
                <i class="fa-solid fa-moon"></i>
                <span>Dark Mode</span>
              </button>

              <!-- Prompt Enhancers -->
              <button class="tools-item" id="magic-btn">
                <i class="fa-solid fa-wand-magic"></i>
                <span>Enhance Query</span>
              </button>

              <button class="tools-item" id="magic-btn-2xl">
                <i class="fa-solid fa-wand-magic-sparkles"></i>
                <span>Detailed Prompt</span>
              </button>

              <!-- Separator -->
              <hr class="tools-separator" />

              <!-- Feedback (placeholder) -->
              <button class="tools-item" id="popover-feedback">
                <i class="fa-solid fa-comment-dots"></i>
                <span>Feedback</span>
              </button>

              <!-- Success Story (placeholder) -->
              <button class="tools-item" id="popover-success-stories">
                <i class="fa-solid fa-trophy"></i>
                <span>Success Story</span>
              </button>
            </div>

            <!-- Voice/Send Button -->
            <button
              class="icon-btn mic-btn"
              id="new-voice-btn"
              aria-label="Voice Input"
            >
              <i class="ph-bold ph-microphone"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Passcode Overlay -->
    <!--
 <div id="passcode-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-35 z-50 flex flex-col items-center justify-center" style="background-image: url('/assets/overlay_2.jpeg'); background-repeat: no-repeat; background-position: center; background-size: cover; background-blend-mode: darken;">
    <div class="text-center max-w-md mx-auto p-8">
      
      
      <h2 class="text-xl font-bold mb-8 text-white">Restricted Area</h2>
      <div class="relative mb-6">
        <input type="password" id="passcode-input" class="w-full bg-gray-100 rounded-full py-3 px-4 pl-12 pr-20 text-lg" placeholder="Passcode">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <i class="fas fa-lock text-gray-500"></i>
        </div>
        <button id="access-btn" class="absolute inset-y-0 right-0 flex items-center bg-gray-800 text-white rounded-full py-2 px-4 mr-1 text-lg">
          <i class="fas fa-unlock mr-2"></i>
        </button>
      </div>
    </div>
  </div>  -->
    <div class="chat-container w-full md:w-[60%] mx-auto">
      <!-- Header (HIDDEN - Redundant with new UI) -->
      <div
        style="display: none"
        class="bg-white dark:bg-black text-white border-b-2 border-gray-100 dark:border-white/30 px-4 py-3 flex items-center justify-between"
      >
        <div class="flex items-center">
          <img
            id="nav-logo"
            class="h-auto max-w-sm w-auto inline-block object-cover max-h-6"
            alt="Logo"
            src="https://content.tst-34.aws.agilent.com/wp-content/uploads/2025/06/5.png"
          />
        </div>

        <div class="flex items-center gap-4">
          <!-- Sage Experimental Mode Toggle (controlled by ENABLE_EXPERIMENTAL_MODE_TOGGLE env var) -->
          {% if show_experimental_toggle %}
          <div id="sage-mode-toggle-container" class="flex items-center gap-2">
            <label class="relative inline-flex items-center cursor-pointer">
              <input
                type="checkbox"
                id="experimental-mode-toggle"
                class="sr-only peer"
              />
              <div
                class="w-11 h-6 bg-gray-200 peer-focus:ring-4 peer-focus:ring-purple-300 dark:peer-focus:ring-purple-800 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600 dark:bg-gray-700 dark:border-gray-600"
              ></div>
              <span
                class="ms-2 text-sm font-medium text-gray-700 dark:text-gray-300"
              >
                <span id="mode-label">Standard</span>
              </span>
            </label>
            <span
              id="experimental-badge"
              class="hidden px-2 py-0.5 text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200 rounded-full"
            >
              🧪 Experimental
            </span>
          </div>
          {% endif %}

          <!-- Theme Toggle -->
          <div class="flex items-center gap-2">
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="theme-toggle" class="sr-only peer" />
              <div
                class="w-11 h-6 bg-gray-200 peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600 dark:bg-gray-700 dark:border-gray-600"
              ></div>
              <span
                class="ms-2 text-sm font-medium text-gray-700 dark:text-gray-300"
              >
                <i class="fas fa-moon"></i>
              </span>
            </label>
          </div>

          <div class="inline-flex rounded-md shadow-xs">
            <a
              href="#"
              aria-current="page"
              class="px-4 py-2 text-sm font-medium text-blue-700 bg-white dark:bg-black text-white border border-gray-200 rounded-s-lg hover:bg-gray-100 focus:z-10 focus:ring-2 focus:ring-blue-700 focus:text-blue-700 hidden"
            >
              Chat
            </a>
            <a
              href="#"
              id="toggle-settings-btn"
              class="px-4 py-2 text-sm font-medium text-gray-900 bg-white dark:bg-black text-white border-t border-b border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-700 focus:text-blue-700 hidden"
            >
              Settings
            </a>
            <a
              href="#"
              class="px-4 py-2 text-sm font-medium text-gray-900 bg-white dark:bg-black text-white border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-700 focus:text-blue-700 hidden"
            >
              Analytics
            </a>
            <!-- Mode buttons will be dynamically added here by unifiedDevEval.js -->
            <div
              id="mode-buttons-container"
              class="ml-4 flex space-x-2"
              style="display: none"
            >
              <button
                id="toggle-developer-mode-btn"
                class="mode-button px-4 py-2 text-xs font-medium text-black bg-white dark:bg-black text-white border rounded hover:bg-blue-200 hover:underline focus:outline-none focus:underline focus:ring-red-400"
                type="button"
              >
                eVal Mode
              </button>
              <!-- Batch and Compare mode buttons will be added here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Chat Messages Area -->
      <div id="chat-messages" class="chat-messages">
        <!-- Top Mode Pill Bar (DEPRECATED — replaced by Gemini-style sage-mode-selector in search bar) -->
        <div
          id="top-mode-pill"
          class="top-mode-pill hidden"
          style="display: none !important"
        >
          <div class="top-mode-pill-slider"></div>
          {% if show_experimental_toggle %}
          <button
            class="top-mode-btn top-flask-toggle"
            id="top-flask-toggle"
            title="Toggle Experimental Mode"
          >
            <i class="ph-bold ph-flask"></i>
          </button>
          {% endif %}
          <button class="top-mode-btn" data-mode="explorer" title="Explorer">
            <i class="ph-bold ph-note-pencil"></i>
          </button>
          <button
            class="top-mode-btn active"
            data-mode="intermediate"
            title="Balanced"
          >
            <i class="ph-bold ph-flask"></i>
          </button>
          <button
            class="top-mode-btn"
            data-mode="balanced_plus"
            title="Balanced Plus"
          >
            <i class="ph-bold ph-brain"></i>
          </button>
          <button class="top-mode-btn" data-mode="scientist" title="Scientist">
            <i class="ph-bold ph-dna"></i>
          </button>
        </div>

        <!-- Logo centered in message area before first message -->
        <div
          id="center-logo"
          class="flex flex-col items-center justify-center h-[50vh]"
        >
          <img
            id="random-logo"
            class="w-auto inline-block object-contain"
            alt="Logo"
            src="/assets/"
          />
        </div>
        <script>
          (function () {
            const logos = {
              light:
                "https://content.tst-34.aws.agilent.com/wp-content/uploads/2025/06/sage_icon_logo.png",
              dark: "https://content.tst-34.aws.agilent.com/wp-content/uploads/2025/09/SAGE_White_No_Bg.png",
            };

            function updateLogo() {
              // Respect the same theme source as dark-mode.js:
              // 1. localStorage 'theme' (explicit user choice)
              // 2. html.dark class (set by dark-mode.js or inline script)
              // 3. prefers-color-scheme (system fallback, only if no explicit choice)
              const savedTheme = localStorage.getItem("theme");
              let isDark;
              if (savedTheme) {
                isDark = savedTheme === "dark";
              } else {
                isDark =
                  document.documentElement.classList.contains("dark") ||
                  window.matchMedia("(prefers-color-scheme: dark)").matches;
              }
              const logoSrc = isDark ? logos.dark : logos.light;
              const logoElement = document.getElementById("random-logo");
              if (logoElement) {
                logoElement.src = logoSrc;
              }
            }

            document.addEventListener("DOMContentLoaded", () => {
              updateLogo();
            });

            // Listen for dark mode changes on html element
            const observer = new MutationObserver(updateLogo);
            observer.observe(document.documentElement, {
              attributes: true,
              attributeFilter: ["class"],
            });

            // Listen for system preference changes
            window
              .matchMedia("(prefers-color-scheme: dark)")
              .addEventListener("change", updateLogo);
          })();
        </script>

        <!-- Bot welcome message (initially hidden) -->
        <div id="welcome-message" class="flex items-start gap-2.5 mb-4 hidden">
          <img
            class="w-8 h-8 rounded-full"
            src="https://content.tst-34.aws.agilent.com/wp-content/uploads/2025/05/dalle.png"
            alt="AI Agent"
          />
          <div class="flex flex-col w-auto max-w-[90%] leading-1.5">
            <div class="flex items-center space-x-2 rtl:space-x-reverse">
              <span
                class="text-sm font-semibold text-gray-900 dark:text-white/80"
                >SAGE<span
                  class="mt-1 text-sm leading-tight font-medium text-blue-700 dark:text-white/80"
                  >AI Agent</span
                ></span
              >
            </div>
            <div class="text-sm font-normal py-2 text-gray-900">
              Hi there! I'm an AI assistant trained on your knowledge base. What
              would you like to know?
            </div>
          </div>
        </div>
        <!-- Messages will be added here dynamically -->
      </div>

      <p
        id="ai-disclaimer"
        class="text-xs text-gray-500 mt-3 mb-3 pt-2 text-center hidden"
      >
        AI-generated content may be incorrect | Agilent Internal Only
      </p>
      <div class="flex items-center justify-center ml-4 overflow-visible">
        <button
          id="toggle-console-btn"
          class="group hidden px-3 py-1 w-full bg-white dark:bg-black text-white hover:bg-gray-300 text-gray-800 rounded relative inline-flex items-center justify-center"
        >
          Console Logs
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="ml-1 h-4 w-4 text-gray-800"
            viewBox="0 0 20 20"
            fill="buttoncurrentColor"
          >
            <path
              fill-rule="evenodd"
              d="M18 10c0 4.418-3.582 8-8 8-4.418 0-8-3.582-8-8s3.582-8 8-8 8 3.582 8 8zm-9 4a1 1 0 112 0 1 1 0 01-2 0zm.75-7.001a.75.75 0 00-1.5 0v3.5a.75.75 0 001.5 0v-3.5z"
              clip-rule="evenodd"
            />
          </svg>
          <span
            class="absolute bottom-full mb-1 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs rounded py-1 px-2 shadow-lg whitespace-nowrap invisible opacity-0 group-hover:visible group-hover:opacity-100 transition-opacity duration-150 z-10"
          >
            This feature is experimental and may be buggy.
          </span>
        </button>
      </div>
      <!--  <span class="text-xs font-semibold text-green-500 text-center ml-2">{{ file_executed }}</span> -->

      <!-- Settings Drawer Backdrop & Panel -->
      <div
        id="settings-backdrop"
        class="fixed inset-0 bg-black/50 hidden z-40"
      ></div>
      <div
        id="settings-drawer"
        class="fixed inset-y-0 right-0 w-96 bg-white dark:bg-black text-white shadow-lg transform translate-x-full transition-transform duration-300 z-50 flex flex-col"
      >
        <div class="p-4 border-b flex items-center justify-between">
          <h2 class="text-lg font-semibold">Settings</h2>
          <button
            id="close-settings-btn"
            class="px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded"
          >
            &times;
          </button>
        </div>
        <form
          id="settings-form"
          class="flex-1 flex flex-col p-4 space-y-4 overflow-y-auto"
        >
          <div>
            <label
              for="custom-prompt"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Custom Instructions</label
            >
            <textarea
              id="custom-prompt"
              rows="5"
              class="w-full border border-gray-300 rounded p-2 text-sm"
              placeholder="Add custom instructions to the system prompt..."
            ></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Prompt Mode</label
            >
            <div class="flex items-center space-x-4">
              <label class="inline-flex items-center">
                <input
                  type="radio"
                  name="prompt-mode"
                  value="Append"
                  class="form-radio"
                  checked
                />
                <span class="ml-2">Append</span>
              </label>
              <label class="inline-flex items-center">
                <input
                  type="radio"
                  name="prompt-mode"
                  value="Override"
                  class="form-radio"
                />
                <span class="ml-2">Override</span>
              </label>
            </div>
          </div>

          <!-- Developer Settings Section -->
          <div
            id="developer-settings"
            class="mt-4 pt-4 border-t border-gray-200"
          >
            <h3 class="text-lg font-medium text-gray-900 mb-2">
              Developer Settings
            </h3>
            <p class="text-sm text-gray-500 mb-4">
              These settings are used in Developer Mode for evaluation.
            </p>

            <div class="mb-4">
              <label
                for="dev-temperature"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Temperature: <span id="temperature-value">0.3</span></label
              >
              <input
                type="range"
                id="dev-temperature"
                min="0"
                max="2"
                step="0.1"
                value="0.3"
                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
              />
              <div class="flex justify-between text-xs text-gray-500">
                <span>0.0</span>
                <span>1.0</span>
                <span>2.0</span>
              </div>
            </div>

            <div class="mb-4">
              <label
                for="dev-top-p"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Top P: <span id="top-p-value">1.0</span></label
              >
              <input
                type="range"
                id="dev-top-p"
                min="0"
                max="1"
                step="0.05"
                value="1.0"
                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
              />
              <div class="flex justify-between text-xs text-gray-500">
                <span>0.0</span>
                <span>0.5</span>
                <span>1.0</span>
              </div>
            </div>

            <div class="mb-4">
              <label
                for="dev-max-tokens"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Max Tokens:</label
              >
              <input
                type="number"
                id="dev-max-tokens"
                min="1"
                max="4000"
                value="1000"
                class="w-full border border-gray-300 rounded p-2 text-sm"
              />
              <div class="text-xs text-gray-500 mt-1">Range: 1-4000</div>
            </div>
          </div>
          <div class="flex space-x-2">
            <button
              type="submit"
              class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
            >
              Apply
            </button>
            <button
              type="button"
              id="reset-settings-btn"
              class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300"
            >
              Reset
            </button>
            <button
              type="button"
              id="restore-default-btn"
              class="px-4 py-2 bg-green-100 text-green-800 rounded hover:bg-green-200 border border-green-300"
            >
              Restore Default
            </button>
          </div>
          <div
            id="settings-status"
            class="hidden mt-2 flex items-center space-x-2 bg-green-100 border border-green-300 text-green-800 px-3 py-2 rounded text-sm"
          >
            <svg
              class="w-4 h-4 text-green-600"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M5 13l4 4L19 7"
              ></path>
            </svg>
            <span id="settings-status-text"></span>
          </div>
        </form>
      </div>
      <!-- Console Drawer Backdrop & Panel -->
      <div
        id="console-backdrop"
        class="fixed inset-0 bg-black/50 hidden z-40"
      ></div>
      <div
        id="console-drawer"
        class="fixed inset-y-0 right-0 w-80 bg-white dark:bg-black text-white shadow-lg transform translate-x-full transition-transform duration-300 z-50 flex flex-col"
      >
        <div class="p-4 border-b flex items-center justify-between">
          <h2 class="text-lg font-semibold">Console Logs</h2>
          <div class="flex items-center">
            <button
              id="clear-console-btn"
              class="px-2 py-1 bg-red-500 text-white rounded"
            >
              Clear Logs
            </button>
            <button
              id="close-console-btn"
              class="ml-2 px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded"
            >
              &times;
            </button>
          </div>
        </div>
        <div
          id="console-logs-content"
          class="flex-1 p-4 overflow-auto font-mono text-sm bg-gray-50"
        ></div>
      </div>
    </div>

    <!-- Configuration for unified developer evaluation module -->
    <script>
      // Configuration that can be externally modified
      window.unifiedDevEvalConfig = {
        enabled: true,
        apiEndpoints: {
          developer: "/api/dev_eval",
          batch: "/api/dev_eval_batch",
          compare: "/api/dev_eval_compare",
        },
        defaultParams: {
          temperature: 0.3,
          top_p: 1.0,
          max_tokens: 1000,
          runs: 1,
        },
        uiOptions: {
          showModeButtons: true,
          persistSettings: true,
          animateTransitions: true,
        },
      };
    </script>

    <!-- App Configuration -->
    <script>
      window.enableStreaming = {{ 'true' if enable_streaming else 'false' }};
    </script>

    <!-- Utility functions and base chat functionality -->
    <script>
      // --- Utility Functions ---
      function escapeHtml(unsafe) {
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function formatMessage(message) {
        try {
          // Pre-process special cases before passing to marked.js
          // Handle citation references [n] to make them clickable
          let processedMessage = message.replace(
            /\[(\d+)\]/g,
            '<a href="#source-$1" class="citation-link text-xs text-sky-500 dark:text-sky-400 hover:underline" data-source-id="$1">[$1]</a>',
          );

          // Use marked.js for standard markdown rendering
          let html = marked.parse(processedMessage, {
            gfm: true, // GitHub Flavored Markdown
            breaks: true, // Convert to <br>
            sanitize: false, // Don't sanitize HTML (we handle this elsewhere)
            smartLists: true, // Use smarter list behavior
            smartypants: true, // Use "smart" typographic punctuation
          });

          return html;
        } catch (error) {
          console.error("Error rendering markdown with marked.js:", error);

          // Fallback to basic formatting if marked.js fails
          message = message.replace(
            /(https?:\/\/[^\s]+)/g,
            '<a href="$1" target="_blank" class="text-blue-600 hover:underline">$1</a>',
          );
          // Convert **bold** to <strong>
          message = message.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
          // Convert *italic* to <em>
          message = message.replace(/\*(.*?)\*/g, "<em>$1</em>");
          // Convert newlines to <br>
          message = message.replace(/\\n/g, "<br>");
          // Convert citation references [n] to clickable links
          message = message.replace(
            /\[(\d+)\]/g,
            '<a href="#source-$1" class="citation-link text-xs text-sky-500 dark:text-sky-400 hover:underline" data-source-id="$1">[$1]</a>',
          );
          return message;
        }
      }

      // Update status badge from Draft to Verified
      function updateStatusToVerified(contentId) {
        const badge = document.getElementById(`status-badge-${contentId}`);
        if (badge && badge.classList.contains("status-draft")) {
          badge.innerHTML =
            '<i class="ph ph-shield-check" style="font-size: 1.1rem;"></i> Verified';
          badge.classList.remove("status-draft");
          badge.classList.add("status-verified");
        }
      }

      // --- DOM elements ---
      const chatMessages = document.getElementById("chat-messages");
      window.smartScroll.init(chatMessages);
      // START: Updated Input Logic
      // Prioritize the new input if it exists, fallback to legacy
      const newQueryInput = document.getElementById("new-query-input");
      // Legacy input no longer used
      // const legacyQueryInput = document.getElementById('query-input');
      const queryInput = newQueryInput;
      // END: Updated Input Logic
      const submitBtn = document.getElementById("submit-btn");
      // Auto-resize textarea up to 7 lines
      const maxLines = 7;
      const lineHeight =
        parseInt(window.getComputedStyle(queryInput).lineHeight) || 24;

      // Helper function to resize textarea and scroll to bottom
      function resizeAndScrollInput() {
        queryInput.style.height = "auto";
        const boundedHeight = Math.min(
          queryInput.scrollHeight,
          lineHeight * maxLines,
        );
        queryInput.style.height = boundedHeight + "px";
        queryInput.style.overflowY =
          queryInput.scrollHeight > lineHeight * maxLines ? "auto" : "hidden";
        // Scroll to bottom of textarea when it grows
        if (queryInput.scrollHeight > lineHeight * maxLines) {
          queryInput.scrollTop = queryInput.scrollHeight;
        }
      }

      queryInput.addEventListener("input", resizeAndScrollInput);

      // --- Chat functionality ---
      // Add user message to chat
      function addUserMessage(message) {
        // Hide center logo if visible
        const centerLogo = document.getElementById("center-logo");
        if (centerLogo && !centerLogo.classList.contains("hidden")) {
          centerLogo.classList.add("hidden");
        }

        // Create message element
        const messageDiv = document.createElement("div");
        messageDiv.className = "user-message";
        messageDiv.innerHTML = `
          <img class="w-8 h-8 rounded-full" src="https://content.tst-34.aws.agilent.com/wp-content/uploads/2025/05/Untitled-design-3.png" alt="AI Agent">
          <div class="flex flex-col items-end w-full max-w-[90%] leading-1.5">
            <div class="flex items-center space-x-2 rtl:space-x-reverse pr-1 pb-1">
              <span class="text-xs font-semibold text-gray-900 dark:text-white/80"><span class="mt-1 text-xs leading-tight font-medium text-blue-700 dark:text-white/80">ME</span></span>
            </div>
            <div class="text-md leading-7 font-normal py-2 text-gray-900 dark:text-white/80 space-y-4 message-bubble user-bubble bg-slate-100">
               ${formatMessage(message)}
            </div>  
          </div>
        `;

        // Add to chat
        chatMessages.appendChild(messageDiv);
        window.smartScroll.force(chatMessages);
      }

      // Initialize a streaming bot message and return the content container
      function initStreamingBotMessage() {
        // Hide center logo if visible
        const centerLogo = document.getElementById("center-logo");
        if (centerLogo && !centerLogo.classList.contains("hidden")) {
          centerLogo.classList.add("hidden");
        }

        // Create message element
        const messageDiv = document.createElement("div");
        messageDiv.className = "bot-message";

        const contentId = "bot-content-" + Date.now();

        // Capture persona at message creation time
        const persona = window.currentPersona || "none";
        const personaLabels = {
          explorer: "EXPLORER",
          intermediate: "STANDARD",
          balanced_plus: "BALANCED+",
          scientist: "SCIENTIST",
        };
        const personaBadgeHtml =
          persona !== "none" && personaLabels[persona]
            ? `<span class="persona-badge persona-${persona}">${personaLabels[persona]}</span>`
            : "";

        // Add Draft badge for Scientist persona
        let statusBadgeHtml = "";
        if (persona === "scientist") {
          statusBadgeHtml = `<span id="status-badge-${contentId}" class="status-badge status-draft">Draft</span>`;
        }

        messageDiv.innerHTML = `
          <img class="w-8 h-8 rounded-full" src="https://content.tst-34.aws.agilent.com/wp-content/uploads/2025/05/dalle.png" alt="AI Agent">
        <div class="flex flex-col w-auto max-w-[90%] leading-1.5">
          <div class="flex items-center space-x-2 rtl:space-x-reverse pl-1 pb-1">
            <span class="text-xs font-semibold text-gray-900 dark:text-white ">SAGE<span class="mt-1 text-xs leading-tight font-strong text-blue-700 dark:text-white/80"> AI Agent</span>${personaBadgeHtml}${statusBadgeHtml}</span>
          </div>
          <div id="${contentId}" class="text-md leading-7 font-normal py-2 text-gray-900 dark:text-white/80 space-y-4 message-bubble bot-bubble">
             <span class="animate-pulse">▌</span>
          </div>
          <!--
          <div class="flex items-center gap-2 pt-1 pl-6">
            <span class="text-xs font-normal text-gray-500 dark:text-white/60">Was this helpful?</span> --> 
          </div>
        </div>
      `;

        chatMessages.appendChild(messageDiv);
        window.smartScroll.force(chatMessages);

        // Show disclaimer after first message
        const disclaimer = document.getElementById("ai-disclaimer");
        if (disclaimer && disclaimer.classList.contains("hidden")) {
          disclaimer.classList.remove("hidden");
        }

        return document.getElementById(contentId);
      }

      // Handle streaming query submission
      async function submitStreamingQuery(query) {
        if (!query) return;

        // Log current persona for debugging
        const activePersona = window.currentPersona || "intermediate";
        console.log("[QUERY] ================================");
        console.log("[QUERY] Submitting query with persona:", activePersona);
        console.log(
          "[QUERY] Query:",
          query.substring(0, 100) + (query.length > 100 ? "..." : ""),
        );
        console.log("[QUERY] ================================");

        // Clear previous sources
        window.lastSources = null;

        addUserMessage(query);
        queryInput.value = "";
        queryInput.style.height = "auto";
        queryInput.style.height = lineHeight + "px"; // Restore lineHeight variable usage

        const typingIndicator = addTypingIndicator();

        try {
          const response = await fetch("/api/stream_query", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              query: query,
              persona: activePersona,
              reasoning_effort: window.currentReasoning || "medium",
              verbosity: window.currentVerbosity || "medium",
            }),
          });

          if (typingIndicator) removeTypingIndicator(typingIndicator);

          if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = "";
          const contentDiv = initStreamingBotMessage();

          // Scientist mode: Show "Verifying for accuracy" indicator while stream is in progress
          let verifyingIndicatorEl = null;
          if (activePersona === "scientist") {
            const indicatorId = "verifying-" + Date.now();
            const indicatorHtml = `
            <div id="${indicatorId}" class="verifying-indicator">
              <i class="ph ph-shield-check" style="font-size: 1.1rem;"></i>
              <span>Verifying for accuracy</span>
              <span class="verifying-dots"><span></span><span></span><span></span></span>
            </div>
          `;
            contentDiv.insertAdjacentHTML("afterend", indicatorHtml);
            verifyingIndicatorEl = document.getElementById(indicatorId);
          }

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value, { stream: true });
            buffer += chunk;

            const parts = buffer.split("[[META]]");

            // The first part is always the accumulated text
            let fullText = parts[0];

            // Process meta parts FIRST to extract renumber map before rendering
            let renumberMap = null;
            for (let i = 1; i < parts.length; i++) {
              try {
                const jsonStr = parts[i];
                if (jsonStr.trim()) {
                  const meta = JSON.parse(jsonStr);
                  if (meta.sources) {
                    window.lastSources = meta.sources;
                  }
                  if (
                    meta.renumber_citations &&
                    Object.keys(meta.renumber_citations).length > 0
                  ) {
                    renumberMap = meta.renumber_citations;
                  }
                  if (meta.context) {
                    window.lastContext = meta.context;
                  }
                  // RADAR correction: Replace streamed response with corrected version
                  if (meta.replace_response) {
                    console.log(
                      "RADAR correction applied:",
                      meta.failing_dimensions || [],
                    );
                    fullText = meta.replace_response;
                    // Update the buffer so final processing uses corrected text
                    parts[0] = meta.replace_response;
                    // Mark that RADAR already corrected this response (skip duplicate verification badge)
                    window.radarCorrectionAppliedThisMessage = true;
                    window._radarFailingDimensions =
                      meta.failing_dimensions || [];
                  }
                  if (meta.error) {
                    console.error("Stream error:", meta.error);
                  }
                  if (meta.query_id) {
                    window.lastQueryId = meta.query_id;
                  }
                }
              } catch (e) {
                // Ignore parsing errors for incomplete JSON chunks
              }
            }

            // Apply citation renumbering to raw text BEFORE formatMessage converts [N] to links
            if (renumberMap) {
              const sortedOldIds = Object.keys(renumberMap).sort(
                (a, b) => parseInt(b) - parseInt(a),
              );
              // Two-pass: old→placeholder→new to avoid collision
              for (const oldId of sortedOldIds) {
                const newId = renumberMap[oldId];
                const regex = new RegExp(`\\[${oldId}\\]`, "g");
                fullText = fullText.replace(regex, `[\x00${newId}\x00]`);
              }
              // Replace placeholders with final numbers
              fullText = fullText.replace(/\x00(\d+)\x00/g, "$1");
            }

            // Now render with correctly numbered citations
            contentDiv.innerHTML = formatMessage(fullText);

            window.smartScroll.smart(chatMessages);
          }

          // Remove verifying indicator before adding final badges
          if (verifyingIndicatorEl) {
            verifyingIndicatorEl.remove();
            verifyingIndicatorEl = null;
          }

          // Finalize: Add sources if available
          if (window.lastSources) {
            addSourcesUtilizedSection();
          }

          // Add feedback thumbs up/down buttons for streaming messages
          if (typeof window.addFeedbackToLastMessage === "function") {
            setTimeout(
              () => window.addFeedbackToLastMessage(window.lastQueryId),
              100,
            );
          }

          // === SCIENTIST PERSONA: Verification Badge + Status Shield ===
          // For Scientist persona, show async verification with visual shield indicator
          // Skip if RADAR already corrected this response during streaming
          const currentPersona = window.currentPersona || "intermediate";
          const radarAlreadyCorrected =
            window.radarCorrectionAppliedThisMessage;
          window.radarCorrectionAppliedThisMessage = false; // Reset for next message

          if (currentPersona === "scientist" && radarAlreadyCorrected) {
            // RADAR already corrected this response during streaming — show "Refined" badge
            const lastBotMessage = document.querySelector(
              ".bot-message:last-child .message-bubble",
            );
            if (lastBotMessage) {
              const radarBadgeId = "radar-badge-" + Date.now();
              const radarBadgeHtml = `
              <div id="${radarBadgeId}" class="verification-badge mt-3 flex items-center gap-2 text-sm px-3 py-1.5 rounded-lg bg-purple-50 dark:bg-purple-900/20">
                <div class="badge-icon">
                  <i class="ph ph-pencil-simple-line text-purple-600 dark:text-purple-400" style="font-size: 1.25rem;"></i>
                </div>
                <span class="badge-text text-purple-600 dark:text-purple-400 font-medium">Reviewed and refined for accuracy by SAGE Scientist</span>
              </div>
            `;
              lastBotMessage.insertAdjacentHTML("beforeend", radarBadgeHtml);

              // Update status badge to Verified
              updateStatusToVerified(contentDiv.id);
            }
          } else if (currentPersona === "scientist" && !radarAlreadyCorrected) {
            const lastBotMessage = document.querySelector(
              ".bot-message:last-child .message-bubble",
            );
            const lastBotMessageContainer = document.querySelector(
              ".bot-message:last-child",
            );

            if (lastBotMessage) {
              // Add verification badge container
              const badgeId = "verify-badge-" + Date.now();
              const verifyBadgeHtml = `
              <div id="${badgeId}" class="verification-badge mt-3 flex items-center gap-2 text-sm">
                <div class="badge-icon pulsing">
                  <svg class="w-5 h-5 text-amber-500 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                  </svg>
                </div>
                <span class="badge-text text-amber-500 font-medium">Verifying response...</span>
              </div>
            `;
              lastBotMessage.insertAdjacentHTML("beforeend", verifyBadgeHtml);

              // Show and animate the top-right status shield
              const shieldId = lastBotMessageContainer?.dataset?.shieldId;
              if (shieldId) {
                const shield = document.getElementById(shieldId);
                if (shield) {
                  shield.classList.remove("hidden");
                  shield.classList.add("verifying");
                  shield.title = "Verifying...";
                }
              }

              // Store query and response for potential auto-correction
              window.lastUserQuery = query;
              window.lastBotResponse = contentDiv.textContent;
              window.currentShieldId = shieldId; // Store for correction logic

              // Run async groundedness check
              runAsyncVerification(
                window.lastQueryId,
                query,
                contentDiv.textContent,
                badgeId,
                shieldId,
                contentDiv.id,
              );
            }
          }
        } catch (error) {
          if (typingIndicator) removeTypingIndicator(typingIndicator);
          addBotMessage("Error: " + error.message);
          console.error("Streaming error:", error);
        }
      }

      // Async verification for Scientist persona
      async function runAsyncVerification(
        queryID,
        query,
        answerText,
        badgeId,
        shieldId,
        contentId,
      ) {
        // Helper function to update shield state
        function updateShield(state, title) {
          if (!shieldId) return;
          const shield = document.getElementById(shieldId);
          if (!shield) return;

          // Remove all state classes
          shield.classList.remove(
            "verifying",
            "refining",
            "passed",
            "refined",
            "failed",
            "hidden",
          );

          // Set new state
          shield.classList.add(state);
          shield.title = title;

          // Update SVG based on state
          if (state === "passed" || state === "refined") {
            // Check mark inside shield
            shield.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M9 12l2 2 4-4" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
          } else if (state === "failed") {
            // Exclamation inside shield
            shield.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M12 8v4M12 16h.01" fill="none" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>`;
          } else if (state === "refining") {
            // Spinning circle
            shield.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" stroke-dasharray="31.4 31.4" stroke-dashoffset="0"/></svg>`;
          }
        }

        try {
          const response = await fetch("/api/verify_groundedness", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              query: query,
              answer: answerText,
              context: window.lastContext || "",
              query_id: queryID,
            }),
          });

          if (!response.ok) {
            throw new Error("Verification request failed");
          }

          const result = await response.json();
          const badge = document.getElementById(badgeId);

          if (badge) {
            const score = result.score || 0;
            const grounded = result.grounded !== false; // Default to true if undefined

            // Determine verdict color and text based on score thresholds
            // ≥90%: Green - Verified accurate
            // 80-89%: Purple - Mostly grounded (no rewrite)
            // 70-79%: Yellow - Partially grounded (triggers rewrite)
            // <70%: Red - Contains hallucination (triggers rewrite)
            let verdictColor, verdictBg, verdictText, verdictIcon, needsRewrite;

            if (score >= 0.9) {
              // GREEN: Verified - fully accurate
              verdictColor = "text-green-600 dark:text-green-400";
              verdictBg = "bg-green-50 dark:bg-green-900/20";
              verdictText = "Verified";
              verdictIcon = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>`;
              needsRewrite = false;
            } else if (score >= 0.8) {
              // PURPLE: Mostly grounded - may contain generalizations but acceptable
              verdictColor = "text-purple-600 dark:text-purple-400";
              verdictBg = "bg-purple-50 dark:bg-purple-900/20";
              verdictText = "Mostly verified";
              verdictIcon = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>`;
              needsRewrite = false; // Correction loop disabled
            } else if (score >= 0.7) {
              // YELLOW: Partially grounded - may contain fabricated content
              verdictColor = "text-yellow-600 dark:text-yellow-500";
              verdictBg = "bg-yellow-50 dark:bg-yellow-900/20";
              verdictText = "May contain fabricated content";
              verdictIcon = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>`;
              needsRewrite = false; // Correction loop disabled
            } else {
              // RED: Contains fabricated content
              verdictColor = "text-red-600 dark:text-red-400";
              verdictBg = "bg-red-50 dark:bg-red-900/20";
              verdictText = "Contains fabricated content";
              verdictIcon = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>`;
              needsRewrite = false; // Correction loop disabled
            }

            // Update badge with verdict
            badge.className = `verification-badge mt-3 flex items-center gap-2 text-sm px-3 py-1.5 rounded-lg ${verdictBg}`;
            badge.innerHTML = `
            <div class="badge-icon">
              <svg class="w-5 h-5 ${verdictColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                ${verdictIcon}
              </svg>
            </div>
            <span class="badge-text ${verdictColor} font-medium">${verdictText}</span>
            <span class="text-xs text-gray-500 dark:text-gray-400">(${Math.round(score * 100)}% confidence)</span>
          `;

            // Update status shield based on grounded status
            // Green = passed without needing correction
            // Red = failed (will be updated to refining/refined if correction is triggered for Scientist)
            if (grounded) {
              updateShield("passed", "Verified ✓");
            } else {
              // Show failed state immediately - will be updated if auto-correction kicks in
              updateShield("failed", "Needs verification");
            }

            // Render detailed report if issues found
            if (badge.parentNode) {
              const reportId = badge.id + "-report";
              const existingReport = document.getElementById(reportId);
              if (existingReport) existingReport.remove();

              let detailsHtml = "";

              // Add Unsupported Claims with Verdict - LOGGING ONLY (Hidden from UI)
              if (
                result.unsupported_claims &&
                result.unsupported_claims.length > 0
              ) {
                // Log to debug logger instead of displaying in UI
                result.unsupported_claims.forEach((claim, idx) => {
                  const text =
                    typeof claim === "string"
                      ? claim
                      : claim.claim || JSON.stringify(claim);
                  const supportLevel = claim.support_level || "none";
                  let verdict = "Unsupported";
                  if (supportLevel === "partial")
                    verdict = "Partially Supported";
                  else if (supportLevel === "inferred") verdict = "Inferred";

                  if (window.debugLogger) {
                    window.debugLogger.log(
                      `Claim Analysis: ${text}`,
                      "verification",
                      {
                        claim: text,
                        verdict: verdict,
                        severity: claim.severity,
                        fix: claim.recommendation,
                      },
                    );
                  } else {
                    console.log(`[Claim Analysis] ${text} (${verdict})`, claim);
                  }
                });
              }

              // Recommendations display removed as per user request

              // AUTO-CORRECTION: Trigger for Scientist persona when score < 80% (needsRewrite = true)
              // This means Yellow (70-79%) and Red (<70%) responses will be rewritten
              const currentPersona = window.currentPersona || "intermediate";
              if (
                needsRewrite &&
                currentPersona === "scientist" &&
                result.unsupported_claims &&
                result.unsupported_claims.length > 0
              ) {
                console.log(
                  `[CORRECTION] Score ${Math.round(score * 100)}% < 80% for Scientist - triggering auto-correction`,
                );

                // Update status shield to refining (yellow spinning)
                updateShield("refining", "Refining response...");

                // IMMEDIATELY update badge to show correction in progress
                badge.className =
                  "verification-badge mt-3 flex items-center gap-2 text-sm px-3 py-1.5 rounded-lg bg-blue-100 dark:bg-blue-900/40 animate-pulse";
                badge.innerHTML = `
                <div class="badge-icon">
                  <svg class="w-5 h-5 text-blue-600 dark:text-blue-400 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                </div>
                <span class="badge-text text-blue-600 dark:text-blue-400 font-medium">SAGE is refining response...</span>
              `;

                // Find message container and bubble
                const messageContainer = badge.closest(".bot-message");
                const messageBubble = messageContainer
                  ? messageContainer.querySelector(".message-bubble")
                  : null;

                // Call correction API with sources for renumbering
                fetch("/api/correct_response", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    query: window.lastUserQuery || "",
                    draft: window.lastBotResponse || "",
                    context: window.lastContext || "",
                    evaluation: result,
                    sources: window.lastSources || [], // Pass original sources for renumbering
                  }),
                })
                  .then((resp) => resp.json())
                  .then((correctionResult) => {
                    console.log("[CORRECTION] Got result:", correctionResult);

                    if (
                      correctionResult.was_corrected &&
                      correctionResult.corrected_response
                    ) {
                      console.log("[CORRECTION] Applying corrected response");

                      // Update global sources with renumbered sources from correction
                      if (
                        correctionResult.sources &&
                        correctionResult.sources.length > 0
                      ) {
                        window.lastSources = correctionResult.sources;
                        console.log(
                          "[CORRECTION] Updated window.lastSources:",
                          correctionResult.sources.length,
                          "sources",
                        );
                      }

                      // Update the message content
                      if (messageBubble) {
                        // Remove badge from DOM temporarily (it's inside messageBubble)
                        const badgeElement = document.getElementById(badgeId);
                        if (badgeElement) badgeElement.remove();

                        // Remove old sources section - we'll regenerate it with updated sources
                        const oldSourcesSection =
                          messageBubble.querySelector(".sources-section");
                        if (oldSourcesSection) oldSourcesSection.remove();

                        // Update message content with corrected response
                        messageBubble.innerHTML = formatMessage(
                          correctionResult.corrected_response,
                        );

                        // Regenerate sources section with updated/renumbered sources
                        if (
                          window.lastSources &&
                          window.lastSources.length > 0
                        ) {
                          const newSourcesHtml = window.generateSourcesHtml
                            ? window.generateSourcesHtml(window.lastSources)
                            : generateSourcesHtmlFallback(window.lastSources);
                          messageBubble.insertAdjacentHTML(
                            "beforeend",
                            newSourcesHtml,
                          );

                          // Re-attach click handlers for new citation links in sources section
                          setTimeout(() => {
                            const newCitationLinks =
                              messageBubble.querySelectorAll(
                                ".sources-section .citation-link",
                              );
                            newCitationLinks.forEach((link) => {
                              link.addEventListener("click", function (e) {
                                e.preventDefault();
                                if (window.dynamicContainer) {
                                  window.dynamicContainer.handleCitationClick(
                                    this,
                                  );
                                } else if (window.handleCitationClick) {
                                  window.handleCitationClick(
                                    this.getAttribute("data-source-id"),
                                  );
                                }
                              });
                            });
                          }, 100);
                        }

                        // Re-add badge at the end of the message bubble
                        if (badgeElement)
                          messageBubble.appendChild(badgeElement);
                      }

                      // Update badge to final "Rewritten for accuracy\" state
                      // Use purple to indicate systematic refinement by scientist
                      badge.className =
                        "verification-badge mt-3 flex items-center gap-2 text-sm px-3 py-1.5 rounded-lg bg-purple-50 dark:bg-purple-900/20";
                      badge.innerHTML = `
                      <div class="badge-icon">
                        <i class="ph ph-pencil-simple-line text-purple-600 dark:text-purple-400" style="font-size: 1.25rem;"></i>
                      </div>
                      <span class="badge-text text-purple-600 dark:text-purple-400 font-medium">Reviewed and refined for accuracy by SAGE Scientist</span>
                      <span class="text-xs text-gray-500 dark:text-gray-400">(verified after correction)</span>
                    `;

                      // Remove the old report showing issues
                      const oldReport = document.getElementById(reportId);
                      if (oldReport) oldReport.remove();

                      // Update status shield to refined (yellow check)
                      updateShield("refined", "Refined ✓");
                    } else {
                      console.log(
                        "[CORRECTION] No correction made:",
                        correctionResult.note || "unchanged",
                      );
                      // Revert badge to show warning - correction was attempted but couldn't fix
                      badge.className =
                        "verification-badge mt-3 flex items-center gap-2 text-sm px-3 py-1.5 rounded-lg bg-red-50 dark:bg-red-900/20";
                      badge.innerHTML = `
                      <div class="badge-icon">
                        <svg class="w-5 h-5 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                      </div>
                      <span class="badge-text text-red-600 dark:text-red-400 font-medium">Could not fully verify — please review manually</span>
                    `;

                      // Update status shield to failed (red)
                      updateShield("failed", "Needs review");
                    }
                  })
                  .catch((err) => {
                    console.error("[CORRECTION] API call failed:", err);
                    // Show error state
                    badge.className =
                      "verification-badge mt-3 flex items-center gap-2 text-sm px-3 py-1.5 rounded-lg bg-red-50 dark:bg-red-900/20";
                    badge.innerHTML = `
                    <div class="badge-icon">
                      <svg class="w-5 h-5 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                      </svg>
                    </div>
                    <span class="badge-text text-red-600 dark:text-red-400 font-medium">Correction failed</span>
                  `;

                    // Update status shield to failed (red)
                    updateShield("failed", "Correction failed");
                  });
              }
            }
          }

          // Complete: Update status badge to Verified
          if (contentId) {
            updateStatusToVerified(contentId);
          }
        } catch (error) {
          console.error("Verification failed:", error);
          const badge = document.getElementById(badgeId);
          if (badge) {
            badge.className =
              "verification-badge mt-3 flex items-center gap-2 text-sm px-3 py-1.5 rounded-lg bg-gray-50 dark:bg-gray-800/10";
            badge.innerHTML = `
            <div class="badge-icon">
              <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
              </svg>
            </div>
            <span class="badge-text text-gray-500 font-medium italic">Verification status hidden</span>
          `;
          }
        }
      }

      // Add bot message to chat
      function addBotMessage(message) {
        // Hide center logo if visible
        const centerLogo = document.getElementById("center-logo");
        if (centerLogo && !centerLogo.classList.contains("hidden")) {
          centerLogo.classList.add("hidden");
        }

        // Generate unique ID for this message's shield
        const shieldId = "shield-" + Date.now();
        const isScientist =
          (window.currentPersona || "intermediate") === "scientist";

        // Create message element
        const messageDiv = document.createElement("div");
        messageDiv.className = "bot-message";
        // Build persona badge for this message
        const personaLabels = {
          explorer: "EXPLORER",
          intermediate: "STANDARD",
          balanced_plus: "BALANCED+",
          scientist: "SCIENTIST",
        };
        const activeP = window.currentPersona || "none";
        const badgeHtml =
          activeP !== "none" && personaLabels[activeP]
            ? `<span class="persona-badge persona-${activeP}">${personaLabels[activeP]}</span>`
            : "";

        messageDiv.innerHTML = `
          <img class="w-8 h-8 rounded-full" src="https://content.tst-34.aws.agilent.com/wp-content/uploads/2025/05/dalle.png" alt="AI Agent">
        <div class="flex flex-col w-auto max-w-[90%] leading-1.5 relative">
          <div class="flex items-center space-x-2 rtl:space-x-reverse pl-1 pb-1">
            <span class="text-xs font-semibold text-gray-900 dark:text-white ">SAGE<span class="mt-1 text-xs leading-tight font-strong text-blue-700 dark:text-white/80"> AI Agent</span>${badgeHtml}</span>
          </div>
          <div class="text-md leading-7 font-normal py-2 text-gray-900 dark:text-white/80 space-y-4 message-bubble bot-bubble">
             ${formatMessage(message)}
          </div>
          <!-- Status Shield (Scientist persona only) -->
          <div id="${shieldId}" class="status-shield ${isScientist ? "" : "hidden"}" title="Verification status">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            </svg>
          </div>
        </div>
      `;

        // Store shield ID for later reference
        messageDiv.dataset.shieldId = shieldId;

        // Add to chat
        chatMessages.appendChild(messageDiv);
        window.smartScroll.force(chatMessages);

        // Show disclaimer after first message
        const disclaimer = document.getElementById("ai-disclaimer");
        if (disclaimer && disclaimer.classList.contains("hidden")) {
          disclaimer.classList.remove("hidden");
        }
      }

      // Add typing indicator with dynamic step messages
      function addTypingIndicator() {
        const indicatorDiv = document.createElement("div");
        indicatorDiv.className = "bot-message";
        indicatorDiv.innerHTML = `
        <img class="avatar" src="https://content.tst-34.aws.agilent.com/wp-content/uploads/2025/05/dalle.png" alt="AI">
        <div class="typing-status-text" style="font-size: 14px; color: #6b7280; font-style: italic; min-height: 24px;"></div>
      `;

        chatMessages.appendChild(indicatorDiv);
        window.smartScroll.force(chatMessages);

        // Dynamic step messages with smooth fade + slide effect
        const steps = [
          "Understanding your query...",
          "Searching knowledge base...",
          "Analyzing relevant documents...",
          "Refining response...",
        ];

        // Extended messages for longer waits (after showing "Refining response..." 3 times)
        const extendedSteps = [
          "Still working...",
          "Almost there...",
          "Hang tight...",
          "Finalizing...",
        ];

        let stepIndex = 0;
        let refiningCount = 0; // Track how many times we've shown "Refining response..."
        let extendedIndex = 0; // Track position in extended messages
        const statusEl = indicatorDiv.querySelector(".typing-status-text");
        let stepTimeout = null;

        // Add smooth transition styles to the status element
        if (statusEl) {
          statusEl.style.transition =
            "opacity 0.3s ease-out, transform 0.3s ease-out";
          statusEl.style.display = "inline-block";
        }

        // Smooth fade + slide animation function
        function animateText(text, onComplete) {
          if (!statusEl) return;

          // Fade out current text
          statusEl.style.opacity = "0";
          statusEl.style.transform = "translateY(4px)";

          setTimeout(() => {
            // Update text and fade in with slide up
            statusEl.textContent = text;
            statusEl.style.opacity = "1";
            statusEl.style.transform = "translateY(0)";

            // Call completion callback after display duration
            if (onComplete) {
              stepTimeout = setTimeout(onComplete, 1800); // Show each step for 1.8s
            }
          }, 300); // Wait for fade-out to complete
        }

        // Start cycling through messages
        function nextStep() {
          let currentMessage;

          if (stepIndex < steps.length - 1) {
            // Initial steps: Understanding, Searching, Analyzing
            currentMessage = steps[stepIndex];
            stepIndex++;
          } else {
            // At the "Refining response..." stage
            refiningCount++;

            if (refiningCount <= 3) {
              // First 3 times: show "Refining response..."
              currentMessage = steps[steps.length - 1];
            } else {
              // After 3 times: cycle through extended messages
              currentMessage =
                extendedSteps[extendedIndex % extendedSteps.length];
              extendedIndex++;
            }
          }

          animateText(currentMessage, () => {
            nextStep();
          });
        }
        nextStep();

        // Store timeout reference for cleanup
        indicatorDiv.cleanup = () => {
          if (stepTimeout) clearTimeout(stepTimeout);
        };

        return indicatorDiv;
      }

      // Helper to clean up typing indicator interval
      function removeTypingIndicator(indicator) {
        if (indicator) {
          if (indicator.cleanup) indicator.cleanup();
          if (indicator.stepInterval) clearInterval(indicator.stepInterval);
          indicator.remove();
        }
      }

      // Basic input handling
      if (queryInput && submitBtn) {
        // Enable submit button on input
        queryInput.addEventListener("keydown", function (e) {
          submitBtn.disabled = false;
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            submitBtn.click();
          }
        });

        // Submit button click handler (will be overridden by unifiedDevEval.js if enabled)
        submitBtn.addEventListener("click", function () {
          // This will be replaced by the unified module's handler
          // but serves as a fallback if the module fails to load
          submitQuery();
        });
      }

      // Standard query submission (will be overridden by unifiedDevEval.js)
      function submitQuery() {
        const query = queryInput.value.trim();
        if (!query) return;

        // Check if streaming is enabled
        if (window.enableStreaming) {
          submitStreamingQuery(query);
          return;
        }

        addUserMessage(query);
        queryInput.value = "";

        // Reset textarea height to 1 line after sending
        queryInput.style.height = "auto";
        queryInput.style.height = lineHeight;

        // Show typing indicator
        const typingIndicator = addTypingIndicator();

        const activePersona = window.currentPersona || "intermediate";
        // Call API to get response
        fetch("/api/query", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query: query, persona: activePersona, reasoning_effort: window.currentReasoning || "medium", verbosity: window.currentVerbosity || "medium" }),
        })
          .then((response) => response.json())
          .then((data) => {
            // Remove typing indicator
            if (typingIndicator) removeTypingIndicator(typingIndicator);

            // Show response
            if (data.error) {
              addBotMessage("Error: " + data.error);
            } else {
              addBotMessage(data.answer);

              // Show sources if available
              if (data.sources && data.sources.length > 0) {
                // Store last sources for citation click handling
                window.lastSources = data.sources;
                // Add sources utilized section
                addSourcesUtilizedSection();
              }
            }
          })
          .catch((error) => {
            // Remove typing indicator
            if (typingIndicator) removeTypingIndicator(typingIndicator);

            // Show error
            addBotMessage(
              "Error: Could not connect to server. Please try again later.",
            );
            console.error("Error:", error);
          });
      }

      // Settings drawer functionality
      const settingsBtn = document.getElementById("toggle-settings-btn");
      const settingsDrawer = document.getElementById("settings-drawer");
      const settingsBackdrop = document.getElementById("settings-backdrop");
      const closeSettingsBtn = document.getElementById("close-settings-btn");

      if (
        settingsBtn &&
        settingsDrawer &&
        settingsBackdrop &&
        closeSettingsBtn
      ) {
        // Open settings drawer
        settingsBtn.addEventListener("click", function (e) {
          e.preventDefault();
          settingsDrawer.classList.remove("translate-x-full");
          settingsBackdrop.classList.remove("hidden");
          document.body.classList.add("settings-open");
        });

        // Close settings drawer
        function closeSettingsDrawer() {
          settingsDrawer.classList.add("translate-x-full");
          settingsBackdrop.classList.add("hidden");
          document.body.classList.remove("settings-open");
        }

        closeSettingsBtn.addEventListener("click", closeSettingsDrawer);
        settingsBackdrop.addEventListener("click", closeSettingsDrawer);
      }

      // Console drawer functionality
      const consoleBtn = document.getElementById("toggle-console-btn");
      const consoleDrawer = document.getElementById("console-drawer");
      const consoleBackdrop = document.getElementById("console-backdrop");
      const closeConsoleBtn = document.getElementById("close-console-btn");
      const clearConsoleBtn = document.getElementById("clear-console-btn");
      const consoleLogsContent = document.getElementById(
        "console-logs-content",
      );

      if (consoleBtn && consoleDrawer && consoleBackdrop && closeConsoleBtn) {
        // Open console drawer
        consoleBtn.addEventListener("click", function () {
          consoleDrawer.classList.remove("translate-x-full");
          consoleBackdrop.classList.remove("hidden");
          document.body.classList.add("console-open");
        });

        // Close console drawer
        function closeConsoleDrawer() {
          consoleDrawer.classList.add("translate-x-full");
          consoleBackdrop.classList.add("hidden");
          document.body.classList.remove("console-open");
        }

        closeConsoleBtn.addEventListener("click", closeConsoleDrawer);
        consoleBackdrop.addEventListener("click", closeConsoleDrawer);

        // Clear console logs
        if (clearConsoleBtn && consoleLogsContent) {
          clearConsoleBtn.addEventListener("click", function () {
            consoleLogsContent.innerHTML = "";
          });
        }
      }

      // Function to open console drawer (used by unifiedDevEval.js)
      function openDrawer() {
        if (consoleDrawer && consoleBackdrop) {
          consoleDrawer.classList.remove("translate-x-full");
          consoleBackdrop.classList.remove("hidden");
          document.body.classList.add("console-open");
        }
      }

      // Add sources utilized section function
      function addSourcesUtilizedSection() {
        if (window.lastSources && window.lastSources.length > 0) {
          let sourcesHtml =
            '<div class="sources-section mt-4 pt-3 border-t border-gray-200 dark:border-gray-700">';
          sourcesHtml +=
            '<h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Sources Utilized</h4>';
          sourcesHtml +=
            '<ol class="text-sm text-gray-600 dark:text-gray-400 space-y-1 pl-4">';

          window.lastSources.forEach((source, index) => {
            let sourceTitle = "Untitled Source";

            if (typeof source === "string") {
              // If source is just a string, use it as the title (truncated)
              sourceTitle =
                source.length > 80 ? source.substring(0, 80) + "..." : source;
            } else if (typeof source === "object" && source !== null) {
              // If source is an object, try to get title, otherwise use content or fallback
              sourceTitle =
                source.title ||
                (source.content
                  ? source.content.length > 80
                    ? source.content.substring(0, 80) + "..."
                    : source.content
                  : `Source ${index + 1}`);
            }

            // Escape HTML in the title to prevent XSS
            sourceTitle = escapeHtml(sourceTitle);

            // Make the source title clickable with the same functionality as inline citations
            sourcesHtml += `<li><a href="#source-${index + 1}" class="citation-link text-sky-500 dark:text-sky-400 hover:underline cursor-pointer" data-source-id="${index + 1}">${sourceTitle}</a></li>`;
          });

          sourcesHtml += "</ol>";
          sourcesHtml += "</div>";

          // Append to the last bot message
          const lastBotMessage = document.querySelector(
            ".bot-message:last-child .message-bubble",
          );
          if (lastBotMessage) {
            // Remove existing sources section to prevent duplicates
            const existingSection =
              lastBotMessage.querySelector(".sources-section");
            if (existingSection) {
              existingSection.remove();
            }
            lastBotMessage.innerHTML += sourcesHtml;

            // Add click event listeners for the new citation links
            // This ensures the newly added links work with the existing citation functionality
            setTimeout(() => {
              const newCitationLinks =
                lastBotMessage.querySelectorAll(".citation-link");
              newCitationLinks.forEach((link) => {
                link.addEventListener("click", function (e) {
                  e.preventDefault();
                  const sourceId = this.getAttribute("data-source-id");

                  // Trigger the same behavior as inline citations
                  // This will scroll to and highlight the source in the sidebar
                  if (window.handleCitationClick) {
                    window.handleCitationClick(sourceId);
                  } else {
                    // Fallback: try to find and scroll to the source element
                    const sourceElement = document.getElementById(
                      `source-${sourceId}`,
                    );
                    if (sourceElement) {
                      sourceElement.scrollIntoView({ behavior: "smooth" });
                      sourceElement.classList.add("bg-yellow-100");
                      setTimeout(() => {
                        sourceElement.classList.remove("bg-yellow-100");
                      }, 2000);
                    }
                  }
                });
              });
            }, 100);
          }
        }
      }

      // Generate sources HTML section (used after correction to regenerate with renumbered sources)
      function generateSourcesHtml(sources) {
        if (!sources || sources.length === 0) return "";

        let html =
          '<div class="sources-section mt-4 pt-3 border-t border-gray-200 dark:border-gray-700">';
        html +=
          '<h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Sources Utilized</h4>';
        html +=
          '<ol class="text-sm text-gray-600 dark:text-gray-400 space-y-1 pl-4">';

        sources.forEach((source, index) => {
          let sourceTitle = "Untitled Source";

          if (typeof source === "string") {
            sourceTitle =
              source.length > 80 ? source.substring(0, 80) + "..." : source;
          } else if (typeof source === "object" && source !== null) {
            sourceTitle =
              source.title ||
              (source.content
                ? source.content.length > 80
                  ? source.content.substring(0, 80) + "..."
                  : source.content
                : `Source ${index + 1}`);
          }

          // Escape HTML to prevent XSS
          sourceTitle = escapeHtml(sourceTitle);

          html += `<li><a href="#source-${index + 1}" class="citation-link text-sky-500 dark:text-sky-400 hover:underline cursor-pointer" data-source-id="${index + 1}">${sourceTitle}</a></li>`;
        });

        html += "</ol></div>";
        return html;
      }

      // Fallback function in case window.generateSourcesHtml is not set
      function generateSourcesHtmlFallback(sources) {
        return generateSourcesHtml(sources);
      }

      // Expose globally for correction flow
      window.generateSourcesHtml = generateSourcesHtml;

      // Desktop Status Helpers
      window.desktopStatusHelpers = {
        show: function (type, message) {
          const indicator = document.getElementById("desktop-status-indicator");
          const text = document.getElementById("desktop-status-text");
          if (!indicator || !text) return;

          indicator.className = "desktop-status show " + type;
          text.textContent = message;

          // Update icon based on type
          const icon = indicator.querySelector("i");
          if (icon) {
            if (type === "success") {
              icon.className = "fa-solid fa-check";
            } else {
              icon.className = "fa-solid fa-spinner fa-spin";
            }
          }
        },
        hide: function () {
          const indicator = document.getElementById("desktop-status-indicator");
          if (indicator) {
            indicator.classList.remove("show");
          }
        },
        success: function (message) {
          this.show("success", message);
          setTimeout(() => this.hide(), 2000);
        },
      };

      // Magic button 2XL click handler (Enhanced / Detailed Prompt)
      // Targets the new button ID inside the magic pill
      const magicBtn2xl = document.getElementById("magic-btn-2xl");
      if (magicBtn2xl) {
        magicBtn2xl.addEventListener("click", function () {
          const text = queryInput.value.trim();
          if (!text) {
            // Visual shake or indication that input is needed?
            queryInput.focus();
            return;
          }

          // Close Tools popover if open
          const toolsPopover = document.getElementById("settings-popover");
          if (toolsPopover) {
            toolsPopover.classList.add("hidden");
            toolsPopover.classList.remove("active");
          }

          magicBtn2xl.disabled = true;
          const origIcon = magicBtn2xl.innerHTML;
          // Visual feedback: Spin icon
          magicBtn2xl.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

          // Show desktop status
          window.desktopStatusHelpers.show(
            "processing",
            "Creating detailed prompt...",
          );

          // Add processing state to search box
          const searchBox = document.querySelector(".sage-search-box");
          if (searchBox) {
            searchBox.classList.add(
              "ring-2",
              "ring-purple-400",
              "ring-opacity-50",
            );
            searchBox.style.boxShadow = "0 0 20px rgba(139, 92, 246, 0.4)";
          }

          fetch("/api/magic_query_2xl", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ input_text: text }),
          })
            .then((res) => {
              if (!res.ok) throw new Error("API Error");
              return res.json();
            })
            .then((data) => {
              if (data.output) {
                queryInput.value = data.output;
                // Trigger input event to resize/refresh UI
                queryInput.dispatchEvent(new Event("input"));
                // Scroll textarea to bottom to show end of replaced text
                queryInput.scrollTop = queryInput.scrollHeight;
                queryInput.focus();

                // Success visual feedback
                magicBtn2xl.innerHTML =
                  '<i class="fa-solid fa-check text-green-500"></i>';
                if (searchBox) {
                  searchBox.classList.remove("ring-purple-400");
                  searchBox.classList.add("ring-green-400");
                }

                // Show success status
                window.desktopStatusHelpers.success("Prompt created!");

                setTimeout(() => {
                  magicBtn2xl.innerHTML = origIcon;
                  if (searchBox) {
                    searchBox.classList.remove(
                      "ring-2",
                      "ring-green-400",
                      "ring-opacity-50",
                    );
                    searchBox.style.boxShadow = "";
                  }
                }, 1500);
              }
            })
            .catch((err) => {
              console.error(err);
              magicBtn2xl.innerHTML =
                '<i class="fa-solid fa-exclamation-triangle text-red-500"></i>';
              setTimeout(() => (magicBtn2xl.innerHTML = origIcon), 2000);
              if (searchBox) {
                searchBox.classList.remove(
                  "ring-2",
                  "ring-purple-400",
                  "ring-opacity-50",
                );
                searchBox.style.boxShadow = "";
              }
              window.desktopStatusHelpers.hide();
            })
            .finally(() => {
              magicBtn2xl.disabled = false;
            });
        });
      }

      // Magic button (Standard Enhance) click handler
      const magicBtn = document.getElementById("magic-btn");
      if (magicBtn) {
        magicBtn.addEventListener("click", function () {
          const text = queryInput.value.trim();
          if (!text) {
            queryInput.focus();
            return;
          }

          // Close Tools popover if open
          const toolsPopover = document.getElementById("settings-popover");
          if (toolsPopover) {
            toolsPopover.classList.add("hidden");
            toolsPopover.classList.remove("active");
          }

          magicBtn.disabled = true;
          const origIcon = magicBtn.innerHTML;
          magicBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

          // Show desktop status
          window.desktopStatusHelpers.show("enhancing", "Enhancing query...");

          // Add processing state to search box
          const searchBox = document.querySelector(".sage-search-box");
          if (searchBox) {
            searchBox.classList.add(
              "ring-2",
              "ring-blue-400",
              "ring-opacity-50",
            );
            searchBox.style.boxShadow = "0 0 20px rgba(59, 130, 246, 0.4)";
          }

          fetch("/api/magic_query", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ input_text: text }),
          })
            .then((res) => {
              if (!res.ok) throw new Error("API Error");
              return res.json();
            })
            .then((data) => {
              if (data.output) {
                queryInput.value = data.output;
                queryInput.dispatchEvent(new Event("input"));
                // Scroll textarea to bottom to show end of replaced text
                queryInput.scrollTop = queryInput.scrollHeight;
                queryInput.focus();

                // Success visual feedback
                magicBtn.innerHTML =
                  '<i class="fa-solid fa-check text-green-500"></i>';
                if (searchBox) {
                  searchBox.classList.remove("ring-blue-400");
                  searchBox.classList.add("ring-green-400");
                  searchBox.style.boxShadow = "0 0 20px rgba(34, 197, 94, 0.4)";
                }

                // Show success status
                window.desktopStatusHelpers.success("Query enhanced!");

                setTimeout(() => {
                  magicBtn.innerHTML = origIcon;
                  if (searchBox) {
                    searchBox.classList.remove(
                      "ring-2",
                      "ring-green-400",
                      "ring-opacity-50",
                    );
                    searchBox.style.boxShadow = "";
                  }
                }, 1500);
              }
            })
            .catch((err) => {
              console.error("Magic Enhance Error:", err);
              // Fallback/Error state
              magicBtn.innerHTML =
                '<i class="fa-solid fa-exclamation-triangle text-red-500"></i>';
              if (searchBox) {
                searchBox.classList.remove(
                  "ring-2",
                  "ring-blue-400",
                  "ring-opacity-50",
                );
                searchBox.style.boxShadow = "";
              }
              window.desktopStatusHelpers.hide();
              setTimeout(() => (magicBtn.innerHTML = origIcon), 2000);
            })
            .finally(() => {
              magicBtn.disabled = false;
            });
        });
      }

      // ========== Voice Input / Transcription ==========
      let mediaRecorder = null;
      let audioChunks = [];
      window.isRecording = false;

      const voiceBtn = document.getElementById("voice-btn");
      if (voiceBtn) {
        voiceBtn.addEventListener("click", function () {
          if (!window.isRecording) {
            startRecording();
          } else {
            stopRecording();
          }
        });
      }

      async function startRecording() {
        try {
          // Request microphone permission
          // Removed sampleRate: 44100 to allow device default (better for mobile)
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: {
              echoCancellation: true,
              noiseSuppression: true,
            },
          });

          // Create MediaRecorder
          const options = {
            mimeType: "audio/webm;codecs=opus",
          };

          // Fallback for browsers that don't support webm
          if (!MediaRecorder.isTypeSupported(options.mimeType)) {
            options.mimeType = "audio/mp4";
            if (!MediaRecorder.isTypeSupported(options.mimeType)) {
              options.mimeType = "audio/wav";
            }
          }

          mediaRecorder = new MediaRecorder(stream, options);
          audioChunks = [];

          mediaRecorder.ondataavailable = function (event) {
            if (event.data.size > 0) {
              audioChunks.push(event.data);
            }
          };

          mediaRecorder.onstop = function () {
            const audioBlob = new Blob(audioChunks, {
              type: mediaRecorder.mimeType,
            });
            transcribeAudio(audioBlob);

            // Stop all tracks to release microphone
            stream.getTracks().forEach((track) => track.stop());
          };

          // Start recording with 1000ms timeslice to ensure data availability events fire regularly
          mediaRecorder.start(1000);
          window.isRecording = true;

          // Update UI for old button (if exists)
          if (voiceBtn) {
            voiceBtn.innerHTML = '<i class="fa-solid fa-stop"></i>';
            voiceBtn.classList.add("bg-red-500", "text-white");
            voiceBtn.classList.remove(
              "bg-white",
              "dark:bg-gray-800",
              "text-gray-700",
              "dark:text-gray-200",
            );

            // Update tooltip
            const tooltip = voiceBtn.nextElementSibling;
            if (tooltip) {
              tooltip.textContent = "Click to stop recording";
            }
          }

          // Update UI for new button (if exists)
          const newVoiceBtn = document.getElementById("new-voice-btn");
          if (newVoiceBtn) {
            newVoiceBtn.innerHTML = '<i class="fa-solid fa-square"></i>';
            newVoiceBtn.classList.remove("primary");
            newVoiceBtn.classList.add("bg-red-500", "text-white");
          }

          // Add recording state to search box
          const searchBox = document.querySelector(".sage-search-box");
          if (searchBox) {
            searchBox.classList.add(
              "ring-2",
              "ring-red-400",
              "ring-opacity-50",
            );
            searchBox.style.boxShadow = "0 0 20px rgba(239, 68, 68, 0.4)";
          }
          // Show desktop status
          window.desktopStatusHelpers.show("recording", "Recording...");

          console.log("Recording started...");
        } catch (error) {
          console.error("Error starting recording:", error);

          let errorMessage = "Could not access microphone. ";
          if (error.name === "NotAllowedError") {
            errorMessage += "Please allow microphone access and try again.";
          } else if (error.name === "NotFoundError") {
            errorMessage += "No microphone found.";
          } else {
            errorMessage += "Please check your microphone settings.";
          }

          alert(errorMessage);
        }
      }

      function stopRecording() {
        if (mediaRecorder && window.isRecording) {
          mediaRecorder.stop();
          window.isRecording = false;

          // Update UI for old button (if exists)
          if (voiceBtn) {
            voiceBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            voiceBtn.classList.remove("bg-red-500", "text-white");
            voiceBtn.classList.add("bg-gray-400", "text-white");

            // Update tooltip
            const tooltip = voiceBtn.nextElementSibling;
            if (tooltip) {
              tooltip.textContent = "Processing audio...";
            }
          }

          // Update UI for new button (if exists)
          const newVoiceBtn = document.getElementById("new-voice-btn");
          if (newVoiceBtn) {
            newVoiceBtn.innerHTML =
              '<i class="fa-solid fa-spinner fa-spin"></i>';
            newVoiceBtn.classList.remove("bg-red-500");
            newVoiceBtn.classList.add("bg-gray-400");
          }

          // Change search box to processing state (yellow glow)
          const searchBox = document.querySelector(".sage-search-box");
          if (searchBox) {
            searchBox.classList.remove("ring-red-400");
            searchBox.classList.add("ring-amber-400");
            searchBox.style.boxShadow = "0 0 20px rgba(245, 158, 11, 0.4)";
          }
          // Show desktop status
          window.desktopStatusHelpers.show("processing", "Processing audio...");

          console.log("Recording stopped, processing...");
        }
      }

      async function transcribeAudio(audioBlob) {
        let result = null;
        try {
          // Validate blob size
          if (audioBlob.size === 0) {
            console.error(" Recorded audio blob is empty");
            alert("No audio recorded. Please try again.");
            if (window.mobileStatusHelpers) window.mobileStatusHelpers.hide();
            return;
          }

          // Create FormData for file upload
          const formData = new FormData();

          // Determine file extension based on blob type
          let extension = ".webm";
          if (audioBlob.type.includes("mp4")) {
            extension = ".mp4";
          } else if (audioBlob.type.includes("wav")) {
            extension = ".wav";
          } else if (audioBlob.type.includes("ogg")) {
            extension = ".ogg";
          }

          formData.append("audio", audioBlob, `recording${extension}`);

          console.log("Sending audio for transcription...");

          // Send to transcription API
          const response = await fetch("/api/transcribe", {
            method: "POST",
            body: formData,
          });

          result = await response.json();

          if (result.success && result.text) {
            // Insert transcribed text into input field
            // Use the queryInput variable which now handles new vs legacy selection
            queryInput.value = result.text;

            // Trigger input event to resize textarea
            queryInput.dispatchEvent(new Event("input"));

            // Focus on input field
            queryInput.focus();

            console.log("Transcription successful:", result.text);

            // Show success status
            window.desktopStatusHelpers.success("Voice captured!");
          } else {
            console.error("Transcription failed:", result.error);
            alert("Transcription failed: " + (result.error || "Unknown error"));
            // Hide mobile status on error
            if (window.mobileStatusHelpers) {
              window.mobileStatusHelpers.hide();
            }
          }
        } catch (error) {
          console.error("Error during transcription:", error);
          alert("Error during transcription. Please try again.");
          // Hide mobile status on error
          if (window.mobileStatusHelpers) {
            window.mobileStatusHelpers.hide();
          }
        } finally {
          // Reset UI for old button (if exists)
          if (voiceBtn) {
            voiceBtn.innerHTML = '<i class="ph-bold ph-microphone"></i>';
            voiceBtn.classList.remove(
              "bg-gray-400",
              "bg-red-500",
              "text-white",
            );
            voiceBtn.classList.add(
              "bg-white",
              "dark:bg-gray-800",
              "text-gray-700",
              "dark:text-gray-200",
            );

            // Reset tooltip
            const tooltip = voiceBtn.nextElementSibling;
            if (tooltip) {
              tooltip.textContent = "Click to record voice input";
            }
          }

          // Reset UI for new button (if exists)
          const newVoiceBtn = document.getElementById("new-voice-btn");
          if (newVoiceBtn) {
            newVoiceBtn.classList.remove(
              "bg-gray-400",
              "bg-red-500",
              "text-white",
            );
            newVoiceBtn.classList.add("primary");
            // Update icon based on input state
            const hasText = queryInput.value.trim().length > 0;
            newVoiceBtn.innerHTML = hasText
              ? '<i class="ph-bold ph-arrow-up"></i>'
              : '<i class="ph-bold ph-microphone"></i>';
          }

          // Clear search box visual effects
          const searchBox = document.querySelector(".sage-search-box");
          if (searchBox) {
            searchBox.classList.remove(
              "ring-2",
              "ring-red-400",
              "ring-amber-400",
              "ring-opacity-50",
            );
            searchBox.style.boxShadow = "";
          }

          // Show success status on mobile if transcription succeeded
          if (result && result.text && window.mobileStatusHelpers) {
            window.mobileStatusHelpers.success("Voice captured!");
          }
        }
      }

      // Make functions available globally for the unified module
      window.addUserMessage = addUserMessage;
      window.addBotMessage = addBotMessage;
      window.addTypingIndicator = addTypingIndicator;
      window.escapeHtml = escapeHtml;
      window.formatMessage = formatMessage;
      window.openDrawer = openDrawer;
      window.logsContainer = consoleLogsContent;
      window.addSourcesUtilizedSection = addSourcesUtilizedSection;

      // ============================================
      // MOBILE WAND POPUP FUNCTIONALITY WITH VISUAL FEEDBACK
      // ============================================
      (function initMobileWandPopup() {
        const plusBtn = document.getElementById("wand-plus-btn");
        const popup = document.getElementById("wand-popup");
        const inputContainer = document.getElementById("chat-input-container");
        const statusIndicator = document.getElementById("mobile-status");
        const statusText = document.getElementById("mobile-status-text");

        if (!plusBtn || !popup) return;

        // Helper to show mobile status feedback
        function showMobileStatus(type, message, icon) {
          if (!statusIndicator || !statusText) return;

          // Reset classes
          statusIndicator.className = "mobile-status-indicator show " + type;
          statusText.textContent = message;

          // Update icon
          const iconEl = statusIndicator.querySelector("i");
          if (iconEl) {
            iconEl.className = "fa-solid " + icon;
          }

          // Update plus button and input container
          if (plusBtn) {
            plusBtn.classList.remove("recording", "processing", "enhancing");
            plusBtn.classList.add(type);
            plusBtn.innerHTML =
              '<i class="fa-solid fa-' +
              (type === "recording" ? "microphone" : "wand-magic-sparkles") +
              '"></i>';
          }
          if (inputContainer) {
            inputContainer.classList.remove(
              "recording",
              "processing",
              "enhancing",
            );
            inputContainer.classList.add(type);
          }
        }

        // Helper to hide mobile status feedback
        function hideMobileStatus() {
          if (statusIndicator) {
            statusIndicator.classList.remove(
              "show",
              "recording",
              "processing",
              "enhancing",
              "success",
            );
          }
          if (plusBtn) {
            plusBtn.classList.remove("recording", "processing", "enhancing");
            plusBtn.innerHTML = '<i class="fa-solid fa-plus"></i>';
          }
          if (inputContainer) {
            inputContainer.classList.remove(
              "recording",
              "processing",
              "enhancing",
            );
          }
        }

        // Show success briefly
        function showSuccessStatus(message) {
          if (!statusIndicator || !statusText) return;

          statusIndicator.className = "mobile-status-indicator show success";
          statusText.textContent = message;
          const iconEl = statusIndicator.querySelector("i");
          if (iconEl) {
            iconEl.className = "fa-solid fa-check";
          }

          // Hide after 2 seconds
          setTimeout(hideMobileStatus, 2000);
        }

        // Make helpers globally available for voice/wand handlers
        window.mobileStatusHelpers = {
          show: showMobileStatus,
          hide: hideMobileStatus,
          success: showSuccessStatus,
        };

        // Toggle popup on plus button click
        plusBtn.addEventListener("click", function (e) {
          e.stopPropagation();

          // If actively recording, allow clicking to stop (via desktop trigger)
          if (plusBtn.classList.contains("recording")) {
            // Trigger the desktop voice button to stop recording
            const vBtn =
              document.getElementById("new-voice-btn") ||
              document.getElementById("voice-btn");
            if (vBtn) vBtn.click();
            return;
          }

          // If processing/enhancing, block interaction
          if (
            plusBtn.classList.contains("processing") ||
            plusBtn.classList.contains("enhancing")
          ) {
            return;
          }

          const isOpen = popup.classList.contains("show");

          if (isOpen) {
            popup.classList.remove("show");
            plusBtn.classList.remove("active");
            plusBtn.innerHTML = '<i class="fa-solid fa-plus"></i>';
          } else {
            popup.classList.add("show");
            plusBtn.classList.add("active");
            plusBtn.innerHTML = '<i class="fa-solid fa-xmark"></i>';
          }
        });

        // Close popup when clicking outside
        document.addEventListener("click", function (e) {
          if (!popup.contains(e.target) && !plusBtn.contains(e.target)) {
            popup.classList.remove("show");
            if (
              !plusBtn.classList.contains("recording") &&
              !plusBtn.classList.contains("processing") &&
              !plusBtn.classList.contains("enhancing")
            ) {
              plusBtn.classList.remove("active");
              plusBtn.innerHTML = '<i class="fa-solid fa-plus"></i>';
            }
          }
        });

        // Handle popup button clicks with visual feedback
        popup.querySelectorAll(".wand-popup-btn").forEach(function (btn) {
          btn.addEventListener("click", function (e) {
            e.stopPropagation();
            const action = btn.getAttribute("data-action");

            // Close popup
            popup.classList.remove("show");
            plusBtn.classList.remove("active");

            // Show appropriate status based on action
            if (action === "voice") {
              showMobileStatus("recording", "Recording...", "fa-microphone");
            } else if (action === "magic") {
              showMobileStatus(
                "enhancing",
                "Enhancing query...",
                "fa-spinner fa-spin",
              );
            } else if (action === "magic-sparkles") {
              showMobileStatus(
                "processing",
                "Creating detailed prompt...",
                "fa-spinner fa-spin",
              );
            }

            // Trigger the corresponding desktop button
            if (action === "magic") {
              document.getElementById("magic-btn")?.click();
            } else if (action === "magic-sparkles") {
              document.getElementById("magic-btn-2xl")?.click();
            } else if (action === "voice") {
              (
                document.getElementById("new-voice-btn") ||
                document.getElementById("voice-btn")
              )?.click();
            }
          });
        });
      })();
      // Old DOMContentLoaded listener for sources panel removed.
    </script>

    <script>
      (function () {
        // NEW Experimental Mode Toggle Button in Search Box
        const experimentalModeBtn = document.getElementById(
          "experimental-mode-btn",
        );
        const newPersonaSelector = document.getElementById(
          "new-persona-selector",
        );
        const modeSelectorWrapper = document.getElementById(
          "mode-selector-wrapper",
        );

        // Legacy toggle elements (in hidden header)
        const modeToggle = document.getElementById("experimental-mode-toggle");
        const modeLabel = document.getElementById("mode-label");
        const experimentalBadge = document.getElementById("experimental-badge");

        // Track current mode state
        let currentMode = "production";
        let currentPersona = "intermediate";
        // Flag: user has explicitly selected a persona this session — initMode() must not overwrite
        window._personaExplicitlySet = false;

        // Update UI based on mode
        function updateModeUI(isExperimental, persona = "intermediate") {
          currentMode = isExperimental ? "experimental" : "production";
          // In production mode, force persona to 'none' (no persona behavior)
          currentPersona = isExperimental ? persona : "none";
          window.currentPersona = currentPersona; // Sync global for streaming verification check

          // Expose current state for other script blocks that need to sync UI
          // (Prevents late-running initializers from overwriting server-selected persona)
          window.__sageModeState = {
            mode: currentMode,
            persona: currentPersona,
            ts: Date.now(),
          };

          if (isExperimental) {
            // Experimental mode - show persona selector, highlight toggle
            if (experimentalModeBtn) {
              experimentalModeBtn.classList.add("active");
            }
            if (modeSelectorWrapper) {
              modeSelectorWrapper.classList.remove("hidden");
            }
            if (newPersonaSelector) {
              newPersonaSelector.classList.remove("hidden");
              newPersonaSelector.value = persona;
            }

            // Legacy toggle sync
            if (modeLabel) modeLabel.textContent = "Experimental";
            if (experimentalBadge) experimentalBadge.classList.remove("hidden");

            const newStatus = document.getElementById("new-mode-status");
            if (newStatus) {
              newStatus.textContent = persona;
              newStatus.className =
                "ml-3 px-2 py-1 rounded-md text-[10px] uppercase tracking-wider font-bold bg-blue-100 text-[#0b45c3] dark:bg-blue-900/30 dark:text-blue-400 block";
            }

            document.body.classList.add("experimental-mode");

            // Show top mode pill bar and sync flask toggle
            const topPill = document.getElementById("top-mode-pill");
            if (topPill) {
              topPill.classList.remove("hidden");
              // Activate flask toggle
              const flask = document.getElementById("top-flask-toggle");
              if (flask) flask.classList.add("active");
              // Enable mode buttons
              topPill.classList.remove("flask-off");
              topPill
                .querySelectorAll(".top-mode-btn[data-mode]")
                .forEach((btn) => {
                  btn.classList.remove("modes-disabled");
                  btn.classList.toggle("active", btn.dataset.mode === persona);
                });
              // Slide indicator to active button
              requestAnimationFrame(() => {
                const activeBtn = topPill.querySelector(
                  ".top-mode-btn[data-mode].active",
                );
                if (activeBtn) {
                  const pillRect = topPill.getBoundingClientRect();
                  const btnRect = activeBtn.getBoundingClientRect();
                  topPill.style.setProperty(
                    "--slide-x",
                    btnRect.left - pillRect.left - 5 + "px",
                  );
                }
              });
            }

            console.log(`🧪 Experimental Mode enabled (Persona: ${persona})`);
          } else {
            // Production mode - hide persona selector, remove highlight
            if (experimentalModeBtn) {
              experimentalModeBtn.classList.remove("active");
            }
            if (modeSelectorWrapper) {
              modeSelectorWrapper.classList.add("hidden");
            }
            if (newPersonaSelector) newPersonaSelector.classList.add("hidden");

            if (modeLabel) modeLabel.textContent = "Standard";
            if (experimentalBadge) experimentalBadge.classList.add("hidden");

            const newStatus = document.getElementById("new-mode-status");
            if (newStatus) {
              newStatus.textContent = "Standard";
              newStatus.className =
                "ml-3 px-2 py-1 rounded-md text-[10px] uppercase tracking-wider font-bold bg-gray-100 text-gray-500 dark:bg-gray-800 dark:text-gray-400 block";
            }

            document.body.classList.remove("experimental-mode");

            // Grey out mode pills but keep pill bar visible
            const topPill = document.getElementById("top-mode-pill");
            if (topPill) {
              topPill.classList.remove("hidden"); // Ensure pill bar is always visible
              const flask = document.getElementById("top-flask-toggle");
              if (flask) flask.classList.remove("active");
              topPill.classList.add("flask-off");
              topPill
                .querySelectorAll(".top-mode-btn[data-mode]")
                .forEach((btn) => {
                  btn.classList.add("modes-disabled");
                });
            }

            console.log("🏭 Standard Mode enabled - NO persona behavior");
          }

          // Sync legacy checkbox
          if (modeToggle) modeToggle.checked = isExperimental;

          // Notify other UI components that mode/persona has been initialized/changed
          // NOTE: This is intentionally dispatched after state + DOM updates above.
          try {
            window.dispatchEvent(
              new CustomEvent("sage:mode-updated", {
                detail: { mode: currentMode, persona: currentPersona },
              }),
            );
          } catch (e) {
            // CustomEvent not supported (very old browsers) — ignore
          }
        }

        // Show toast notification
        function showToast(message, type = "info") {
          const toast = document.createElement("div");
          toast.className = `fixed bottom-20 right-4 px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-y-0 opacity-100`;
          toast.className +=
            type === "success"
              ? " bg-blue-600 text-white"
              : type === "error"
                ? " bg-red-500 text-white"
                : " bg-blue-600 text-white";
          toast.textContent = message;
          document.body.appendChild(toast);

          setTimeout(() => {
            toast.classList.add("opacity-0", "translate-y-2");
            setTimeout(() => toast.remove(), 300);
          }, 2500);
        }

        // Initialize mode from server, sync saved preferences from localStorage
        async function initMode() {
          try {
            // First, get current server state (this is authoritative)
            const response = await fetch("/api/mode");
            if (response.ok) {
              const data = await response.json();
              const serverMode = data.mode;
              const serverPersona = data.persona;
              const experimentalToggleEnabled =
                data.experimental_toggle_enabled !== false;

              // Check if we have saved preferences in localStorage
              const savedMode = localStorage.getItem("sage_mode");
              const savedPersona = localStorage.getItem("sage_persona");

              // GUARD: Only sync experimental mode from localStorage if:
              // 1. The experimental toggle is enabled on the server
              // 2. The saved mode is 'experimental'
              if (savedMode === "experimental" && experimentalToggleEnabled) {
                // Always prefer localStorage persona over server default
                // (server defaults to 'intermediate' after restart when session is lost)
                const personaToUse =
                  savedPersona || serverPersona || "intermediate";
                // If user already selected a persona this session, don't overwrite
                if (window._personaExplicitlySet) return;
                if (
                  savedMode !== serverMode ||
                  personaToUse !== serverPersona
                ) {
                  console.log(
                    `Syncing experimental mode from localStorage: persona=${personaToUse} (server had: ${serverPersona})`,
                  );
                  const syncSuccess = await syncMode(
                    savedMode,
                    personaToUse,
                    true,
                  ); // silent=true
                  if (syncSuccess) {
                    if (!window._personaExplicitlySet)
                      updateModeUI(true, personaToUse);
                    console.log("Experimental mode synced from localStorage");
                    return;
                  }
                }
                // If server and localStorage agree, just apply it
                if (!window._personaExplicitlySet) {
                  updateModeUI(true, personaToUse);
                  console.log(
                    `Mode initialized from localStorage: persona=${personaToUse}`,
                  );
                }
                return;
              } else if (
                savedMode === "experimental" &&
                !experimentalToggleEnabled
              ) {
                // Clear stale experimental mode from localStorage since toggle is disabled
                console.log(
                  "Clearing stale experimental mode (toggle disabled on server)",
                );
                localStorage.removeItem("sage_mode");
                localStorage.removeItem("sage_persona");
              }

              // Use server state as the source of truth (no localStorage override)
              // But never overwrite an explicit user selection made this session
              if (!window._personaExplicitlySet) {
                const isExperimental = serverMode === "experimental";
                updateModeUI(isExperimental, serverPersona);

                // Save server state to localStorage for future reference
                localStorage.setItem("sage_mode", serverMode);
                if (isExperimental) {
                  localStorage.setItem("sage_persona", serverPersona);
                } else {
                  localStorage.removeItem("sage_persona");
                }
              }

              console.log("Mode initialized from server:", data);
            }
          } catch (error) {
            console.error("Failed to get mode:", error);
            // Default to experimental mode with Balanced persona on error
            if (!window._personaExplicitlySet)
              updateModeUI(true, "intermediate");
          }
        }

        // Sync specific persona/mode to backend
        async function syncMode(mode, persona, silent = false) {
          try {
            // In production mode, always use 'none' persona
            const effectivePersona = mode === "production" ? "none" : persona;
            const response = await fetch("/api/mode", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                mode: mode,
                persona: effectivePersona,
                reasoning_effort: window.currentReasoning || localStorage.getItem("sage_reasoning_effort") || "medium",
                verbosity: window.currentVerbosity || localStorage.getItem("sage_verbosity") || "medium",
              }),
            });

            if (response.ok) {
              const data = await response.json();
              updateModeUI(mode === "experimental", data.persona);

              // Save to localStorage for persistence across server restarts
              localStorage.setItem("sage_mode", mode);
              if (mode === "production") {
                // Clear persona from localStorage when switching to production
                // to prevent stale persona state when experimental mode is disabled
                localStorage.removeItem("sage_persona");
              } else {
                localStorage.setItem("sage_persona", data.persona);
              }

              if (!silent) {
                // Mode status is now handled by the integrated status label in updateModeUI()
                // Clear conversation for clean slate with new mode settings
                /* try {
                  await fetch("/api/clear_history", { method: "POST" });
                  console.log("Conversation history cleared for mode switch");
                } catch (e) {
                  console.warn("Could not clear history:", e);
                } */
              }
            } else {
              return false;
            }
            return true;
          } catch (error) {
            console.error("Failed to sync mode:", error);
            return false;
          }
        }

        // Handle experimental mode toggle button click
        if (experimentalModeBtn) {
          experimentalModeBtn.addEventListener("click", async function () {
            const newMode =
              currentMode === "production" ? "experimental" : "production";
            // When switching to experimental, use a valid persona (not 'none')
            const persona =
              newMode === "experimental"
                ? currentPersona && currentPersona !== "none"
                  ? currentPersona
                  : "intermediate"
                : "none";

            const success = await syncMode(newMode, persona);
            if (success) {
              // Show confirmation message above search box
              const confirmationMessage = document.getElementById(
                "mode-confirmation-message",
              );
              const confirmationText = document.getElementById(
                "mode-confirmation-text",
              );
              if (confirmationMessage && confirmationText) {
                confirmationText.textContent =
                  newMode === "experimental"
                    ? "Experimental Mode"
                    : "Standard Mode";
                confirmationMessage.classList.remove("hidden");

                // Auto-hide after 3 seconds
                setTimeout(() => {
                  confirmationMessage.classList.add("hidden");
                }, 3000);
              }
            } else {
              showToast("Failed to switch mode", "error");
            }
          });
        }

        // Handle legacy toggle change (hidden header)
        if (modeToggle) {
          modeToggle.addEventListener("change", async function () {
            const newMode = this.checked ? "experimental" : "production";
            // Use 'intermediate' (Balanced) as default for experimental mode
            // When switching to experimental, use a valid persona (not 'none')
            const persona =
              newMode === "experimental"
                ? newPersonaSelector
                  ? newPersonaSelector.value
                  : "intermediate"
                : "none";

            const success = await syncMode(newMode, persona);
            if (!success) {
              this.checked = !this.checked;
              showToast("Failed to switch mode", "error");
            }
          });
        }
        // Handle new persona selector change in search box to sync mode/persona and update UI
        newPersonaSelector.addEventListener("change", async function () {
          const newPersona = this.value;
          // Always use experimental mode when a persona is selected — currentMode may still
          // be "production" if initMode() hasn't completed its async fetch yet.
          const mode =
            newPersona && newPersona !== "none" ? "experimental" : currentMode;

          // Mark that the user has explicitly chosen a persona so initMode() won't overwrite it
          window._personaExplicitlySet = true;
          // Optimistic update: reflect selection immediately before server confirms
          window.currentPersona = newPersona;
          currentPersona = newPersona;
          currentMode = mode;

          const success = await syncMode(mode, newPersona);
          if (!success) {
            showToast("Failed to update persona", "error");
            // Revert selector to what's in localStorage
            const savedPersona =
              localStorage.getItem("sage_persona") || "intermediate";
            this.value = savedPersona;
          } else {
            const newStatus = document.getElementById("new-mode-status");
            if (newStatus) {
              newStatus.textContent = newPersona;
              newStatus.className =
                "ml-3 px-2 py-1 rounded-md text-[10px] uppercase tracking-wider font-bold bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400 block";
            }
          }
        });
        // NOTE: newPersonaSelector change is handled in a separate handler below
        // (removed duplicate handler here that was causing duplicate toasts)

        // Expose syncMode and updateModeUI globally so other script blocks can use them
        window.syncMode = syncMode;
        window.updateModeUI = updateModeUI;

        // Initialize on page load
        document.addEventListener("DOMContentLoaded", initMode);
      })();
    </script>

    <!-- Load the unified developer evaluation module -->

    <script src="/static/js/unifiedEval.js"></script>
    <script src="/static/js/custom.js"></script>
    <!-- This file is empty/deprecated -->
    <script src="/static/js/debug-logger.js"></script>
    <script>
      window.APP_CONFIG = { sasToken: {{ sas_token | tojson }} };
    </script>
    <script src="/static/js/url-decoder.js"></script>
    <!-- URL decoder for source document links -->
    <script src="/static/js/dynamic-container.js"></script>
    <!-- <script src="/static/js/citation-toggle.js"></script> -->
    <!-- Removed -->
    <script src="/static/js/feedback-integration.js"></script>
    <script src="/static/js/feedback_thumbs.js"></script>
    <script src="/static/js/dev_eval_chat.js"></script>
    <!-- Placeholder citation click handler and its listener removed -->

    <!-- <script>

(function() {
  const overlay = document.getElementById('passcode-overlay');
  const passcodeInput = document.getElementById('passcode-input');
  const accessBtn = document.getElementById('access-btn');
  
  // Check if already authenticated
  if (localStorage.getItem('stagingAuth') === 'true') {
    overlay.classList.add('hidden');
  }
  
  // Simple hash function for basic obfuscation
  function simpleHash(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      const char = str.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash;
    }
    return hash;
  }
  
  // The passcode hash (can be changed to any value)
  const correctPasscodeHash = -1633765023; // This would be the hash of your actual passcode "rosebud"
  

  // Validate passcode
  function validatePasscode() {
    const enteredPasscode = passcodeInput.value.trim();
    if (simpleHash(enteredPasscode) === correctPasscodeHash || enteredPasscode === "rosebud") {
      overlay.classList.add('hidden');
      localStorage.setItem('stagingAuth', 'true');
    } else {
      passcodeInput.classList.add('border-red-500');
      setTimeout(() => {
        passcodeInput.classList.remove('border-red-500');
      }, 1000);
    }
  }
  
  // Event listeners
  accessBtn.addEventListener('click', validatePasscode);
  passcodeInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      validatePasscode();
    }
  });
})();
</script> -->
    <script src="/static/js/dark-mode.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const searchInput = document.getElementById("query-input");
        if (searchInput) {
          searchInput.focus();
        }
      });
    </script>
    <script>
      // Function to fetch welcome message from server
      async function fetchWelcomeMessage() {
        try {
          const response = await fetch("/api/welcome_message");
          if (response.ok) {
            const data = await response.json();
            return data.message || "Welcome to Sage!";
          } else {
            console.error(
              "Failed to fetch welcome message:",
              response.statusText,
            );
            return "Welcome to Sage!";
          }
        } catch (error) {
          console.error("Error fetching welcome message:", error);
          return "Welcome to Sage!";
        }
      }
    </script>
    <!-- New UI Components JavaScript -->
    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        //===== Welcome message disabled - show just the logo =====
        // const welcome_message = await fetchWelcomeMessage();
        // // display in DOM element if present
        // const el = document.getElementById('welcome-message');
        // if (el) el.textContent = welcome_message;
        // // also call existing chat helper if available
        // if (typeof addBotMessage === 'function') addBotMessage(welcome_message);

        // ===== FOCUS NEW SEARCH INPUT ON LOAD =====
        const newSearchInput = document.getElementById("new-query-input");
        if (newSearchInput) newSearchInput.focus();

        // ===== SETTINGS POPOVER LOGIC =====
        const settingsBtn = document.getElementById("search-settings-btn");
        const popover = document.getElementById("settings-popover");

        if (settingsBtn && popover) {
          settingsBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            popover.classList.toggle("hidden");
            popover.classList.toggle("active");
          });

          // Close popover when clicking outside
          document.addEventListener("click", (e) => {
            if (
              !settingsBtn.contains(e.target) &&
              !popover.contains(e.target)
            ) {
              popover.classList.add("hidden");
              popover.classList.remove("active");
            }
          });
        }

        // ===== MODE DROPDOWN LOGIC =====
        const modeSelectorTrigger = document.getElementById(
          "mode-selector-trigger",
        );
        const modeDropdown = document.getElementById("mode-dropdown");
        const currentModeLabel = document.getElementById("current-mode-label");
        const modeOptions = document.querySelectorAll(".mode-option");
        const hiddenPersonaSelect = document.getElementById(
          "new-persona-selector",
        );

        if (modeSelectorTrigger && modeDropdown) {
          // Toggle dropdown
          modeSelectorTrigger.addEventListener("click", (e) => {
            e.stopPropagation();
            modeDropdown.classList.toggle("hidden");
            modeDropdown.classList.toggle("active");
            modeSelectorTrigger.classList.toggle("open");
          });

          // Close dropdown when clicking outside
          document.addEventListener("click", (e) => {
            if (
              !modeSelectorTrigger.contains(e.target) &&
              !modeDropdown.contains(e.target)
            ) {
              modeDropdown.classList.add("hidden");
              modeDropdown.classList.remove("active");
              modeSelectorTrigger.classList.remove("open");
            }
          });

          // Handle mode option clicks
          modeOptions.forEach((option) => {
            option.addEventListener("click", async () => {
              const selectedMode = option.dataset.mode;

              // Update UI
              modeOptions.forEach((opt) => opt.classList.remove("active"));
              option.classList.add("active");

              // Update label
              const titleEl = option.querySelector(".mode-option-title");
              if (currentModeLabel && titleEl) {
                currentModeLabel.textContent = titleEl.textContent;
              }

              // Show confirmation message above search box
              const confirmationMessage = document.getElementById(
                "mode-confirmation-message",
              );
              const confirmationText = document.getElementById(
                "mode-confirmation-text",
              );
              if (confirmationMessage && confirmationText && titleEl) {
                confirmationText.textContent = titleEl.textContent;
                confirmationMessage.classList.remove("hidden");

                // Auto-hide after 3 seconds
                setTimeout(() => {
                  confirmationMessage.classList.add("hidden");
                }, 3000);
              }

              // Sync with hidden select
              if (hiddenPersonaSelect) {
                hiddenPersonaSelect.value = selectedMode;
                // Trigger change event for existing persona sync logic
                hiddenPersonaSelect.dispatchEvent(new Event("change"));
              }

              // Close dropdown
              modeDropdown.classList.add("hidden");
              modeDropdown.classList.remove("active");
              modeSelectorTrigger.classList.remove("open");
            });
          });

          // Initialize/Sync selection without overwriting authoritative state.
          // If localStorage is missing (first load / cleared storage), we must NOT
          // force "intermediate" and overwrite a server-selected persona.
          function syncDropdownFromState(state) {
            const mode = state?.mode;
            const persona = state?.persona;

            if (!mode || mode !== "experimental") return;
            if (!persona || persona === "none") return;

            const opt = document.querySelector(
              `.mode-option[data-mode="${persona}"]`,
            );
            if (!opt) return;

            modeOptions.forEach((o) => o.classList.remove("active"));
            opt.classList.add("active");

            const titleEl = opt.querySelector(".mode-option-title");
            if (currentModeLabel && titleEl) {
              currentModeLabel.textContent = titleEl.textContent;
            }
            const newStatus = document.getElementById("new-mode-status");
            if (newStatus && titleEl) {
              newStatus.textContent = titleEl.textContent;
            }
          }

          // Best-effort initial sync
          const initialMode = localStorage.getItem("sage_mode");
          const initialPersona = localStorage.getItem("sage_persona");
          syncDropdownFromState({
            mode:
              initialMode ||
              window.__sageModeState?.mode ||
              (document.body.classList.contains("experimental-mode")
                ? "experimental"
                : "production"),
            persona:
              initialPersona ||
              window.__sageModeState?.persona ||
              window.currentPersona,
          });

          // Authoritative sync (server init + later mode switches)
          window.addEventListener("sage:mode-updated", (e) => {
            syncDropdownFromState(e.detail);
          });
        }

        // ===== TOP MODE PILL BAR LOGIC =====
        const topModePill = document.getElementById("top-mode-pill");
        if (topModePill) {
          const topFlaskToggle = document.getElementById("top-flask-toggle");
          // Only mode buttons (exclude flask toggle)
          const modeBtns = topModePill.querySelectorAll(
            ".top-mode-btn[data-mode]",
          );
          const slider = topModePill.querySelector(".top-mode-pill-slider");

          // Slide the indicator to the active mode button (accounts for flask button offset)
          function slideToBtn(btn) {
            if (!slider || !btn) return;
            const pillRect = topModePill.getBoundingClientRect();
            const btnRect = btn.getBoundingClientRect();
            const offset = btnRect.left - pillRect.left - 5; // 5px = container padding
            topModePill.style.setProperty("--slide-x", offset + "px");
          }

          // Enable / disable the 3 mode buttons based on flask state
          function setModesEnabled(enabled) {
            modeBtns.forEach((b) => {
              if (enabled) {
                b.classList.remove("modes-disabled");
              } else {
                b.classList.add("modes-disabled");
              }
            });
            if (enabled) {
              topModePill.classList.remove("flask-off");
            } else {
              topModePill.classList.add("flask-off");
            }
          }

          // Activate the flask (turn on experimental mode)
          async function activateFlask(persona) {
            if (topFlaskToggle) topFlaskToggle.classList.add("active");
            setModesEnabled(true);
            // syncMode calls updateModeUI on success, which syncs both top pill bar and bottom controls
            await window.syncMode(
              "experimental",
              persona ||
                window.currentPersona ||
                localStorage.getItem("sage_persona") ||
                "intermediate",
            );
          }

          // Deactivate the flask (turn off experimental mode)
          async function deactivateFlask() {
            if (topFlaskToggle) topFlaskToggle.classList.remove("active");
            setModesEnabled(false);
            // syncMode calls updateModeUI on success, which syncs both top pill bar and bottom controls
            await window.syncMode("production", "none");
          }

          // Flask toggle click handler
          if (topFlaskToggle) {
            topFlaskToggle.addEventListener("click", async () => {
              const isActive = topFlaskToggle.classList.contains("active");
              if (isActive) {
                await deactivateFlask();
                // Show confirmation
                const confirmMsg = document.getElementById(
                  "mode-confirmation-message",
                );
                const confirmText = document.getElementById(
                  "mode-confirmation-text",
                );
                if (confirmMsg && confirmText) {
                  confirmText.textContent = "SAGE Personas mode disabled";
                  confirmMsg.style.display = "block";
                  confirmMsg.classList.remove("hidden");
                  setTimeout(() => {
                    confirmMsg.classList.add("hidden");
                    confirmMsg.style.display = "none";
                  }, 3000);
                }
              } else {
                // When turning on, use the currently active mode button or default to explorer
                const activeMode = topModePill.querySelector(
                  ".top-mode-btn[data-mode].active",
                );
                const persona = activeMode
                  ? activeMode.dataset.mode
                  : "explorer";
                await activateFlask(persona);
                // Slide to active button
                requestAnimationFrame(() => {
                  const activeBtn = topModePill.querySelector(
                    ".top-mode-btn[data-mode].active",
                  );
                  slideToBtn(activeBtn);
                });
                // Show confirmation
                const confirmMsg = document.getElementById(
                  "mode-confirmation-message",
                );
                const confirmText = document.getElementById(
                  "mode-confirmation-text",
                );
                if (confirmMsg && confirmText) {
                  confirmText.textContent = "SAGE Personas mode enabled";
                  confirmMsg.style.display = "block";
                  confirmMsg.classList.remove("hidden");
                  setTimeout(() => {
                    confirmMsg.classList.add("hidden");
                    confirmMsg.style.display = "none";
                  }, 3000);
                }
              }
            });
          }

          // Mode button click handlers
          modeBtns.forEach((btn) => {
            btn.addEventListener("click", async () => {
              // If flask is off / modes disabled, activate flask first
              if (btn.classList.contains("modes-disabled")) {
                // Remove disabled from all, activate this one
                modeBtns.forEach((b) => b.classList.remove("active"));
                btn.classList.add("active");
                await activateFlask(btn.dataset.mode);
                requestAnimationFrame(() => slideToBtn(btn));
                return;
              }

              const selectedMode = btn.dataset.mode;

              // Update pill active state
              modeBtns.forEach((b) => b.classList.remove("active"));
              btn.classList.add("active");

              // Slide indicator
              slideToBtn(btn);

              // Sync with hidden persona select (triggers existing change handler → API + localStorage)
              const hiddenSelect = document.getElementById(
                "new-persona-selector",
              );
              if (hiddenSelect) {
                hiddenSelect.value = selectedMode;
                hiddenSelect.dispatchEvent(new Event("change"));
              }

              // Sync with mode dropdown active state
              const dropdownOptions = document.querySelectorAll(".mode-option");
              dropdownOptions.forEach((opt) => {
                opt.classList.toggle(
                  "active",
                  opt.dataset.mode === selectedMode,
                );
              });

              // Update dropdown label
              const label = document.getElementById("current-mode-label");
              const matchedOpt = document.querySelector(
                `.mode-option[data-mode="${selectedMode}"]`,
              );
              if (label && matchedOpt) {
                const titleEl = matchedOpt.querySelector(".mode-option-title");
                if (titleEl) label.textContent = titleEl.textContent;
              }

              // Show confirmation toast
              const confirmMsg = document.getElementById(
                "mode-confirmation-message",
              );
              const confirmText = document.getElementById(
                "mode-confirmation-text",
              );
              if (confirmMsg && confirmText) {
                confirmText.textContent = btn.title || selectedMode;
                confirmMsg.style.display = "block";
                confirmMsg.classList.remove("hidden");
                setTimeout(() => {
                  confirmMsg.classList.add("hidden");
                  confirmMsg.style.display = "none";
                }, 3000);
              }
            });
          });

          function syncTopPillFromState(state) {
            const mode = state?.mode;
            const persona = state?.persona;

            if (!mode) return;

            if (mode === "experimental") {
              topModePill.classList.remove("hidden");
              modeBtns.forEach((b) =>
                b.classList.toggle(
                  "active",
                  b.dataset.mode === (persona || "intermediate"),
                ),
              );
              if (topFlaskToggle) topFlaskToggle.classList.add("active");
              setModesEnabled(true);
              requestAnimationFrame(() => {
                const activeBtn = topModePill.querySelector(
                  ".top-mode-btn[data-mode].active",
                );
                slideToBtn(activeBtn);
              });
            } else {
              // Pill bar visible but flask is off — grey out modes
              topModePill.classList.remove("hidden");
              setModesEnabled(false);
            }
          }

          // Initialize pill from localStorage only if present; otherwise defer to server state
          const initMode = localStorage.getItem("sage_mode");
          const initPersona = localStorage.getItem("sage_persona");

          const initialState = {
            mode:
              initMode ||
              window.__sageModeState?.mode ||
              (document.body.classList.contains("experimental-mode")
                ? "experimental"
                : "production"),
            persona:
              initPersona ||
              window.__sageModeState?.persona ||
              window.currentPersona,
          };

          syncTopPillFromState(initialState);

          // Authoritative sync (server init + later mode switches)
          window.addEventListener("sage:mode-updated", (e) => {
            syncTopPillFromState(e.detail);
          });

          // Back-compat: Keep existing dropdown→pill click sync, but do not override mode/persona
          // (Mode switches already trigger the sage:mode-updated event above)

          /*
          // Initialize pill from localStorage on load
          const initPersona =
            localStorage.getItem("sage_persona") ||
            window.currentPersona ||
            "intermediate";
          const initMode = localStorage.getItem("sage_mode") || "experimental";
          if (initMode === "experimental") {
            topModePill.classList.remove("hidden");
            modeBtns.forEach((b) =>
              b.classList.toggle("active", b.dataset.mode === initPersona),
            );
            if (topFlaskToggle) topFlaskToggle.classList.add("active");
            setModesEnabled(true);
            // Position slider after render
            requestAnimationFrame(() => {
              const activeBtn = topModePill.querySelector(
                ".top-mode-btn[data-mode].active",
              );
              slideToBtn(activeBtn);
            });
          } else {
            // Pill bar may be visible but flask is off — grey out modes
            setModesEnabled(false);
          }
          */

          // Also sync pill when dropdown changes
          const dropdownOptions = document.querySelectorAll(".mode-option");
          dropdownOptions.forEach((opt) => {
            opt.addEventListener("click", () => {
              modeBtns.forEach((b) =>
                b.classList.toggle(
                  "active",
                  b.dataset.mode === opt.dataset.mode,
                ),
              );
              const activeBtn = topModePill.querySelector(
                ".top-mode-btn[data-mode].active",
              );
              slideToBtn(activeBtn);
            });
          });
        }

        // ===== SAGE MODE SELECTOR (Gemini-style dropdown) =====
        (function initSageModeSelector() {
          const trigger = document.getElementById("sage-mode-trigger");
          const dropdown = document.getElementById("sage-mode-dropdown");
          const label = document.getElementById("sage-mode-label");
          const items = dropdown
            ? dropdown.querySelectorAll(".sage-mode-item")
            : [];
          const legacyToggle = document.getElementById("sage-legacy-toggle");
          const legacyPanel = document.getElementById("sage-legacy-panel");

          if (!trigger || !dropdown) return;

          // Display name map (menu label → backend persona)
          // Standard → intermediate, Balanced+ → balanced_plus, Scientist → scientist
          // Legacy: Explorer → explorer, Classic → none/production
          const DISPLAY_NAMES = {
            intermediate: "Classic",
            balanced_plus: "Balanced+",
            balanced_plus_ps: "Product Specialist",
            balanced_plus_ta: "Technical Assistant",
            scientist: "Scientist",
            explorer: "Explorer",
            none: "Classic",
          };

          // Toggle dropdown open/close
          trigger.addEventListener("click", (e) => {
            e.stopPropagation();
            const isOpen = dropdown.classList.contains("open");
            if (isOpen) {
              closeDropdown();
            } else {
              dropdown.classList.add("open");
              trigger.classList.add("open");
            }
          });

          function closeDropdown() {
            dropdown.classList.remove("open");
            trigger.classList.remove("open");
            // Collapse legacy panel when closing
            if (legacyPanel) legacyPanel.classList.remove("expanded");
            if (legacyToggle) legacyToggle.classList.remove("expanded");
          }

          // Close on outside click
          document.addEventListener("click", (e) => {
            if (!e.target.closest("#sage-mode-selector")) {
              closeDropdown();
            }
          });

          // Close on Escape
          document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") closeDropdown();
          });

          // Legacy toggle (expand/collapse sub-panel)
          if (legacyToggle && legacyPanel) {
            legacyToggle.addEventListener("click", (e) => {
              e.stopPropagation();
              legacyToggle.classList.toggle("expanded");
              legacyPanel.classList.toggle("expanded");
            });
          }

          // Handle mode item selection
          items.forEach((item) => {
            item.addEventListener("click", async (e) => {
              e.stopPropagation();
              const persona = item.dataset.persona;
              const mode = item.dataset.mode;

              // Update active state in dropdown
              items.forEach((i) => i.classList.remove("active"));
              item.classList.add("active");

              // Update trigger label
              label.textContent = DISPLAY_NAMES[persona] || persona;

              // Sync with backend via existing syncMode
              if (typeof window.syncMode === "function") {
                await window.syncMode(
                  mode,
                  persona === "none" ? "none" : persona,
                );
              }

              // Show confirmation toast
              const displayName = DISPLAY_NAMES[persona] || persona;
              if (typeof showPersonaToast === "function") {
                showPersonaToast(`Switched to ${displayName}`, "success");
              } else {
                const confirmMsg = document.getElementById(
                  "mode-confirmation-message",
                );
                const confirmText = document.getElementById(
                  "mode-confirmation-text",
                );
                if (confirmMsg && confirmText) {
                  confirmText.textContent = `Switched to ${displayName}`;
                  confirmMsg.style.display = "block";
                  confirmMsg.classList.remove("hidden");
                  setTimeout(() => {
                    confirmMsg.classList.add("hidden");
                    confirmMsg.style.display = "none";
                  }, 3000);
                }
              }

              // Sync hidden persona selector
              const hiddenSelect = document.getElementById(
                "new-persona-selector",
              );
              if (hiddenSelect && persona !== "none") {
                hiddenSelect.value = persona;
              }

              // Lock/unlock reasoning+verbosity pills for this persona
              if (typeof window.lockPillsForPersona === "function") {
                window.lockPillsForPersona(persona);
              }
            });
          });

          // Sync dropdown state from mode-updated events (server-driven changes)
          function syncDropdownFromState(detail) {
            if (!detail) return;
            const mode = detail.mode;
            const persona = detail.persona;

            let targetPersona;
            if (mode === "production" || persona === "none") {
              targetPersona = "none";
            } else {
              targetPersona = persona || "intermediate";
            }

            // Log persona sync for debugging
            console.log(
              `🔄 Sage Mode Selector sync: mode=${mode}, persona=${persona}, target=${targetPersona}`,
            );

            // Update active item
            items.forEach((i) => {
              i.classList.toggle("active", i.dataset.persona === targetPersona);
            });

            // Update trigger label
            label.textContent = DISPLAY_NAMES[targetPersona] || targetPersona;

            // Lock/unlock reasoning+verbosity pills for this persona
            if (typeof window.lockPillsForPersona === "function") {
              window.lockPillsForPersona(targetPersona);
            }
          }

          window.addEventListener("sage:mode-updated", (e) => {
            syncDropdownFromState(e.detail);
          });

          // Initialize from localStorage (default to Standard/intermediate)
          const savedMode = localStorage.getItem("sage_mode");
          const savedPersona = localStorage.getItem("sage_persona");
          syncDropdownFromState({
            mode: savedMode || window.__sageModeState?.mode || "experimental",
            persona:
              savedPersona || window.__sageModeState?.persona || "intermediate",
          });
        })();

        // ===== REASONING / VERBOSITY PILL SELECTORS =====
        (function initOptionPills() {
          // Initialize from localStorage
          window.currentReasoning = localStorage.getItem("sage_reasoning_effort") || "medium";
          window.currentVerbosity = localStorage.getItem("sage_verbosity") || "medium";

          function setupPillGroup(containerId, storageKey, globalKey) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const pills = container.querySelectorAll(".sage-option-pill");

            // Restore saved state
            const saved = localStorage.getItem(storageKey);
            if (saved) {
              pills.forEach((p) => {
                p.classList.toggle("active", p.dataset.value === saved);
              });
            }

            pills.forEach((pill) => {
              pill.addEventListener("click", async (e) => {
                e.stopPropagation();
                const value = pill.dataset.value;

                // Update active state
                pills.forEach((p) => p.classList.remove("active"));
                pill.classList.add("active");

                // Store globally and in localStorage
                window[globalKey] = value;
                localStorage.setItem(storageKey, value);

                console.log(`⚙️ ${storageKey} set to: ${value}`);

                // Sync to backend
                try {
                  await fetch("/api/mode", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                      mode: window.__sageModeState?.mode || "experimental",
                      persona: window.currentPersona || "intermediate",
                      reasoning_effort: window.currentReasoning,
                      verbosity: window.currentVerbosity,
                    }),
                  });
                } catch (err) {
                  console.warn("Failed to sync option to backend:", err);
                }
              });
            });
          }

          setupPillGroup("reasoning-pills", "sage_reasoning_effort", "currentReasoning");
          setupPillGroup("verbosity-pills", "sage_verbosity", "currentVerbosity");

          // Lock reasoning/verbosity pills for Scientist (hardcoded high/high)
          window.lockPillsForPersona = function(persona) {
            const reasoningContainer = document.getElementById("reasoning-pills");
            const verbosityContainer = document.getElementById("verbosity-pills");
            if (!reasoningContainer || !verbosityContainer) return;

            const isScientist = (persona === "scientist");

            [reasoningContainer, verbosityContainer].forEach(container => {
              const pills = container.querySelectorAll(".sage-option-pill");
              if (isScientist) {
                // Force "high" active, disable all pills
                pills.forEach(p => {
                  p.classList.toggle("active", p.dataset.value === "high");
                  p.style.pointerEvents = "none";
                  p.style.opacity = p.dataset.value === "high" ? "1" : "0.35";
                });
                container.style.opacity = "0.7";
                container.title = "Locked to High for Scientist mode";
              } else {
                // Re-enable pills and restore saved state
                pills.forEach(p => {
                  p.style.pointerEvents = "";
                  p.style.opacity = "";
                });
                container.style.opacity = "";
                container.title = "";
                // Restore saved values
                const storageKey = container.id === "reasoning-pills" ? "sage_reasoning_effort" : "sage_verbosity";
                const saved = localStorage.getItem(storageKey) || "medium";
                pills.forEach(p => {
                  p.classList.toggle("active", p.dataset.value === saved);
                });
              }
            });

            // Update global values for Scientist override
            if (isScientist) {
              window.currentReasoning = "high";
              window.currentVerbosity = "high";
            } else {
              window.currentReasoning = localStorage.getItem("sage_reasoning_effort") || "medium";
              window.currentVerbosity = localStorage.getItem("sage_verbosity") || "medium";
            }
          };

          // Apply lock on initial load
          const initPersonaPills = localStorage.getItem("sage_persona") || window.currentPersona || "intermediate";
          window.lockPillsForPersona(initPersonaPills);
        })();

        // 1. New Chat (in popover)
        const popoverNewChat = document.getElementById("popover-new-chat");
        if (popoverNewChat) {
          popoverNewChat.addEventListener("click", () => {
            if (confirm("Start a new chat?")) location.reload();
          });
        }

        // 2. Enhance Mode (in popover)
        const popoverEnhance = document.getElementById("popover-enhance");
        if (popoverEnhance) {
          popoverEnhance.addEventListener("click", function () {
            this.classList.toggle("active");
            console.log("Enhance mode toggled");
          });
        }

        // 3. Theme Toggle (in popover) - Sync with existing system
        const popoverTheme = document.getElementById("popover-theme");
        const existingThemeToggle = document.getElementById("theme-toggle");

        if (popoverTheme) {
          function updateThemeState() {
            const isDark = document.documentElement.classList.contains("dark");
            const icon = popoverTheme.querySelector("i");
            const label = popoverTheme.querySelector("span");

            // Update icon
            if (icon)
              icon.className = isDark ? "fa-solid fa-sun" : "fa-solid fa-moon";

            // Update label to indicate current state
            if (label) label.textContent = isDark ? "Light Mode" : "Dark Mode";

            // Toggle active class to show current state
            if (isDark) {
              popoverTheme.classList.add("active");
            } else {
              popoverTheme.classList.remove("active");
            }
          }
          updateThemeState();
          if (window.MutationObserver) {
            new MutationObserver(updateThemeState).observe(
              document.documentElement,
              {
                attributes: true,
                attributeFilter: ["class"],
              },
            );
          }
          popoverTheme.addEventListener("click", () => {
            if (existingThemeToggle) existingThemeToggle.click();
          });
        }

        // 4. Feedback
        const popoverFeedback = document.getElementById("popover-feedback");
        if (popoverFeedback) {
          popoverFeedback.addEventListener("click", () => {
            window.open(
              "https://forms.office.com/Pages/ResponsePage.aspx?id=CbzAqUaLBkKTUSuhL7SlwJDwyoPMC9FJltCr9rum9CVUNlo0SzNEM0JQUVkwSktKTE9DRlBaMkg2UiQlQCN0PWcu",
              "_blank",
            );
          });
        }

        // 5. Success Story
        const popoverSuccessStories = document.getElementById(
          "popover-success-stories",
        );
        if (popoverSuccessStories) {
          popoverSuccessStories.addEventListener("click", () => {
            window.open(
              "https://forms.office.com/Pages/ResponsePage.aspx?id=CbzAqUaLBkKTUSuhL7SlwFEYE2dVNpxDrsZcjHt5-QJUOTJHRkdTN0pRMzBGUEVaQVk1MDBWWUpFQSQlQCN0PWcu",
              "_blank",
            );
          });
        }

        // ===== OTHER UI INTERACTIONS =====

        // Persona selector init/sync is handled centrally by updateModeUI()/syncMode().
        // Do NOT re-initialize from localStorage here, because it can overwrite
        // a server-selected persona when localStorage is empty.

        // Helper function to get display name for persona
        function getPersonaDisplayName(persona) {
          const names = {
            explorer: "Explorer 🔍",
            intermediate: "Balanced ⚖️",
            scientist: "Scientist 🔬",
          };
          return names[persona] || persona;
        }

        // Show a brief toast notification for persona changes
        function showPersonaToast(message, type) {
          // Remove existing persona toast if any
          const existing = document.getElementById("persona-toast");
          if (existing) existing.remove();

          const toast = document.createElement("div");
          toast.id = "persona-toast";
          toast.style.cssText = `
          position: fixed;
          bottom: 80px;
          left: 50%;
          transform: translateX(-50%);
          padding: 8px 16px;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 500;
          z-index: 9999;
          transition: opacity 0.3s ease;
          box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        `;

          if (type === "success") {
            toast.style.backgroundColor = "#10B981";
            toast.style.color = "white";
          } else if (type === "error") {
            toast.style.backgroundColor = "#EF4444";
            toast.style.color = "white";
          } else {
            toast.style.backgroundColor = "#3B82F6";
            toast.style.color = "white";
          }

          toast.textContent = message;
          document.body.appendChild(toast);

          // Fade out and remove after 2 seconds
          setTimeout(() => {
            toast.style.opacity = "0";
            setTimeout(() => toast.remove(), 300);
          }, 2000);
        }

        // Search Input - Enter to submit + Type-to-Send icon toggle
        if (newSearchInput) {
          const newVoiceBtn = document.getElementById("new-voice-btn");
          console.log("[DEBUG] newSearchInput found:", newSearchInput);
          console.log("[DEBUG] newVoiceBtn found:", newVoiceBtn);

          newSearchInput.addEventListener("input", function () {
            console.log("[DEBUG] Input event fired, value:", this.value);
            if (!newVoiceBtn) return;
            // If actively recording, don't change icon
            if (window.isRecording) {
              console.log("[DEBUG] Recording active, skipping icon change");
              return;
            }

            if (this.value.trim().length > 0) {
              console.log("[DEBUG] Setting icon to paper-plane");
              newVoiceBtn.innerHTML = '<i class="ph-bold ph-arrow-up"></i>';
              newVoiceBtn.title = "Send message";
            } else {
              console.log("[DEBUG] Setting icon to microphone");
              newVoiceBtn.innerHTML = '<i class="ph-bold ph-microphone"></i>';
              newVoiceBtn.title = "Voice Input";
            }
          });

          newSearchInput.addEventListener("keypress", function (e) {
            if (e.key === "Enter" && !e.shiftKey) {
              e.preventDefault();
              const query = this.value.trim();
              if (query) {
                if (typeof submitStreamingQuery === "function")
                  submitStreamingQuery(query);
                else if (typeof submitQuery === "function") submitQuery(query);
                this.value = "";
                // Force icon reset
                newSearchInput.dispatchEvent(new Event("input"));
              }
            }
          });
        }

        // Voice Button - Dynamic behavior (Voice or Send)
        const newVoiceBtn = document.getElementById("new-voice-btn");
        if (newVoiceBtn) {
          newVoiceBtn.addEventListener("click", () => {
            const query = newSearchInput ? newSearchInput.value.trim() : "";

            if (query.length > 0) {
              // Act as SEND button
              if (typeof submitStreamingQuery === "function")
                submitStreamingQuery(query);
              else if (typeof submitQuery === "function") submitQuery(query);
              if (newSearchInput) {
                newSearchInput.value = "";
                newSearchInput.dispatchEvent(new Event("input"));
              }
            } else {
              // Act as VOICE button
              if (
                typeof startRecording === "function" &&
                typeof stopRecording === "function"
              ) {
                if (!window.isRecording) {
                  startRecording();
                } else {
                  stopRecording();
                }
              } else {
                // Fallback to simple SpeechRecognition if recording functions fail to load
                const SR =
                  window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SR) {
                  const recognition = new SR();
                  recognition.lang = "en-US";
                  recognition.onstart = () =>
                    newVoiceBtn.classList.add("active");
                  recognition.onresult = (e) => {
                    if (newSearchInput) {
                      newSearchInput.value = e.results[0][0].transcript;
                      newSearchInput.dispatchEvent(new Event("input"));
                    }
                  };
                  recognition.onend = () =>
                    newVoiceBtn.classList.remove("active");
                  recognition.start();
                }
              }
            }
          });
        }

        // Hide old chat input
        const oldInput = document.querySelector(".chat-input");
        if (oldInput) oldInput.style.display = "none";
      });
    </script>

    <!-- Disclaimer Banner (Cookie-style) -->
    <div id="disclaimer-banner" class="disclaimer-banner hidden">
      <div class="disclaimer-banner-content">
        <i class="ph-bold ph-info disclaimer-icon"></i>
        <div class="disclaimer-text">
          <strong>Important Notice:</strong> Complete SuccessFactors Training ID
          IT12891 before use | Do Not Use for IVD Products
        </div>
      </div>
      <button id="disclaimer-dismiss-btn" class="disclaimer-banner-btn">
        I Understand
      </button>
    </div>

    <script>
      // Disclaimer Banner Logic
      (function () {
        const banner = document.getElementById("disclaimer-banner");
        const dismissBtn = document.getElementById("disclaimer-dismiss-btn");
        const STORAGE_KEY = "sage_disclaimer_dismissed";

        // Check if disclaimer was already dismissed in this session
        function checkDisclaimerStatus() {
          const dismissed = sessionStorage.getItem(STORAGE_KEY);
          if (!dismissed) {
            // Show banner after short delay for better UX
            setTimeout(() => {
              banner.classList.remove("hidden");
            }, 500);
          }
        }

        // Handle dismiss button click
        if (dismissBtn) {
          dismissBtn.addEventListener("click", function () {
            banner.classList.add("hidden");
            sessionStorage.setItem(STORAGE_KEY, "true");
          });
        }

        // Initialize on page load
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", checkDisclaimerStatus);
        } else {
          checkDisclaimerStatus();
        }
      })();
    </script>
  </body>
</html>
